<!-- Overlay que cobre toda a tela -->
<div class="cart-overlay" (click)="closeCart.emit()"></div>

<!-- Container do carrinho -->
<div class="cart-container">
  <button class="close-button" (click)="closeCart.emit()">√ó</button>
  <h2 class="cart-title">üõí Seu Carrinho</h2>

  <!-- Abas de navega√ß√£o -->
  <div class="cart-tabs">
    <button class="tab-button" [class.active]="activeTab === 'new'" (click)="activeTab = 'new'">
      Novo
      @if (carrinho.length > 0) {
        <span class="badge">{{ carrinho.length }}</span>
      }
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'history'"
      (click)="activeTab = 'history'"
    >
      Hist√≥rico
      @if (placedOrders.length > 0) {
        <span class="badge">{{ placedOrders.length }}</span>
      }
    </button>
  </div>

  <!-- Conte√∫do das Abas -->
  <div class="tab-content">
    <!-- Aba: Novo Pedido -->
    @if (activeTab === 'new') {
      <div class="cart-scrollable-area">
        <div class="cart-items-container">
          @if (carrinho.length === 0) {
            <div class="empty-cart">
              <div class="empty-icon">üõí</div>
              <p>Seu carrinho est√° vazio</p>
              <small>Adicione itens do card√°pio para come√ßar</small>
            </div>
          } @else {
            @for (item of carrinho; track item.productName) {
              <div class="cart-item">
                <div class="item-header">
                  <div class="item-main-info">
                    <span class="product-image">
                      <img [src]="item.image" alt="{{ item.productName }}" />
                    </span>
                    <div class="product-details">
                      <span class="product-name">{{ item.productName }}</span>
                      @if (shouldShowSize(item)) {
                        <span class="product-size"
                          >{{ item.selectedSize!.abbreviation }} -
                          {{ item.selectedSize!.name }}</span
                        >
                      }
                      @if (item.selectedVariation) {
                        <span class="product-variation"> {{ item.selectedVariation.title }}</span>
                      }
                      @if (item.observations) {
                        <span class="product-observations">üìù {{ item.observations }}</span>
                      }
                    </div>
                  </div>
                  <div class="item-actions-row">
                    <button class="edit-item-btn" (click)="openEditModal(item)" title="Editar item">
                      ‚úèÔ∏è
                    </button>
                  </div>
                </div>

                <div class="item-controls">
                  <div class="quantity-adjuster">
                    <button
                      class="quantity-button decrease"
                      (click)="decreaseQuantity(item)"
                      [title]="item.quantity === 1 ? 'Remover item' : 'Diminuir quantidade'"
                    >
                      @if (item.quantity === 1) {
                        <span class="trash-icon">üóëÔ∏è</span>
                      } @else {
                        <span>-</span>
                      }
                    </button>

                    <span class="quantity">{{ item.quantity }}</span>

                    <button
                      class="quantity-button increase"
                      (click)="increaseQuantity(item)"
                      title="Aumentar quantidade"
                    >
                      <span>+</span>
                    </button>
                  </div>

                  <div class="item-price-section">
                    @if (item.hasDiscount && getItemDiscountPercent(item) > 0) {
                      <div class="price-breakdown">
                        <div class="base-price-info">
                          <span class="label">Base:</span>
                          <span class="original-price-cart">{{
                            getItemBasePriceOriginal(item) * item.quantity | currency: 'BRL'
                          }}</span>
                          <span class="discount-badge-cart"
                            >-{{ getItemDiscountPercent(item) }}%</span
                          >
                          <span class="discounted-price">{{
                            getItemBasePriceWithDiscount(item) * item.quantity | currency: 'BRL'
                          }}</span>
                        </div>
                        @if (getItemVariationPrice(item) > 0) {
                          <div class="variation-price-info">
                            <span class="label">Varia√ß√£o:</span>
                            <span class="variation-price"
                              >+{{
                                getItemVariationPrice(item) * item.quantity | currency: 'BRL'
                              }}</span
                            >
                          </div>
                        }
                      </div>
                      <span class="item-total discounted-total">{{
                        item.price * item.quantity | currency: 'BRL'
                      }}</span>
                    } @else {
                      <span class="item-total">{{
                        item.price * item.quantity | currency: 'BRL'
                      }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          }
        </div>
      </div>

      <!-- Rodap√© com total e bot√£o (s√≥ na aba "Novo Pedido") -->
      <div class="cart-footer">
        @if (orderSuccess) {
          <div class="success-message">‚úÖ Pedido enviado com sucesso!</div>
        }

        @if (orderError) {
          <div class="error-message">‚ùå {{ orderError }}</div>
        }

        <div class="total-container">
          <span>Total:</span>
          <span class="total-price">{{ total | currency: 'BRL' }}</span>
        </div>

        @if (!isTableLinked) {
          <div class="table-link-message">
            {{ tableLinkMessage }}
          </div>
        }

        <button
          class="checkout-button"
          (click)="finalizarPedido()"
          [disabled]="isPlacingOrder || carrinho.length === 0 || !isTableLinked"
        >
          @if (isPlacingOrder) {
            <span>‚è≥ Enviando...</span>
          } @else {
            <span>üç± Enviar Pedido</span>
          }
        </button>
      </div>
    }

    <!-- Aba: Hist√≥rico de Pedidos -->
    @if (activeTab === 'history') {
      <div class="cart-scrollable-area">
        <div class="order-history-container">
          @if (placedOrders.length === 0) {
            <div class="empty-cart">
              <div class="empty-icon">üìã</div>
              <p>Nenhum pedido feito ainda</p>
              <small>Seus pedidos aparecer√£o aqui ap√≥s serem enviados</small>
            </div>
          } @else {
            <div class="orders-list">
              @for (order of placedOrders; track order.id) {
                <div class="order-card" [attr.data-status]="order.status">
                  <div class="order-header">
                    <div class="order-info">
                      <span class="order-id">Pedido #{{ order.id.slice(-6) }}</span>
                      <span class="order-time">{{ getOrderTime(order) }}</span>
                    </div>
                    <span class="order-status-badge">{{ getStatusLabel(order.status) }}</span>
                  </div>

                  <div class="order-items">
                    @for (item of order.items; track $index) {
                      <div class="order-item">
                        <span class="item-qty">{{ item.quantity }}x</span>
                        <div class="item-details">
                          <span class="item-name">{{ item.productName }}</span>
                          @if (shouldShowSizeInHistory(item)) {
                            <small class="item-size"
                              >{{ item.selectedSize!.abbreviation }} -
                              {{ item.selectedSize!.name }}</small
                            >
                          }
                        </div>
                        <span class="item-price">{{ item.totalPrice | currency: 'BRL' }}</span>
                      </div>
                    }
                  </div>

                  @if (order.notes) {
                    <div class="order-notes">
                      <small>üìù {{ order.notes }}</small>
                    </div>
                  }

                  <div class="order-total">
                    <strong>Total:</strong>
                    <strong class="total-value">{{ order.totalAmount | currency: 'BRL' }}</strong>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Modal de Edi√ß√£o de Item -->
  @if (showEditModal && editingItem) {
    <div class="edit-modal-overlay" (click)="closeEditModal()">
      <div class="edit-modal-content" (click)="$event.stopPropagation()">
        <div class="edit-modal-header">
          <h3>Editar Item</h3>
          <button class="close-modal-btn" (click)="closeEditModal()">√ó</button>
        </div>

        <div class="edit-modal-body">
          <div class="edit-product-info">
            <img [src]="editingItem.image" alt="{{ editingItem.productName }}" />
            <div class="product-name-price">
              <strong>{{ editingItem.productName }}</strong>

              <!-- Exibi√ß√£o de pre√ßo com breakdown de desconto -->
              @if (hasEditingItemDiscount()) {
                <div class="edit-price-breakdown">
                  <div class="price-line">
                    <span class="label">Base:</span>
                    <span class="original-price">{{
                      getEditingItemBasePrice() | currency: 'BRL'
                    }}</span>
                    <span class="discount-badge">-{{ getEditingItemDiscountPercent() }}%</span>
                    <span class="discounted-price">{{
                      getEditingItemBasePriceWithDiscount() | currency: 'BRL'
                    }}</span>
                  </div>
                  @if (getEditingItemVariationPrice() > 0) {
                    <div class="price-line">
                      <span class="label">Varia√ß√£o:</span>
                      <span class="variation-price"
                        >+{{ getEditingItemVariationPrice() | currency: 'BRL' }}</span
                      >
                    </div>
                  }
                  <div class="price-line total">
                    <span class="label">Total:</span>
                    <span class="final-price">{{ editingItem.price | currency: 'BRL' }}</span>
                  </div>
                </div>
              } @else {
                <p class="simple-price">{{ editingItem.price | currency: 'BRL' }}</p>
              }
            </div>
          </div>

          <!-- Sele√ß√£o de Tamanho (se houver mais de 1) -->
          @if (editingItemSizes && editingItemSizes.length > 1) {
            <div class="edit-size-section">
              <label>Tamanho:</label>
              <div class="size-options">
                @for (size of editingItemSizes; track size.abbreviation) {
                  <button
                    type="button"
                    class="size-option-btn"
                    [class.selected]="editingItem.selectedSize?.abbreviation === size.abbreviation"
                    (click)="selectSizeForEdit(size)"
                  >
                    <span class="size-abbr">{{ size.abbreviation }}</span>
                    <span class="size-name">{{ size.name }}</span>
                    @if (getEditSizeDiscountCalculation(size.price).hasDiscount) {
                      <div class="size-price-with-discount">
                        <span class="size-original-price">{{ size.price | currency: 'BRL' }}</span>
                        <span class="size-discount-badge"
                          >-{{ getEditSizeDiscountCalculation(size.price).discountPercent }}%</span
                        >
                        <span class="size-price discounted">{{
                          getEditSizeDiscountCalculation(size.price).finalPrice | currency: 'BRL'
                        }}</span>
                      </div>
                    } @else {
                      <span class="size-price">{{ size.price | currency: 'BRL' }}</span>
                    }
                  </button>
                }
              </div>
            </div>
          }

          <!-- Sele√ß√£o de Varia√ß√£o (se houver) -->
          @if (editingItemVariations && editingItemVariations.length > 0) {
            <div class="edit-size-section">
              <label>Varia√ß√£o:</label>
              <div class="size-options">
                @for (variation of editingItemVariations; track variation.title) {
                  <button
                    type="button"
                    class="size-option-btn"
                    [class.selected]="editingItem.selectedVariation?.title === variation.title"
                    (click)="selectVariationForEdit(variation)"
                  >
                    <span class="size-title">{{ variation.title }}</span>
                    @if (variation.price > 0) {
                      <span class="size-price">+{{ variation.price | currency: 'BRL' }}</span>
                    }
                  </button>
                }
              </div>
            </div>
          }

          <!-- Observa√ß√µes -->
          <div class="edit-observations-section">
            <label>Observa√ß√µes:</label>
            <textarea
              class="observations-textarea"
              [(ngModel)]="editingItem.observations"
              placeholder="Ex: Sem cebola, bem passado..."
              rows="3"
            ></textarea>
          </div>
        </div>

        <div class="edit-modal-footer">
          <button class="cancel-edit-btn" (click)="closeEditModal()">Cancelar</button>
          <button class="save-edit-btn" (click)="saveEditedItem()">Salvar</button>
        </div>
      </div>
    </div>
  }
</div>
