<div class="admin-panel-overlay" (click)="closePanel()">
  <div class="admin-panel-container" (click)="$event.stopPropagation()">
    <div class="panel-header">
      <h2>⚙️ Painel Administrativo</h2>
      <button class="close-btn" (click)="closePanel()">×</button>
    </div>

    <div class="panel-tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'tables'"
        (click)="activeTab = 'tables'"
      >
        🪑 Mesas
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'reservations'"
        (click)="activeTab = 'reservations'"
      >
        📅 Reservas
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'orders'"
        (click)="activeTab = 'orders'"
      >
        📦 Pedidos
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'stats'" (click)="activeTab = 'stats'">
        📊 Estatísticas
      </button>
    </div>

    <div class="panel-content">
      <!-- Tab: Mesas -->
      @if (activeTab === 'tables') {
        <div class="tables-section">
          <div class="section-header">
            <h3>Gerenciamento de Mesas</h3>
            <button class="btn-primary" (click)="showCreateModal = true">➕ Nova Mesa</button>
          </div>

          <div class="tables-grid">
            @for (table of tables; track table.id) {
              <div class="table-card" [style.border-color]="getStatusColor(table.status)">
                <div class="table-header">
                  <div class="table-number">Mesa {{ table.number }}</div>
                  <div class="table-status" [style.background]="getStatusColor(table.status)">
                    {{ getStatusLabel(table.status) }}
                  </div>
                </div>

                <div class="table-info">
                  <div class="info-item">
                    <span class="icon">👥</span>
                    <span>{{ table.capacity }} pessoas</span>
                  </div>
                  @if (table.currentOrders && table.currentOrders.length > 0) {
                    <div class="info-item">
                      <span class="icon">📋</span>
                      <span>{{ table.currentOrders.length }} pedidos</span>
                    </div>
                  }
                  @if (table.totalConsumption && table.totalConsumption > 0) {
                    <div class="info-item">
                      <span class="icon">💰</span>
                      <span>R$ {{ table.totalConsumption.toFixed(2) }}</span>
                    </div>
                  }
                </div>

                <div class="table-actions">
                  @if (table.status === 'available') {
                    <button class="btn-action btn-open" (click)="openTable(table)">🔓 Abrir</button>
                  }
                  @if (table.status === 'occupied') {
                    <button class="btn-action btn-close" (click)="closeTable(table)">
                      🔒 Fechar
                    </button>
                    <button class="btn-action btn-orders" (click)="viewTableOrders(table)">
                      📋 Pedidos
                    </button>
                  }
                  @if (table.status === 'reserved') {
                    <button class="btn-action btn-confirm" (click)="confirmReservation(table)">
                      ✅ Confirmar
                    </button>
                  }
                  @if (table.status === 'closed') {
                    <button class="btn-action btn-clear" (click)="clearTable(table)">
                      🧹 Limpar
                    </button>
                  }
                  <button class="btn-action btn-qr" (click)="showTableQRCode(table)">
                    📱 QR Code
                  </button>
                  <button class="btn-action btn-delete" (click)="deleteTable(table)">🗑️</button>
                </div>
              </div>
            } @empty {
              <div class="empty-state">
                <p>Nenhuma mesa cadastrada</p>
                <button class="btn-primary" (click)="showCreateModal = true">
                  Criar primeira mesa
                </button>
              </div>
            }
          </div>
        </div>
      }

      <!-- Tab: Reservas -->
      @if (activeTab === 'reservations') {
        <div class="reservations-section">
          <div class="section-header">
            <h3>Gerenciamento de Reservas</h3>
            <button class="btn-primary" (click)="showReserveModal = true">➕ Nova Reserva</button>
          </div>

          @if (reservedTables.length > 0) {
            <div class="reservations-list">
              @for (table of reservedTables; track table.id) {
                <div class="reservation-card">
                  <div class="reservation-header">
                    <span class="table-badge">Mesa {{ table.number }}</span>
                    <button
                      class="cancel-btn"
                      (click)="cancelReservation(table)"
                      title="Cancelar reserva"
                    >
                      ❌
                    </button>
                  </div>

                  @if (table.reservationInfo) {
                    <div class="reservation-details">
                      <div class="detail-row-main">
                        <div class="detail-col">
                          <span class="icon">👤</span>
                          <div>
                            <strong>{{ table.reservationInfo.clientName }}</strong>
                            <div class="detail-subtitle">
                              {{ table.reservationInfo.clientPhone }}
                            </div>
                          </div>
                        </div>

                        <div class="detail-col">
                          <span class="icon">📅</span>
                          <div>
                            <strong>{{
                              table.reservationInfo.dateTime | date: 'dd/MM/yyyy HH:mm'
                            }}</strong>
                            <div class="detail-subtitle">Data e horário</div>
                          </div>
                        </div>
                      </div>

                      @if (table.reservationInfo.notes) {
                        <div class="notes">📝 {{ table.reservationInfo.notes }}</div>
                      }
                    </div>

                    <div class="reservation-actions">
                      <button class="btn-action btn-confirm" (click)="confirmReservation(table)">
                        ✅ Confirmar Chegada
                      </button>
                      <button class="btn-action btn-manage" (click)="viewTableDetails(table)">
                        ⚙️ Gerenciar
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">
              <p>📅 Nenhuma reserva ativa</p>
              <button class="btn-primary" (click)="showReserveModal = true">
                Criar primeira reserva
              </button>
            </div>
          }
        </div>
      }

      <!-- Tab: Pedidos -->
      @if (activeTab === 'orders') {
        <div class="orders-section">
          <h3>Todos os Pedidos</h3>
          <app-admin-orders></app-admin-orders>
        </div>
      }

      <!-- Tab: Estatísticas -->
      @if (activeTab === 'stats') {
        <div class="stats-section">
          <h3>Estatísticas</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">{{ tables.length }}</div>
              <div class="stat-label">Total de Mesas</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">
                {{ occupiedTablesCount }}
              </div>
              <div class="stat-label">Mesas Ocupadas</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">
                {{ availableTablesCount }}
              </div>
              <div class="stat-label">Mesas Disponíveis</div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modal: Criar Mesa -->
@if (showCreateModal) {
  <div class="modal-overlay" (click)="showCreateModal = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Nova Mesa</h3>
      <form (ngSubmit)="createTable()">
        <div class="form-group">
          <label>Número da Mesa:</label>
          <input type="number" [(ngModel)]="newTable.number" name="number" min="1" required />
        </div>
        <div class="form-group">
          <label>Capacidade (pessoas):</label>
          <input
            type="number"
            [(ngModel)]="newTable.capacity"
            name="capacity"
            min="1"
            max="20"
            required
          />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showCreateModal = false">
            Cancelar
          </button>
          <button type="submit" class="btn-primary">Criar Mesa</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Modal: QR Code -->
@if (showQRCode && selectedTable) {
  <div class="modal-overlay" (click)="showQRCode = false">
    <div class="modal-content qr-modal" (click)="$event.stopPropagation()">
      <h3>QR Code - Mesa {{ selectedTable.number }}</h3>
      @if (qrCodeImage) {
        <div class="qr-container">
          <img [src]="qrCodeImage" alt="QR Code da mesa" />
        </div>
        <p class="qr-info">Clientes podem escanear este QR Code para acessar a mesa</p>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="downloadQRCode()">💾 Baixar</button>
          <button class="btn-primary" (click)="printQRCode()">🖨️ Imprimir</button>
        </div>
      } @else {
        <p>Gerando QR Code...</p>
      }
    </div>
  </div>
}

<!-- Modal: Reservar Mesa -->
@if (showReserveModal) {
  <div class="modal-overlay" (click)="showReserveModal = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>📅 Nova Reserva</h3>
      <form (ngSubmit)="reserveTable()">
        <div class="form-group">
          <label>Mesa:</label>
          <select [(ngModel)]="reservation.tableId" name="tableId" required>
            <option value="">Selecione uma mesa</option>
            @for (table of availableTables; track table.id) {
              <option [value]="table.id">
                Mesa {{ table.number }} ({{ table.capacity }} pessoas)
              </option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Nome do Cliente:</label>
          <input
            type="text"
            [(ngModel)]="reservation.clientName"
            name="clientName"
            placeholder="Nome completo"
            required
          />
        </div>

        <div class="form-group">
          <label>Telefone:</label>
          <input
            type="tel"
            [(ngModel)]="reservation.clientPhone"
            name="clientPhone"
            placeholder="(00) 00000-0000"
            required
          />
        </div>

        <div class="form-group">
          <label>Data e Hora:</label>
          <input
            type="datetime-local"
            [(ngModel)]="reservation.dateTime"
            name="dateTime"
            required
          />
        </div>

        <div class="form-group">
          <label>Observações (opcional):</label>
          <textarea
            [(ngModel)]="reservation.notes"
            name="notes"
            rows="3"
            placeholder="Alguma observação sobre a reserva?"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showReserveModal = false">
            Cancelar
          </button>
          <button type="submit" class="btn-primary">Confirmar Reserva</button>
        </div>
      </form>
    </div>
  </div>
}
