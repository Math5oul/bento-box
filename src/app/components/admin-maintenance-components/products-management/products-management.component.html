<div class="products-management-container">
  <!-- Header com logo e bot√£o voltar -->
  <div class="header">
    <h1>
      <img src="/imgs/bento-logo-mini.png" alt="Bento Box" class="logo" />
      Gerenciamento de Produtos
    </h1>
    <p class="subtitle">Gerencie os Produtos do sistema</p>
    <a routerLink="/maintenance/test-hub" class="back-button">‚Üê Voltar para Hub</a>
  </div>

  <!-- Estat√≠sticas -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-info">
        <div class="stat-value">{{ totalProducts }}</div>
        <div class="stat-label">Total de Produtos</div>
      </div>
    </div>

    <div class="stat-card available">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <div class="stat-value">{{ availableProducts }}</div>
        <div class="stat-label">Dispon√≠veis</div>
      </div>
    </div>

    <div class="stat-card unavailable">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-info">
        <div class="stat-value">{{ unavailableProducts }}</div>
        <div class="stat-label">Indispon√≠veis</div>
      </div>
    </div>
  </div>

  <!-- Bot√£o de criar produto -->
  <div class="actions-container">
    <button class="create-button" (click)="openCreateModal()">‚ûï Criar Novo Produto</button>
  </div>

  <!-- Barra de Pesquisa -->
  <div class="search-section">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="üîç Pesquisar produtos por nome, descri√ß√£o ou categoria..."
        class="search-input"
      />
      @if (searchTerm) {
        <button class="clear-search" (click)="searchTerm = ''">&times;</button>
      }
    </div>
    <p class="search-results">
      Exibindo {{ filteredProducts.length }} de {{ products.length }} produtos
    </p>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Carregando produtos...</p>
    </div>
  }

  <!-- Grid de produtos -->
  @if (!loading) {
    <div class="products-grid">
      @if (filteredProducts.length === 0 && products.length > 0) {
        <div class="empty-state">
          <p>Nenhum produto encontrado com "{{ searchTerm }}"</p>
        </div>
      }

      @for (product of filteredProducts; track product._id) {
        <div class="product-card" [class.unavailable]="!product.available">
          <!-- Badge de disponibilidade -->
          <div
            class="availability-badge"
            [class.available]="product.available"
            (click)="toggleAvailability(product)"
            title="Clique para alterar disponibilidade"
          >
            {{ product.available ? '‚úÖ Dispon√≠vel' : '‚ùå Indispon√≠vel' }}
          </div>

          <!-- Informa√ß√µes do produto -->
          <div class="product-info">
            <h3>{{ product.name }}</h3>
            <p class="description">{{ truncateText(product.description, 80) }}</p>

            <div class="product-meta">
              <span class="category">
                {{ getCategoryEmoji(product.category) }} {{ product.category }}
              </span>
              <span class="price">{{ formatPrice(product.price) }}</span>
            </div>

            <div class="product-details">
              @if (product.format) {
                <span class="detail-tag">üìê {{ product.format }}</span>
              }
              @if (product.colorMode) {
                <span class="detail-tag">
                  {{ product.colorMode === 'light' ? '‚òÄÔ∏è' : 'üåô' }} {{ product.colorMode }}
                </span>
              }
              <span class="detail-tag">üñºÔ∏è {{ product.images.length || 0 }} imagens</span>
            </div>
          </div>

          <!-- Miniatura das imagens -->
          @if (product.images && product.images.length > 0) {
            <div class="product-images">
              @for (img of product.images.slice(0, 3); track $index) {
                <img [src]="img" [alt]="product.name" class="thumbnail" />
              }
              @if (product.images.length > 3) {
                <span class="more-images"> +{{ product.images.length - 3 }} </span>
              }
            </div>
          }

          <!-- A√ß√µes -->
          <div class="product-actions">
            <button class="edit-btn" (click)="openEditModal(product)">‚úèÔ∏è Editar</button>
            <button class="delete-btn" (click)="deleteProduct(product._id)">üóëÔ∏è Deletar</button>
          </div>
        </div>
      }

      <!-- Mensagem quando n√£o h√° produtos -->
      @if (products.length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <h3>Nenhum produto cadastrado</h3>
          <p>Clique em "Criar Novo Produto" para adicionar o primeiro produto</p>
        </div>
      }
    </div>
  }

  <!-- Modal de Cria√ß√£o -->
  @if (showCreateModal) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚ûï Criar Novo Produto</h2>
          <button class="close-btn" (click)="closeCreateModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <!-- Nome -->
          <div class="form-group">
            <label>Nome do Produto *</label>
            <input
              type="text"
              [(ngModel)]="newProduct.name"
              placeholder="Ex: Bento Box Premium"
              maxlength="100"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label>Descri√ß√£o *</label>
            <textarea
              [(ngModel)]="newProduct.description"
              placeholder="Descreva o produto..."
              rows="3"
              maxlength="500"
            ></textarea>
          </div>

          <!-- Pre√ßo -->
          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input
              type="number"
              [(ngModel)]="newProduct.price"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Tamanhos Dispon√≠veis -->
          <div class="form-group sizes-section">
            <label>Tamanhos Dispon√≠veis (Opcional)</label>
            <div class="sizes-info">
              <p class="hint">Adicione tamanhos com pre√ßos espec√≠ficos (ex: P, M, G)</p>
            </div>

            <!-- Formul√°rio para adicionar/editar tamanho -->
            <div class="size-form">
              <div class="size-inputs">
                <input
                  type="text"
                  [(ngModel)]="newSize.name"
                  placeholder="Nome (ex: Pequeno)"
                  maxlength="50"
                  class="size-name-input"
                />
                <input
                  type="text"
                  [(ngModel)]="newSize.abbreviation"
                  placeholder="Abrev. (ex: P)"
                  maxlength="5"
                  class="size-abbr-input"
                />
                <input
                  type="number"
                  [(ngModel)]="newSize.price"
                  placeholder="Pre√ßo (R$)"
                  min="0"
                  step="0.01"
                  class="size-price-input"
                />
              </div>
              <div class="size-actions">
                <button type="button" class="add-size-btn" (click)="addSizeToNew()">
                  @if (editingSizeIndex !== null) {
                    <span>‚úÖ Salvar</span>
                  } @else {
                    <span>‚ûï Adicionar</span>
                  }
                </button>
                @if (editingSizeIndex !== null) {
                  <button type="button" class="cancel-size-btn" (click)="cancelSizeEdit()">
                    Cancelar
                  </button>
                }
              </div>
            </div>

            <!-- Lista de tamanhos adicionados -->
            @if (newProduct.sizes && newProduct.sizes.length > 0) {
              <div class="sizes-list">
                @for (size of newProduct.sizes; let i = $index; track i) {
                  <div class="size-item">
                    <div class="size-info">
                      <span class="size-abbr">{{ size.abbreviation }}</span>
                      <span class="size-name">{{ size.name }}</span>
                      <span class="size-price">{{ formatPrice(size.price) }}</span>
                    </div>
                    <div class="size-item-actions">
                      <button type="button" class="edit-size-btn" (click)="editSizeInNew(i)">
                        ‚úèÔ∏è
                      </button>
                      <button type="button" class="remove-size-btn" (click)="removeSizeFromNew(i)">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Categoria -->
          <div class="form-group">
            <label>Categoria *</label>
            <select [(ngModel)]="newProduct.category">
              @for (cat of categories; track cat._id) {
                <option [value]="cat.slug">{{ cat.emoji }} {{ cat.name }}</option>
              }
            </select>
          </div>

          <!-- Formato -->
          <div class="form-group">
            <label>Formato</label>
            <div class="format-options">
              @for (format of availableFormats; track format) {
                <button
                  type="button"
                  class="format-btn"
                  [class.active]="newProduct.format === format"
                  (click)="newProduct.format = format"
                >
                  {{ format }}
                </button>
              }
            </div>
          </div>

          <!-- Modo de Cor -->
          <div class="form-group">
            <label>Modo de Cor</label>
            <div class="color-mode-options">
              @for (mode of colorModes; track mode.value) {
                <button
                  type="button"
                  class="color-mode-btn"
                  [class.active]="newProduct.colorMode === mode.value"
                  (click)="newProduct.colorMode = mode.value"
                >
                  {{ mode.label }}
                </button>
              }
            </div>
          </div>

          <!-- Imagens -->
          <div class="form-group">
            <label>Imagens (m√°x. 5)</label>
            <div class="upload-area">
              <input
                type="file"
                accept="image/*"
                multiple
                (change)="onNewFilesSelected($event)"
                id="newProductImages"
                class="file-input"
              />
              <label for="newProductImages" class="file-label"> üìÅ Selecionar Imagens </label>
              <p class="upload-hint">JPEG, PNG, GIF, WebP ou AVIF (m√°x. 10MB cada)</p>
            </div>

            @if (newProduct.images && newProduct.images.length > 0) {
              <div class="images-preview">
                @for (img of newProduct.images; let i = $index; track i) {
                  <div class="image-preview-item">
                    <img [src]="img" alt="Preview" />
                    <button type="button" class="remove-image-btn" (click)="removeImageFromNew(i)">
                      ‚úñ
                    </button>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Disponibilidade -->
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="newProduct.available" />
              <span>Produto dispon√≠vel para venda</span>
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeCreateModal()" [disabled]="uploadingImages">
            Cancelar
          </button>
          <button class="save-btn" (click)="createProduct()" [disabled]="uploadingImages">
            @if (!uploadingImages) {
              <span>‚úÖ Criar Produto</span>
            } @else {
              <span>‚è≥ Enviando...</span>
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Edi√ß√£o -->
  @if (showEditModal) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚úèÔ∏è Editar Produto</h2>
          <button class="close-btn" (click)="closeEditModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <!-- Nome -->
          <div class="form-group">
            <label>Nome do Produto *</label>
            <input
              type="text"
              [(ngModel)]="editingProduct.name"
              placeholder="Ex: Bento Box Premium"
              maxlength="100"
            />
          </div>

          <!-- Descri√ß√£o -->
          <div class="form-group">
            <label>Descri√ß√£o *</label>
            <textarea
              [(ngModel)]="editingProduct.description"
              placeholder="Descreva o produto..."
              rows="3"
              maxlength="500"
            ></textarea>
          </div>

          <!-- Pre√ßo -->
          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input
              type="number"
              [(ngModel)]="editingProduct.price"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
          </div>

          <!-- Tamanhos Dispon√≠veis -->
          <div class="form-group sizes-section">
            <label>Tamanhos Dispon√≠veis (Opcional)</label>
            <div class="sizes-info">
              <p class="hint">Adicione tamanhos com pre√ßos espec√≠ficos (ex: P, M, G)</p>
            </div>

            <!-- Formul√°rio para adicionar/editar tamanho -->
            <div class="size-form">
              <div class="size-inputs">
                <input
                  type="text"
                  [(ngModel)]="newSize.name"
                  placeholder="Nome (ex: Pequeno)"
                  maxlength="50"
                  class="size-name-input"
                />
                <input
                  type="text"
                  [(ngModel)]="newSize.abbreviation"
                  placeholder="Abrev. (ex: P)"
                  maxlength="5"
                  class="size-abbr-input"
                />
                <input
                  type="number"
                  [(ngModel)]="newSize.price"
                  placeholder="Pre√ßo (R$)"
                  min="0"
                  step="0.01"
                  class="size-price-input"
                />
              </div>
              <div class="size-actions">
                <button type="button" class="add-size-btn" (click)="addSizeToEdit()">
                  @if (editingSizeIndex !== null) {
                    <span>‚úÖ Salvar</span>
                  } @else {
                    <span>‚ûï Adicionar</span>
                  }
                </button>
                @if (editingSizeIndex !== null) {
                  <button type="button" class="cancel-size-btn" (click)="cancelSizeEdit()">
                    Cancelar
                  </button>
                }
              </div>
            </div>

            <!-- Lista de tamanhos adicionados -->
            @if (editingProduct.sizes && editingProduct.sizes.length > 0) {
              <div class="sizes-list">
                @for (size of editingProduct.sizes; let i = $index; track i) {
                  <div class="size-item">
                    <div class="size-info">
                      <span class="size-abbr">{{ size.abbreviation }}</span>
                      <span class="size-name">{{ size.name }}</span>
                      <span class="size-price">{{ formatPrice(size.price) }}</span>
                    </div>
                    <div class="size-item-actions">
                      <button type="button" class="edit-size-btn" (click)="editSizeInEdit(i)">
                        ‚úèÔ∏è
                      </button>
                      <button type="button" class="remove-size-btn" (click)="removeSizeFromEdit(i)">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Categoria -->
          <div class="form-group">
            <label>Categoria *</label>
            <select [(ngModel)]="editingProduct.category">
              @for (cat of categories; track cat._id) {
                <option [value]="cat.slug">{{ cat.emoji }} {{ cat.name }}</option>
              }
            </select>
          </div>

          <!-- Formato -->
          <div class="form-group">
            <label>Formato</label>
            <div class="format-options">
              @for (format of availableFormats; track format) {
                <button
                  type="button"
                  class="format-btn"
                  [class.active]="editingProduct.format === format"
                  (click)="editingProduct.format = format"
                >
                  {{ format }}
                </button>
              }
            </div>
          </div>

          <!-- Modo de Cor -->
          <div class="form-group">
            <label>Modo de Cor</label>
            <div class="color-mode-options">
              @for (mode of colorModes; track mode.value) {
                <button
                  type="button"
                  class="color-mode-btn"
                  [class.active]="editingProduct.colorMode === mode.value"
                  (click)="editingProduct.colorMode = mode.value"
                >
                  {{ mode.label }}
                </button>
              }
            </div>
          </div>

          <!-- Imagens -->
          <div class="form-group">
            <label>Imagens (m√°x. 5)</label>
            <div class="upload-area">
              <input
                type="file"
                accept="image/*"
                multiple
                (change)="onEditFilesSelected($event)"
                id="editProductImages"
                class="file-input"
              />
              <label for="editProductImages" class="file-label"> üìÅ Adicionar Imagens </label>
              <p class="upload-hint">JPEG, PNG, GIF, WebP ou AVIF (m√°x. 10MB cada)</p>
            </div>

            @if (editingProduct.images && editingProduct.images.length > 0) {
              <div class="images-preview">
                @for (img of editingProduct.images; let i = $index; track i) {
                  <div class="image-preview-item">
                    <img [src]="img" alt="Preview" />
                    <button type="button" class="remove-image-btn" (click)="removeImageFromEdit(i)">
                      ‚úñ
                    </button>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Disponibilidade -->
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="editingProduct.available" />
              <span>Produto dispon√≠vel para venda</span>
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeEditModal()" [disabled]="uploadingImages">
            Cancelar
          </button>
          <button class="save-btn" (click)="updateProduct()" [disabled]="uploadingImages">
            @if (!uploadingImages) {
              <span>‚úÖ Salvar Altera√ß√µes</span>
            } @else {
              <span>‚è≥ Enviando...</span>
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
