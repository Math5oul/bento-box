<div class="reports-container">
  <!-- Header -->
  <div class="reports-header">
    <h1>üìä Relat√≥rios e An√°lises</h1>
    <p class="subtitle">An√°lise de vendas e gest√£o de categorias fiscais</p>
  </div>

  <!-- Mensagens de erro e sucesso -->
  <div class="messages" *ngIf="error || success">
    <div class="alert alert-error" *ngIf="error">
      <span class="icon">‚ö†Ô∏è</span>
      <span>{{ error }}</span>
      <button class="close-btn" (click)="clearMessages()">√ó</button>
    </div>
    <div class="alert alert-success" *ngIf="success">
      <span class="icon">‚úì</span>
      <span>{{ success }}</span>
      <button class="close-btn" (click)="clearMessages()">√ó</button>
    </div>
  </div>

  <!-- Tabs de navega√ß√£o -->
  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'sales'" (click)="setActiveTab('sales')">
      üìà Relat√≥rios de Vendas
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'categories'"
      (click)="setActiveTab('categories')"
    >
      üè∑Ô∏è Categorias Fiscais
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'analysis'"
      (click)="setActiveTab('analysis')"
    >
      üìä An√°lise por Categoria
    </button>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>

  <!-- Conte√∫do das abas -->
  <div class="tab-content">
    <!-- ABA: Relat√≥rios de Vendas -->
    <div class="tab-panel" *ngIf="activeTab === 'sales'">
      <div class="report-section">
        <!-- Filtros -->
        <div class="filters-card">
          <h2>Filtros de Per√≠odo</h2>
          <form [formGroup]="reportForm" (ngSubmit)="generateReport()">
            <div class="form-grid">
              <div class="form-group">
                <label for="startDate">Data Inicial</label>
                <input
                  type="date"
                  id="startDate"
                  formControlName="startDate"
                  class="form-control"
                />
              </div>

              <div class="form-group">
                <label for="endDate">Data Final</label>
                <input type="date" id="endDate" formControlName="endDate" class="form-control" />
              </div>

              <div class="form-group full-width">
                <label>M√©todos de Pagamento</label>
                <div class="checkbox-group">
                  <label *ngFor="let method of availablePaymentMethods" class="checkbox-label">
                    <input
                      type="checkbox"
                      [value]="method.value"
                      [checked]="reportForm.value.paymentMethods?.includes(method.value)"
                      (change)="
                        $event.target.checked
                          ? reportForm.value.paymentMethods.push(method.value)
                          : reportForm.value.paymentMethods.splice(
                              reportForm.value.paymentMethods.indexOf(method.value),
                              1
                            )
                      "
                    />
                    {{ method.label }}
                  </label>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="reportForm.invalid || isLoadingReport"
              >
                <span *ngIf="!isLoadingReport">üîç Gerar Relat√≥rio</span>
                <span *ngIf="isLoadingReport">‚è≥ Gerando...</span>
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="exportReport()"
                [disabled]="!salesReport"
              >
                üì• Exportar CSV
              </button>
            </div>
          </form>
        </div>

        <!-- Resultados do Relat√≥rio -->
        <div class="report-results" *ngIf="salesReport">
          <!-- Cards de Resumo -->
          <div class="summary-cards">
            <div class="summary-card">
              <div class="card-icon">üõí</div>
              <div class="card-content">
                <h3>Total de Vendas</h3>
                <p class="value">{{ salesReport.totalSales }}</p>
              </div>
            </div>

            <div class="summary-card">
              <div class="card-icon">üí∞</div>
              <div class="card-content">
                <h3>Receita Total</h3>
                <p class="value">{{ formatCurrency(salesReport.totalRevenue) }}</p>
              </div>
            </div>

            <div class="summary-card">
              <div class="card-icon">üìÖ</div>
              <div class="card-content">
                <h3>Per√≠odo</h3>
                <p class="value-small">
                  {{ formatDate(salesReport.startDate) }} - {{ formatDate(salesReport.endDate) }}
                </p>
              </div>
            </div>

            <div class="summary-card">
              <div class="card-icon">üìä</div>
              <div class="card-content">
                <h3>Ticket M√©dio</h3>
                <p class="value">
                  {{ formatCurrency(salesReport.totalRevenue / salesReport.totalSales) }}
                </p>
              </div>
            </div>
          </div>

          <!-- Vendas por M√©todo de Pagamento -->
          <div class="data-section" *ngIf="salesReport.salesByPaymentMethod.length > 0">
            <h3>üí≥ Vendas por M√©todo de Pagamento</h3>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>M√©todo</th>
                    <th class="text-right">Quantidade</th>
                    <th class="text-right">Receita</th>
                    <th class="text-right">Percentual</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let method of salesReport.salesByPaymentMethod">
                    <td>{{ getPaymentMethodLabel(method.method) }}</td>
                    <td class="text-right">{{ method.count }}</td>
                    <td class="text-right">{{ formatCurrency(method.revenue) }}</td>
                    <td class="text-right">
                      <span class="percentage-badge">{{ method.percentage.toFixed(1) }}%</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Vendas por Categoria -->
          <div class="data-section" *ngIf="salesReport.salesByCategory.length > 0">
            <h3>üè∑Ô∏è Vendas por Categoria Fiscal</h3>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Categoria</th>
                    <th class="text-right">Quantidade</th>
                    <th class="text-right">Receita</th>
                    <th class="text-right">Percentual</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let category of salesReport.salesByCategory">
                    <td>
                      <span class="category-badge" [style.background-color]="category.color">
                        {{ category.categoryName }}
                      </span>
                    </td>
                    <td class="text-right">{{ category.quantity }}</td>
                    <td class="text-right">{{ formatCurrency(category.revenue) }}</td>
                    <td class="text-right">
                      <span class="percentage-badge">{{ category.percentage.toFixed(1) }}%</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Top Produtos -->
          <div class="data-section" *ngIf="salesReport.salesByProduct.length > 0">
            <div class="section-header">
              <h3>üèÜ Produtos Mais Vendidos</h3>
              <button type="button" class="btn-secondary btn-sm" (click)="toggleShowAllProducts()">
                {{
                  showAllProducts
                    ? 'üìä Mostrar Top 10'
                    : 'üìã Mostrar Todos (' + salesReport.salesByProduct.length + ')'
                }}
              </button>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Produto</th>
                    <th class="text-right">Quantidade</th>
                    <th class="text-right">Receita</th>
                    <th class="text-right">Pre√ßo M√©dio</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let product of getDisplayedProducts(); let i = index">
                    <td class="text-muted">{{ i + 1 }}</td>
                    <td>{{ product.productName }}</td>
                    <td class="text-right">{{ product.quantity }}</td>
                    <td class="text-right">{{ formatCurrency(product.revenue) }}</td>
                    <td class="text-right">{{ formatCurrency(product.averagePrice) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tabela CSV Completa -->
        <div class="data-section" *ngIf="salesReport">
          <div class="section-header">
            <h3>üìã Dados Completos do Relat√≥rio</h3>
            <button type="button" class="btn-secondary btn-sm" (click)="toggleCsvTable()">
              {{ showCsvTable ? 'üîº Ocultar Tabela' : 'üîΩ Mostrar Tabela Completa' }}
            </button>
          </div>

          <div class="table-container" *ngIf="showCsvTable && csvTableData.length > 0">
            <table class="data-table csv-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Tipo</th>
                  <th>Nome</th>
                  <th class="text-right">Quantidade</th>
                  <th class="text-right">Receita</th>
                  <th class="text-right">Percentual</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of csvTableData; let i = index">
                  <td class="text-muted">{{ i + 1 }}</td>
                  <td>
                    <span
                      class="type-badge"
                      [class]="'badge-' + row.type.toLowerCase().replace(' ', '-')"
                    >
                      {{ row.type }}
                    </span>
                  </td>
                  <td>{{ row.name }}</td>
                  <td class="text-right">{{ row.quantity }}</td>
                  <td class="text-right">{{ formatCurrency(row.revenue) }}</td>
                  <td class="text-right">
                    {{ row.percentage !== null ? row.percentage.toFixed(2) + '%' : '-' }}
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="table-footer">
              <p class="text-muted">Total de {{ csvTableData.length }} registros</p>
            </div>
          </div>
        </div>

        <!-- Sem dados -->
        <div class="empty-state" *ngIf="!salesReport && !isLoadingReport">
          <div class="empty-icon">üìä</div>
          <h3>Nenhum relat√≥rio gerado</h3>
          <p>Selecione os filtros acima e clique em "Gerar Relat√≥rio"</p>
        </div>
      </div>
    </div>

    <!-- ABA: Categorias Fiscais -->
    <div class="tab-panel" *ngIf="activeTab === 'categories'">
      <div class="categories-section">
        <div class="section-header">
          <h2>Gest√£o de Categorias Fiscais</h2>
          <button class="btn btn-primary" (click)="openCreateCategoryModal()">
            ‚ûï Nova Categoria
          </button>
        </div>

        <div class="categories-grid" *ngIf="categories.length > 0">
          <div class="category-card" *ngFor="let category of categories">
            <div class="category-header" [style.border-left-color]="category.color">
              <h3>{{ category.name }}</h3>
              <div class="category-actions">
                <button
                  class="btn-icon"
                  (click)="openProductsModal(category)"
                  title="Gerenciar Produtos"
                >
                  üì¶
                </button>
                <button class="btn-icon" (click)="openEditCategoryModal(category)" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn-icon danger" (click)="deleteCategory(category)" title="Deletar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            <p class="category-description" *ngIf="category.description">
              {{ category.description }}
            </p>
            <div class="category-footer">
              <span class="color-indicator" [style.background-color]="category.color"></span>
              <span
                class="product-count"
                (click)="openProductsModal(category)"
                style="cursor: pointer"
              >
                üì¶ {{ category.productIds.length }} produtos
              </span>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="categories.length === 0 && !isLoading">
          <div class="empty-icon">üè∑Ô∏è</div>
          <h3>Nenhuma categoria criada</h3>
          <p>Crie categorias fiscais para organizar seus produtos nos relat√≥rios</p>
          <button class="btn btn-primary" (click)="openCreateCategoryModal()">
            ‚ûï Criar Primeira Categoria
          </button>
        </div>
      </div>
    </div>

    <!-- ABA: An√°lise por Categoria -->
    <div class="tab-panel" *ngIf="activeTab === 'analysis'">
      <div class="analysis-section">
        <h2>üìä An√°lise Detalhada por Categoria</h2>
        <p class="coming-soon">Em breve: Gr√°ficos detalhados e comparativos entre categorias</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Categoria -->
<div class="modal-overlay" *ngIf="showCategoryModal" (click)="closeCategoryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditingCategory ? 'Editar Categoria' : 'Nova Categoria' }}</h2>
      <button class="close-btn" (click)="closeCategoryModal()">√ó</button>
    </div>

    <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
      <div class="modal-body">
        <div class="form-group">
          <label for="categoryName">Nome *</label>
          <input
            type="text"
            id="categoryName"
            formControlName="name"
            class="form-control"
            placeholder="Ex: Bebidas, Alimenta√ß√£o, etc"
          />
          <span
            class="error-message"
            *ngIf="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched"
          >
            Nome deve ter no m√≠nimo 3 caracteres
          </span>
        </div>

        <div class="form-group">
          <label for="categoryDescription">Descri√ß√£o</label>
          <textarea
            id="categoryDescription"
            formControlName="description"
            class="form-control"
            rows="3"
            placeholder="Descri√ß√£o opcional da categoria"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="categoryColor">Cor</label>
          <div class="color-picker-container">
            <input type="color" id="categoryColor" formControlName="color" class="color-picker" />
            <span class="color-preview" [style.background-color]="categoryForm.get('color')?.value">
              {{ categoryForm.get('color')?.value }}
            </span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCategoryModal()">
          Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="categoryForm.invalid || isLoading"
        >
          <span *ngIf="!isLoading">{{ isEditingCategory ? 'üíæ Salvar' : '‚ûï Criar' }}</span>
          <span *ngIf="isLoading">‚è≥ Salvando...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Gerenciar Produtos -->
<div class="modal-overlay" *ngIf="showProductsModal" (click)="closeProductsModal()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üì¶ Gerenciar Produtos - {{ selectedCategoryForProducts?.name }}</h2>
      <button class="close-btn" (click)="closeProductsModal()">√ó</button>
    </div>

    <div class="modal-body">
      <!-- Barra de busca -->
      <div class="search-bar">
        <input
          type="text"
          class="form-control"
          placeholder="üîç Buscar produtos..."
          [(ngModel)]="productSearchTerm"
        />
      </div>

      <!-- Informa√ß√µes -->
      <div class="products-info">
        <p>
          <strong>{{ selectedCategoryForProducts?.productIds?.length || 0 }}</strong> produtos
          selecionados
        </p>
        <p class="info-text">‚ÑπÔ∏è Clique nos produtos para adicionar ou remover da categoria</p>
      </div>

      <!-- Loading -->
      <div class="loading-spinner" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Atualizando...</p>
      </div>

      <!-- Lista de produtos -->
      <div class="products-list" *ngIf="!isLoading">
        <div
          class="product-item"
          *ngFor="let product of filteredProducts"
          [class.selected]="product._id && isProductInCategory(product._id)"
          (click)="product._id && toggleProductInCategory(product._id)"
        >
          <div class="product-checkbox">
            <input
              type="checkbox"
              [checked]="product._id && isProductInCategory(product._id)"
              (click)="$event.stopPropagation()"
            />
          </div>

          <div class="product-image" *ngIf="product.images && product.images.length > 0">
            <img [src]="product.images[0]" [alt]="product.name" />
          </div>
          <div
            class="product-image placeholder"
            *ngIf="!product.images || product.images.length === 0"
          >
            üç±
          </div>

          <div class="product-info">
            <h4>{{ product.name }}</h4>
            <p class="product-description" *ngIf="product.description">{{ product.description }}</p>
            <p class="product-price">R$ {{ product.price.toFixed(2) }}</p>
          </div>

          <div class="product-badge" *ngIf="product._id && isProductInCategory(product._id)">
            ‚úì Selecionado
          </div>
        </div>

        <!-- Sem produtos -->
        <div class="empty-state-small" *ngIf="filteredProducts.length === 0">
          <p>Nenhum produto encontrado</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-primary" (click)="closeProductsModal()">
        ‚úì Conclu√≠do
      </button>
    </div>
  </div>
</div>
