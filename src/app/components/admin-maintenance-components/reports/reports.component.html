<div class="reports-container">
  <!-- Header -->
  <div class="reports-header">
    <h1>üìä Relat√≥rios e An√°lises</h1>
    <p class="subtitle">An√°lise de vendas e gest√£o de categorias fiscais</p>
  </div>

  <!-- Mensagens de erro e sucesso -->
  <div class="messages">
    @if (error) {
      <div class="alert alert-error">
        <span class="icon">‚ö†Ô∏è</span>
        <span>{{ error }}</span>
        <button class="close-btn" (click)="clearMessages()">√ó</button>
      </div>
    }
    @if (success) {
      <div class="alert alert-success">
        <span class="icon">‚úì</span>
        <span>{{ success }}</span>
        <button class="close-btn" (click)="clearMessages()">√ó</button>
      </div>
    }
  </div>

  <!-- Tabs de navega√ß√£o -->
  <div class="tabs">
    <button class="tab" [class.active]="activeTab === 'sales'" (click)="setActiveTab('sales')">
      üìà Relat√≥rios de Vendas
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'categories'"
      (click)="setActiveTab('categories')"
    >
      üè∑Ô∏è Categorias Fiscais
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'analysis'"
      (click)="setActiveTab('analysis')"
    >
      üìä An√°lise por Categoria
    </button>
  </div>

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading-overlay">
      <div class="spinner"></div>
    </div>
  }

  <!-- Conte√∫do das abas -->
  <div class="tab-content">
    <!-- ABA: Relat√≥rios de Vendas -->
    @if (activeTab === 'sales') {
      <div class="tab-panel">
        <div class="report-section">
          <!-- Filtros -->
          <div class="filters-card">
            <h2>Filtros de Per√≠odo</h2>
            <form [formGroup]="reportForm" (ngSubmit)="generateReport()">
              <div class="form-grid">
                <div class="form-group">
                  <label for="startDate">Data Inicial</label>
                  <input
                    type="date"
                    id="startDate"
                    formControlName="startDate"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label for="endDate">Data Final</label>
                  <input type="date" id="endDate" formControlName="endDate" class="form-control" />
                </div>

                <div class="form-group full-width">
                  <label>M√©todos de Pagamento</label>
                  <div class="checkbox-group">
                    @for (method of availablePaymentMethods; track method.value) {
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          [value]="method.value"
                          [checked]="reportForm.value.paymentMethods?.includes(method.value)"
                          (change)="
                            $event.target.checked
                              ? reportForm.value.paymentMethods.push(method.value)
                              : reportForm.value.paymentMethods.splice(
                                  reportForm.value.paymentMethods.indexOf(method.value),
                                  1
                                )
                          "
                        />
                        {{ method.label }}
                      </label>
                    }
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="reportForm.invalid || isLoadingReport"
                >
                  @if (!isLoadingReport) {
                    <span>üîç Gerar Relat√≥rio</span>
                  }
                  @if (isLoadingReport) {
                    <span>‚è≥ Gerando...</span>
                  }
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="exportReport()"
                  [disabled]="!salesReport"
                >
                  üì• Exportar CSV
                </button>
              </div>
            </form>
          </div>

          <!-- Resultados do Relat√≥rio -->
          @if (salesReport) {
            <div class="report-results">
              <!-- Cards de Resumo -->
              <div class="summary-cards">
                <div class="summary-card">
                  <div class="card-icon">üõí</div>
                  <div class="card-content">
                    <h3>Total de Vendas</h3>
                    <p class="value">{{ salesReport.totalSales }}</p>
                  </div>
                </div>

                <div class="summary-card">
                  <div class="card-icon">üí∞</div>
                  <div class="card-content">
                    <h3>Receita Total</h3>
                    <p class="value">{{ formatCurrency(salesReport.totalRevenue) }}</p>
                  </div>
                </div>

                <div class="summary-card">
                  <div class="card-icon">üìÖ</div>
                  <div class="card-content">
                    <h3>Per√≠odo</h3>
                    <p class="value-small">
                      {{ formatDate(salesReport.startDate) }} -
                      {{ formatDate(salesReport.endDate) }}
                    </p>
                  </div>
                </div>

                <div class="summary-card">
                  <div class="card-icon">üìä</div>
                  <div class="card-content">
                    <h3>Ticket M√©dio</h3>
                    <p class="value">
                      {{ formatCurrency(salesReport.totalRevenue / salesReport.totalSales) }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Vendas por M√©todo de Pagamento -->
              @if (salesReport.salesByPaymentMethod.length > 0) {
                <div class="data-section">
                  <h3>üí≥ Vendas por M√©todo de Pagamento</h3>
                  <div class="table-container">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>M√©todo</th>
                          <th class="text-right">Quantidade</th>
                          <th class="text-right">Receita</th>
                          <th class="text-right">Percentual</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (method of salesReport.salesByPaymentMethod; track method.method) {
                          <tr>
                            <td>{{ getPaymentMethodLabel(method.method) }}</td>
                            <td class="text-right">{{ method.count }}</td>
                            <td class="text-right">{{ formatCurrency(method.revenue) }}</td>
                            <td class="text-right">
                              <span class="percentage-badge"
                                >{{ method.percentage.toFixed(1) }}%</span
                              >
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              }

              <!-- Vendas por Categoria -->
              @if (salesReport.salesByCategory.length > 0) {
                <div class="data-section">
                  <h3>üè∑Ô∏è Vendas por Categoria Fiscal</h3>
                  <div class="table-container">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>Categoria</th>
                          <th class="text-right">Quantidade</th>
                          <th class="text-right">Receita</th>
                          <th class="text-right">Percentual</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (category of salesReport.salesByCategory; track category.categoryId) {
                          <tr>
                            <td>
                              <span
                                class="category-badge"
                                [style.background-color]="category.color"
                              >
                                {{ category.categoryName }}
                              </span>
                            </td>
                            <td class="text-right">{{ category.quantity }}</td>
                            <td class="text-right">{{ formatCurrency(category.revenue) }}</td>
                            <td class="text-right">
                              <span class="percentage-badge"
                                >{{ category.percentage.toFixed(1) }}%</span
                              >
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              }

              <!-- Top Produtos -->
              @if (salesReport.salesByProduct.length > 0) {
                <div class="data-section">
                  <div class="section-header">
                    <h3>üèÜ Produtos Mais Vendidos</h3>
                    <button
                      type="button"
                      class="btn-secondary btn-sm"
                      (click)="toggleShowAllProducts()"
                    >
                      @if (showAllProducts) {
                        <span>üìä Mostrar Top 10</span>
                      } @else {
                        <span>üìã Mostrar Todos ({{ salesReport.salesByProduct.length }})</span>
                      }
                    </button>
                  </div>
                  <div class="table-container">
                    <table class="data-table">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Produto</th>
                          <th class="text-right">Quantidade</th>
                          <th class="text-right">Receita</th>
                          <th class="text-right">Pre√ßo M√©dio</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (
                          product of getDisplayedProducts();
                          track product.productId;
                          let i = $index
                        ) {
                          <tr>
                            <td class="text-muted">{{ i + 1 }}</td>
                            <td>{{ product.productName }}</td>
                            <td class="text-right">{{ product.quantity }}</td>
                            <td class="text-right">{{ formatCurrency(product.revenue) }}</td>
                            <td class="text-right">{{ formatCurrency(product.averagePrice) }}</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Tabela CSV Completa -->
          @if (salesReport) {
            <div class="data-section">
              <div class="section-header">
                <h3>üìã Dados Completos do Relat√≥rio</h3>
                <button type="button" class="btn-secondary btn-sm" (click)="toggleCsvTable()">
                  @if (showCsvTable) {
                    <span>üîº Ocultar Tabela</span>
                  } @else {
                    <span>üîΩ Mostrar Tabela Completa</span>
                  }
                </button>
              </div>

              @if (showCsvTable && csvTableData.length > 0) {
                <div class="table-container">
                  <table class="data-table csv-table">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Tipo</th>
                        <th>Nome</th>
                        <th class="text-right">Quantidade</th>
                        <th class="text-right">Receita</th>
                        <th class="text-right">Percentual</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (row of csvTableData; track row.name + row.type; let i = $index) {
                        <tr>
                          <td class="text-muted">{{ i + 1 }}</td>
                          <td>
                            <span
                              class="type-badge"
                              [class]="'badge-' + row.type.toLowerCase().replace(' ', '-')"
                            >
                              {{ row.type }}
                            </span>
                          </td>
                          <td>{{ row.name }}</td>
                          <td class="text-right">{{ row.quantity }}</td>
                          <td class="text-right">{{ formatCurrency(row.revenue) }}</td>
                          <td class="text-right">
                            {{ row.percentage !== null ? row.percentage.toFixed(2) + '%' : '-' }}
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                  <div class="table-footer">
                    <p class="text-muted">Total de {{ csvTableData.length }} registros</p>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Sem dados -->
          @if (!salesReport && !isLoadingReport) {
            <div class="empty-state">
              <div class="empty-icon">üìä</div>
              <h3>Nenhum relat√≥rio gerado</h3>
              <p>Selecione os filtros acima e clique em "Gerar Relat√≥rio"</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- ABA: Categorias Fiscais -->
    @if (activeTab === 'categories') {
      <div class="tab-panel">
        <div class="categories-section">
          <div class="section-header">
            <h2>Gest√£o de Categorias Fiscais</h2>
            <button class="btn btn-primary" (click)="openCreateCategoryModal()">
              ‚ûï Nova Categoria
            </button>
          </div>

          @if (categories.length > 0) {
            <div class="categories-grid">
              @for (category of categories; track category._id) {
                <div class="category-card">
                  <div class="category-header" [style.border-left-color]="category.color">
                    <h3>{{ category.name }}</h3>
                    <div class="category-actions">
                      <button
                        class="btn-icon"
                        (click)="openProductsModal(category)"
                        title="Gerenciar Produtos"
                      >
                        üì¶
                      </button>
                      <button
                        class="btn-icon"
                        (click)="openEditCategoryModal(category)"
                        title="Editar"
                      >
                        ‚úèÔ∏è
                      </button>
                      <button
                        class="btn-icon danger"
                        (click)="deleteCategory(category)"
                        title="Deletar"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                  @if (category.description) {
                    <p class="category-description">
                      {{ category.description }}
                    </p>
                  }
                  <div class="category-footer">
                    <span class="color-indicator" [style.background-color]="category.color"></span>
                    <span
                      class="product-count"
                      (click)="openProductsModal(category)"
                      style="cursor: pointer"
                    >
                      üì¶ {{ category.productIds.length }} produtos
                    </span>
                  </div>
                </div>
              }
            </div>
          }

          @if (categories.length === 0 && !isLoading) {
            <div class="empty-state">
              <div class="empty-icon">üè∑Ô∏è</div>
              <h3>Nenhuma categoria criada</h3>
              <p>Crie categorias fiscais para organizar seus produtos nos relat√≥rios</p>
              <button class="btn btn-primary" (click)="openCreateCategoryModal()">
                ‚ûï Criar Primeira Categoria
              </button>
            </div>
          }
        </div>
      </div>
    }

    <!-- ABA: An√°lise por Categoria -->
    @if (activeTab === 'analysis') {
      <div class="tab-panel">
        <div class="analysis-section">
          <h2>üìä An√°lise Detalhada por Categoria</h2>
          <p class="coming-soon">Em breve: Gr√°ficos detalhados e comparativos entre categorias</p>
        </div>
      </div>
    }
  </div>
</div>

<!-- Modal de Categoria -->
@if (showCategoryModal) {
  <div class="modal-overlay" (click)="closeCategoryModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditingCategory ? 'Editar Categoria' : 'Nova Categoria' }}</h2>
        <button class="close-btn" (click)="closeCategoryModal()">√ó</button>
      </div>

      <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
        <div class="modal-body">
          <div class="form-group">
            <label for="categoryName">Nome *</label>
            <input
              type="text"
              id="categoryName"
              formControlName="name"
              class="form-control"
              placeholder="Ex: Bebidas, Alimenta√ß√£o, etc"
            />
            @if (categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched) {
              <span class="error-message"> Nome deve ter no m√≠nimo 3 caracteres </span>
            }
          </div>

          <div class="form-group">
            <label for="categoryDescription">Descri√ß√£o</label>
            <textarea
              id="categoryDescription"
              formControlName="description"
              class="form-control"
              rows="3"
              placeholder="Descri√ß√£o opcional da categoria"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="categoryColor">Cor</label>
            <div class="color-picker-container">
              <input type="color" id="categoryColor" formControlName="color" class="color-picker" />
              <span
                class="color-preview"
                [style.background-color]="categoryForm.get('color')?.value"
              >
                {{ categoryForm.get('color')?.value }}
              </span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCategoryModal()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="categoryForm.invalid || isLoading"
          >
            @if (!isLoading) {
              <span>{{ isEditingCategory ? 'üíæ Salvar' : '‚ûï Criar' }}</span>
            }
            @if (isLoading) {
              <span>‚è≥ Salvando...</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Modal de Gerenciar Produtos -->
@if (showProductsModal) {
  <div class="modal-overlay" (click)="closeProductsModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üì¶ Gerenciar Produtos - {{ selectedCategoryForProducts?.name }}</h2>
        <button class="close-btn" (click)="closeProductsModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Barra de busca -->
        <div class="search-bar">
          <input
            type="text"
            class="form-control"
            placeholder="üîç Buscar produtos..."
            [(ngModel)]="productSearchTerm"
          />
        </div>

        <!-- Informa√ß√µes -->
        <div class="products-info">
          <p>
            <strong>{{ selectedCategoryForProducts?.productIds?.length || 0 }}</strong> produtos
            selecionados
          </p>
          <p class="info-text">‚ÑπÔ∏è Clique nos produtos para adicionar ou remover da categoria</p>
        </div>

        <!-- Loading -->
        @if (isLoading) {
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Atualizando...</p>
          </div>
        }

        <!-- Lista de produtos -->
        @if (!isLoading) {
          <div class="products-list">
            @for (product of filteredProducts; track product._id) {
              <div
                class="product-item"
                [class.selected]="product._id && isProductInCategory(product._id)"
                (click)="product._id && toggleProductInCategory(product._id)"
              >
                <div class="product-checkbox">
                  <input
                    type="checkbox"
                    [checked]="product._id && isProductInCategory(product._id)"
                    (click)="$event.stopPropagation()"
                  />
                </div>

                @if (product.images && product.images.length > 0) {
                  <div class="product-image">
                    <img [src]="product.images[0]" [alt]="product.name" />
                  </div>
                } @else {
                  <div class="product-image placeholder">üç±</div>
                }

                <div class="product-info">
                  <h4>{{ product.name }}</h4>
                  @if (product.description) {
                    <p class="product-description">{{ product.description }}</p>
                  }
                  <p class="product-price">R$ {{ product.price.toFixed(2) }}</p>
                </div>

                @if (product._id && isProductInCategory(product._id)) {
                  <div class="product-badge">‚úì Selecionado</div>
                }
              </div>
            }

            <!-- Sem produtos -->
            @if (filteredProducts.length === 0) {
              <div class="empty-state-small">
                <p>Nenhum produto encontrado</p>
              </div>
            }
          </div>
        }
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="closeProductsModal()">
          ‚úì Conclu√≠do
        </button>
      </div>
    </div>
  </div>
}
