<app-admin-header></app-admin-header>

<div class="categories-management-container">
  <div class="page-title">
    <h1>üìÇ Gerenciamento de Categorias</h1>
    <p class="subtitle">Gerencie as categorias de produtos do sistema</p>
  </div>

  <!-- Estat√≠sticas -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon">üìÇ</div>
      <div class="stat-info">
        <div class="stat-value">{{ categories.length }}</div>
        <div class="stat-label">Total de Categorias</div>
      </div>
    </div>

    <div class="stat-card info">
      <div class="stat-icon">üì¶</div>
      <div class="stat-info">
        <div class="stat-value">{{ getTotalProducts() }}</div>
        <div class="stat-label">Produtos Categorizados</div>
      </div>
    </div>
  </div>

  <!-- Bot√£o de criar categoria -->
  <div class="actions-container">
    <button class="create-button" (click)="openCreateModal()">‚ûï Criar Nova Categoria</button>
  </div>

  <!-- Barra de Pesquisa -->
  <div class="search-section">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="üîç Pesquisar categorias por nome ou slug..."
        class="search-input"
      />
      @if (searchTerm) {
        <button class="clear-search" (click)="searchTerm = ''">&times;</button>
      }
    </div>
    <p class="search-results">
      Exibindo {{ filteredCategories.length }} de {{ categories.length }} categorias
    </p>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Carregando categorias...</p>
    </div>
  }

  <!-- Grid de categorias -->
  @if (!loading) {
    <div class="categories-grid">
      @if (filteredCategories.length === 0 && categories.length > 0) {
        <div class="empty-state">
          <p>Nenhuma categoria encontrada com "{{ searchTerm }}"</p>
        </div>
      }

      @for (category of filteredCategories; track category._id) {
        <div
          class="category-card"
          [class.dragging]="draggedCategory?._id === category._id"
          [class.drag-over]="dragOverCategory?._id === category._id"
          [attr.data-category-id]="category._id"
          draggable="true"
          (dragstart)="onDragStart($event, category)"
          (dragover)="onDragOver($event, category)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event, category)"
          (dragend)="onDragEnd()"
          (touchstart)="onTouchStart($event, category)"
          (touchmove)="onTouchMove($event)"
          (touchend)="onTouchEnd($event)"
          (touchcancel)="onTouchCancel()"
        >
          <div class="category-header">
            <div class="category-emoji">{{ category.emoji }}</div>
            <div class="category-index">#{{ category.index || 0 }}</div>
          </div>

          <div class="category-info">
            <h3>{{ category.name }}</h3>

            <div class="category-badges">
              @if (category.productCount !== undefined) {
                <span class="count-badge" [class.has-products]="category.productCount > 0">
                  {{ category.productCount }} produto{{ category.productCount !== 1 ? 's' : '' }}
                </span>
              }
              @if (category.discounts && category.discounts.length > 0) {
                <span
                  class="discount-badge"
                  title="Possui {{ category.discounts.length }} desconto(s) configurado(s)"
                >
                  üí∞ {{ category.discounts.length }} desconto{{
                    category.discounts.length !== 1 ? 's' : ''
                  }}
                </span>
              }
            </div>
          </div>

          <div class="category-actions">
            <button
              class="discount-btn"
              (click)="openDiscountsModal(category)"
              title="Gerenciar descontos"
            >
              üí∞
            </button>
            <button class="edit-btn" (click)="openEditModal(category)" title="Editar categoria">
              ‚úèÔ∏è
            </button>
            <button
              class="delete-btn"
              (click)="deleteCategory(category)"
              [disabled]="(category.productCount || 0) > 0"
              [title]="
                (category.productCount || 0) > 0
                  ? 'N√£o pode deletar categoria com produtos'
                  : 'Deletar categoria'
              "
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
      }

      @if (categories.length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üìÇ</div>
          <h3>Nenhuma categoria cadastrada</h3>
          <p>Clique em "Criar Nova Categoria" para adicionar a primeira categoria</p>
        </div>
      }
    </div>
  }

  <!-- Modal de Cria√ß√£o -->
  @if (showCreateModal) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚ûï Criar Nova Categoria</h2>
          <button class="close-btn" (click)="closeCreateModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <!-- Nome -->
          <div class="form-group">
            <label>Nome da Categoria *</label>
            <input
              type="text"
              [(ngModel)]="newCategory.name"
              (ngModelChange)="onNameChange()"
              placeholder="Ex: Bebidas Quentes"
              maxlength="50"
              autofocus
            />
          </div>

          <!-- Emoji -->
          <div class="form-group">
            <label>Emoji *</label>
            <div class="emoji-selector">
              <div class="selected-emoji" title="Emoji selecionado">
                {{ newCategory.emoji }}
              </div>
              <div class="emoji-grid">
                @for (emoji of commonEmojis; track emoji) {
                  <button
                    type="button"
                    class="emoji-btn"
                    [class.selected]="newCategory.emoji === emoji"
                    (click)="newCategory.emoji = emoji"
                    title="Selecionar {{ emoji }}"
                  >
                    {{ emoji }}
                  </button>
                }
              </div>
            </div>
          </div>

          <!-- √çndice de Ordem -->
          <div class="form-group">
            <label>√çndice de Ordena√ß√£o</label>
            <input type="number" [(ngModel)]="newCategory.index" min="0" />
            <small class="field-hint">Menor valor aparece primeiro (0, 1, 2...)</small>
          </div>

          <!-- Exibir no Card√°pio -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newCategory.showInMenu" />
              <span>Exibir no card√°pio p√∫blico (Bento Box)</span>
            </label>
            <small class="field-hint">
              Se desmarcado, apenas administradores poder√£o adicionar produtos desta categoria
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeCreateModal()">Cancelar</button>
          <button class="save-btn" (click)="createCategory()">‚úÖ Criar Categoria</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Edi√ß√£o -->
  @if (showEditModal) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚úèÔ∏è Editar Categoria</h2>
          <button class="close-btn" (click)="closeEditModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <!-- Aviso sobre renomea√ß√£o -->
          <div class="warning-box">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text">
              <strong>Aten√ß√£o!</strong>
              <p>
                Ao renomear esta categoria, todos os produtos vinculados ser√£o atualizados
                automaticamente.
              </p>
            </div>
          </div>

          <!-- Nome -->
          <div class="form-group">
            <label>Nome da Categoria *</label>
            <input
              type="text"
              [(ngModel)]="editingCategory.name"
              (ngModelChange)="onEditNameChange()"
              placeholder="Ex: Bebidas Quentes"
              maxlength="50"
            />
          </div>

          <!-- Emoji -->
          <div class="form-group">
            <label>Emoji *</label>
            <div class="emoji-selector">
              <div class="selected-emoji" title="Emoji selecionado">
                {{ editingCategory.emoji }}
              </div>
              <div class="emoji-grid">
                @for (emoji of commonEmojis; track emoji) {
                  <button
                    type="button"
                    class="emoji-btn"
                    [class.selected]="editingCategory.emoji === emoji"
                    (click)="editingCategory.emoji = emoji"
                    title="Selecionar {{ emoji }}"
                  >
                    {{ emoji }}
                  </button>
                }
              </div>
            </div>
          </div>

          <!-- √çndice de Ordena√ß√£o (edi√ß√£o) -->
          <div class="form-group">
            <label>√çndice de Ordena√ß√£o</label>
            <input type="number" [(ngModel)]="editingCategory.index" min="0" />
            <small class="field-hint">Menor valor aparece primeiro (0, 1, 2...)</small>
          </div>

          <!-- Exibir no Card√°pio -->
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="editingCategory.showInMenu" />
              <span>Exibir no card√°pio p√∫blico (Bento Box)</span>
            </label>
            <small class="field-hint">
              Se desmarcado, apenas administradores poder√£o adicionar produtos desta categoria
            </small>
          </div>

          <!-- Produtos vinculados -->
          @if (editingCategory.productCount !== undefined) {
            <div class="info-box">
              <span class="info-icon">‚ÑπÔ∏è</span>
              <span class="info-text">
                Esta categoria possui <strong>{{ editingCategory.productCount }}</strong> produto{{
                  editingCategory.productCount !== 1 ? 's' : ''
                }}
                vinculado{{ editingCategory.productCount !== 1 ? 's' : '' }}.
              </span>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeEditModal()">Cancelar</button>
          <button class="save-btn" (click)="updateCategory()">‚úÖ Salvar Altera√ß√µes</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Descontos -->
  @if (showDiscountsModal && discountsCategory) {
    <div class="modal-overlay" (click)="closeDiscountsModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>üí∞ Descontos por Perfil de Cliente</h2>
          <button class="close-btn" (click)="closeDiscountsModal()">&times;</button>
        </div>

        <div class="modal-body">
          <div class="discount-category-info">
            <span class="category-emoji-large">{{ discountsCategory.emoji }}</span>
            <div>
              <h3>{{ discountsCategory.name }}</h3>
              <p class="category-desc">Configure descontos para perfis de clientes</p>
            </div>
          </div>

          <!-- Lista de Descontos -->
          <div class="discounts-list">
            @if (discounts.length === 0) {
              <div class="empty-state">
                <p class="empty-icon">üìä</p>
                <p class="empty-text">Nenhum desconto configurado</p>
                <p class="empty-hint">Clique em "Adicionar Desconto" para come√ßar</p>
              </div>
            } @else {
              @for (discount of discounts; track $index) {
                <div class="discount-item">
                  <div class="discount-field">
                    <label>Perfil de Cliente</label>
                    <select [(ngModel)]="discount.roleId">
                      @for (role of getAvailableRolesForSelect(discount.roleId); track role._id) {
                        <option [value]="role._id">{{ role.name }}</option>
                      }
                    </select>
                  </div>

                  <div class="discount-field">
                    <label>Desconto (%)</label>
                    <input
                      type="number"
                      [(ngModel)]="discount.discountPercent"
                      min="0"
                      max="100"
                      step="1"
                      placeholder="Ex: 10"
                    />
                  </div>

                  <button
                    class="remove-discount-btn"
                    (click)="removeDiscount($index)"
                    title="Remover desconto"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              }
            }
          </div>

          <!-- Bot√£o Adicionar Desconto -->
          <button
            class="add-discount-btn"
            (click)="addDiscount()"
            [disabled]="discounts.length >= availableRoles.length"
          >
            ‚ûï Adicionar Desconto
          </button>

          @if (discounts.length >= availableRoles.length && availableRoles.length > 0) {
            <p class="hint-text">
              ‚ö†Ô∏è Todos os perfis de cliente dispon√≠veis j√° possuem descontos configurados
            </p>
          }
        </div>

        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeDiscountsModal()">Cancelar</button>
          <button class="save-btn" (click)="saveDiscounts()">üíæ Salvar Descontos</button>
        </div>
      </div>
    </div>
  }
</div>
