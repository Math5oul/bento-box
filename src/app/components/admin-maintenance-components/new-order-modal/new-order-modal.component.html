<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2>Novo Pedido</h2>
      <button class="close-btn" (click)="closeModal()" aria-label="Fechar">
        <span>√ó</span>
      </button>
    </div>

    <!-- Progress -->
    <div class="progress-bar">
      <div
        class="step"
        [class.active]="currentStep === 'table'"
        [class.completed]="currentStep !== 'table'"
      >
        <span class="step-number">1</span>
        <span class="step-label">Mesa</span>
      </div>

      <div
        class="step"
        [class.active]="currentStep === 'client'"
        [class.completed]="currentStep === 'products'"
      >
        <span class="step-number">2</span>
        <span class="step-label">Cliente</span>
      </div>

      <div class="step" [class.active]="currentStep === 'products'">
        <span class="step-number">3</span>
        <span class="step-label">Produtos</span>
      </div>
    </div>

    <!-- Error -->
    @if (error) {
      <div class="error-message">{{ error }}</div>
    }

    <!-- STEP 1 -->
    @if (currentStep === 'table') {
      <div class="modal-body">
        <h3>Selecione a Mesa ou Balc√£o</h3>

        <!-- Bot√£o de Balc√£o -->
        <div class="counter-option">
          <button class="counter-btn" (click)="selectCounter()">
            <span class="counter-icon">üè™</span>
            <div class="counter-text">
              <strong>Pedido de Balc√£o</strong>
              <small>Para clientes sem mesa</small>
            </div>
          </button>
        </div>

        <div class="divider">
          <span>OU</span>
        </div>

        @if (loadingTables) {
          <div class="loading">Carregando mesas...</div>
        } @else if (tables.length === 0) {
          <p class="empty-state">Nenhuma mesa dispon√≠vel</p>
        } @else {
          <div class="table-grid">
            @for (table of tables; track table._id) {
              <button
                class="table-card"
                [class.occupied]="table.status === 'occupied'"
                [class.reserved]="table.status === 'reserved'"
                (click)="selectTable(table)"
              >
                <div class="table-number">{{ getTableDisplayName(table) }}</div>
                <div class="table-status">{{ getTableStatusLabel(table.status) }}</div>
                <div class="table-clients">
                  {{ (table.clients.length || 0) + (table.anonymousClients.length || 0) }}
                  cliente(s)
                </div>
              </button>
            }
          </div>
        }
      </div>
    }

    <!-- STEP 2 -->
    @if (currentStep === 'client') {
      <div class="modal-body">
        <h3>
          Selecione ou Crie um Cliente -
          {{ isCounterOrder ? 'Balc√£o' : getTableDisplayName(selectedTable!) }}
        </h3>

        @if (!creatingNewClient) {
          <!-- Bot√£o de criar novo cliente no topo -->
          <button
            class="btn btn-secondary full-width"
            (click)="startCreateClient()"
            style="margin-bottom: 1rem"
          >
            ‚ûï Criar Novo Cliente An√¥nimo
          </button>

          <!-- Barra de pesquisa e lista completa de clientes registrados -->
          <div class="search-bar">
            <input
              type="text"
              [(ngModel)]="clientSearchTerm"
              (input)="filterClients()"
              placeholder="üîç Buscar por nome ou email..."
              class="search-input"
            />
            @if (clientSearchTerm) {
              <button class="clear-search" (click)="clientSearchTerm = ''; filterClients()">
                ‚úï
              </button>
            }
          </div>

          @if (loadingClients) {
            <div class="loading">Carregando clientes...</div>
          } @else {
            @if (filteredClients.length > 0) {
              <div class="client-list">
                @for (client of filteredClients; track client._id) {
                  <button
                    class="client-card"
                    [class.connected]="isClientConnectedToTable(client)"
                    (click)="selectClient(client)"
                  >
                    <div class="client-main-info">
                      <span class="client-icon">üë§</span>
                      <div class="client-details">
                        <span class="client-name">{{ client.name }}</span>
                        @if (client.email) {
                          <span class="client-email">{{ client.email }}</span>
                        }
                      </div>
                    </div>

                    <div class="client-badges">
                      @if (getClientCustomRoleName(client); as roleName) {
                        <span class="badge custom-role">{{ roleName }}</span>
                      }

                      @if (client.isAnonymous) {
                        <span class="badge anon">An√¥nimo</span>
                      }
                    </div>
                  </button>
                }
              </div>
            } @else if (clientSearchTerm) {
              <p class="empty-state">Nenhum cliente encontrado com "{{ clientSearchTerm }}"</p>
            } @else {
              <p class="empty-state">Nenhum cliente registrado encontrado</p>
            }
          }
        } @else {
          <div class="new-client-form">
            <label for="clientName">Nome do Cliente:</label>
            <input
              id="clientName"
              type="text"
              [(ngModel)]="newClientName"
              placeholder="Digite o nome do cliente"
              class="form-input"
              (keyup.enter)="createAnonymousClient()"
            />

            <label for="clientRole">Tipo de Cliente:</label>
            <select id="clientRole" [(ngModel)]="selectedClientRole" class="form-select">
              @for (role of clientRoles; track role._id) {
                <option [value]="role._id">
                  {{ role.name }}
                  @if (role.clientLevel === 1) {
                    <span>(Padr√£o)</span>
                  }
                </option>
              }
            </select>
            <small class="help-text"
              >O tipo de cliente define os descontos que ser√£o aplicados</small
            >

            <div class="form-actions">
              <button class="btn btn-secondary" (click)="cancelCreateClient()">Cancelar</button>
              <button
                class="btn btn-primary"
                (click)="createAnonymousClient()"
                [disabled]="!newClientName.trim()"
              >
                Criar Cliente
              </button>
            </div>
          </div>
        }
      </div>
    }

    <!-- STEP 3 -->
    @if (currentStep === 'products') {
      <div class="modal-body products-step">
        <div class="products-header">
          <h3>Adicionar Produtos - {{ selectedClient?.name }}</h3>

          <div class="filters">
            <select [(ngModel)]="selectedCategory" class="form-select">
              <option value="all">Todas as Categorias</option>

              @for (cat of categories; track cat) {
                <option [value]="cat">{{ getCategoryName(cat) }}</option>
              }
            </select>

            <input
              type="text"
              [(ngModel)]="searchTerm"
              placeholder="Buscar produtos..."
              class="form-input search-input"
            />
          </div>
        </div>

        <div class="products-container">
          <!-- Lista -->
          <div class="products-list" #productsList>
            @if (loadingProducts) {
              <div class="loading">Carregando produtos...</div>
            } @else if (filteredProducts.length === 0) {
              <p class="empty-state">Nenhum produto encontrado</p>
            } @else {
              @for (product of filteredProducts; track product._id) {
                <button class="product-card" (click)="addProductToOrder(product)">
                  <div class="product-card-content" style="position: relative">
                    @if (product.images && product.images.length > 0) {
                      <img [src]="product.images[0]" [alt]="product.name" class="product-image" />
                    } @else {
                      <div class="product-image-placeholder">üì¶</div>
                    }

                    @if (product.variations && product.variations.length > 0) {
                      <span
                        style="
                          position: absolute;
                          left: 64px;
                          bottom: 4px;
                          font-size: 1.5em;
                          pointer-events: none;
                        "
                        >üî∏</span
                      >
                    }

                    <div class="product-info">
                      <div class="product-name">{{ product.name }}</div>

                      @if (product.sizes && product.sizes.length > 0) {
                        <div class="product-sizes">
                          @for (size of product.sizes; track size.abbreviation) {
                            <span class="size-tag">
                              {{ size.abbreviation }}:
                              {{ formatCurrency(getSizePriceWithDiscount(product, size)) }}
                            </span>
                          }
                        </div>
                      } @else {
                        <div class="product-price">
                          {{ formatCurrency(getBasePriceWithDiscount(product)) }}
                        </div>
                      }
                    </div>
                  </div>
                </button>
              }
            }
          </div>

          <!-- Carrinho -->
          <div class="order-cart" #orderCart>
            <h4>Itens do Pedido</h4>

            @if (orderItems.length === 0) {
              <p class="empty-cart">Nenhum item adicionado</p>
            } @else {
              <div class="cart-items">
                @for (item of orderItems; track trackByItem($index, item)) {
                  <div class="cart-item">
                    <div class="item-header">
                      <span class="item-name">
                        {{ item.product.name }}
                        @if (item.selectedSize) {
                          <span class="size-badge">{{ item.selectedSize.abbreviation }}</span>
                        }
                      </span>

                      <button class="remove-btn" (click)="removeItem(item)">√ó</button>
                    </div>

                    <div class="item-controls">
                      <div class="quantity-controls">
                        <button class="qty-btn" (click)="updateQuantity(item, -1)">‚àí</button>
                        <span class="quantity">{{ item.quantity }}</span>
                        <button class="qty-btn" (click)="updateQuantity(item, 1)">+</button>
                      </div>

                      <span class="item-total">
                        {{ formatCurrency(getItemPrice(item) * item.quantity) }}
                      </span>
                    </div>

                    <input
                      type="text"
                      [(ngModel)]="item.notes"
                      placeholder="Observa√ß√µes (opcional)"
                      class="form-input notes-input"
                    />
                  </div>
                }
              </div>

              <div class="cart-total">
                <span>Total:</span>
                <span class="total-value">{{ formatCurrency(getTotalAmount()) }}</span>
              </div>
            }
          </div>
        </div>

        <button class="floating-nav-btn" (click)="scrollBetweenSections()">
          @if (isViewingCart) {
            <span>‚Üë</span>
          }
          @if (!isViewingCart) {
            <span>‚Üì</span>
          }
        </button>
      </div>
    }

    <!-- Footer -->
    <div class="modal-footer">
      @if (currentStep !== 'table') {
        <button class="btn btn-secondary" (click)="goBack()">‚Üê Voltar</button>
      }

      <div class="spacer"></div>

      @if (currentStep === 'products') {
        <button
          class="btn btn-primary"
          (click)="submitOrder()"
          [disabled]="orderItems.length === 0"
        >
          Finalizar Pedido
        </button>
      }
    </div>
  </div>
</div>

<!-- Size Selector Modal -->

@if (showSizeSelector && productForSize) {
  <div class="size-selector-overlay" (click)="closeSizeSelector()">
    <div class="size-selector-modal" (click)="$event.stopPropagation()">
      <div class="size-selector-header">
        <h3>
          @if (
            productForSize.sizes &&
            productForSize.sizes.length > 0 &&
            productForSize.variations &&
            productForSize.variations.length > 0
          ) {
            Escolha o tamanho e/ou varia√ß√£o
          } @else if (productForSize.sizes && productForSize.sizes.length > 0) {
            Escolha o tamanho
          } @else if (productForSize.variations && productForSize.variations.length > 0) {
            Escolha a varia√ß√£o
          }
        </h3>

        <button class="close-btn" (click)="closeSizeSelector()">√ó</button>
      </div>

      <div class="size-selector-product">
        <strong>{{ productForSize.name }}</strong>
      </div>

      @if (productForSize.variations && productForSize.variations.length > 0) {
        <div class="variation-options">
          <div class="variation-list">
            @for (variation of productForSize.variations; track variation.title) {
              <button
                class="variation-option"
                [class.selected]="selectedVariation?.title === variation.title"
                (click)="selectVariation(variation)"
              >
                @if (variation.image) {
                  <img [src]="variation.image" alt="{{ variation.title }}" class="variation-img" />
                }
                <div class="variation-info">
                  <span class="variation-title">{{ variation.title }}</span>
                </div>
                <span class="variation-price">
                  {{ formatCurrency(variation.price) }}
                </span>
              </button>
            }
          </div>
        </div>
      }

      @if (
        productForSize.variations &&
        productForSize.variations.length > 0 &&
        productForSize.sizes &&
        productForSize.sizes.length > 0
      ) {
        <div class="divider"></div>
      }

      @if (productForSize.sizes && productForSize.sizes.length > 0) {
        <div class="size-options">
          @for (size of productForSize.sizes; track size.abbreviation) {
            <button class="size-option box-style" (click)="selectSize(size)">
              <span class="size-name">{{ size.name }} ({{ size.abbreviation }})</span>
              <span class="size-price">{{
                formatCurrency(getSizePriceWithDiscount(productForSize, size))
              }}</span>

              @if (selectedVariation) {
                <span class="variation-badge">{{ selectedVariation.title }}</span>
              }
            </button>
          }
        </div>
      }

      @if (
        !(productForSize.sizes && productForSize.sizes.length > 0) &&
        productForSize.variations &&
        productForSize.variations.length > 0
      ) {
        <div class="variation-confirm">
          <button
            class="confirm-btn"
            [disabled]="!selectedVariation"
            (click)="selectSize(undefined)"
          >
            Adicionar {{ selectedVariation?.title }}
          </button>
        </div>
      }
    </div>
  </div>
}
