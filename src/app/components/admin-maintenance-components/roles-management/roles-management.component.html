<div class="roles-management-container">
  <div class="page-title">
    <h1>üë§ Gerenciamento de Perfis e Permiss√µes</h1>
    <p class="subtitle">Crie e gerencie perfis de usu√°rios com permiss√µes personalizadas</p>
  </div>

  <!-- A√ß√µes -->
  <div class="actions-section">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="üîç Pesquisar perfis..."
        class="search-input"
      />
      @if (searchTerm) {
        <button class="clear-search" (click)="searchTerm = ''">&times;</button>
      }
    </div>
    <button class="create-button" (click)="openCreateModal()">‚ûï Criar Novo Perfil</button>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Carregando perfis...</p>
    </div>
  }

  <!-- Roles por Categoria -->
  @if (!loading) {
    <!-- Perfis de Staff -->
    <div class="roles-section">
      <h2>üë• Perfis de Staff (Equipe)</h2>
      <div class="roles-grid">
        @for (role of staffRoles; track role._id) {
          <div class="role-card" [class.system]="role.isSystem">
            <div class="role-header">
              <div class="role-title">
                <h3>{{ role.name }}</h3>
                @if (role.isSystem) {
                  <span class="system-badge">üîí Sistema</span>
                }
              </div>
              <span class="level-badge staff">Staff</span>
            </div>

            @if (role.description) {
              <p class="role-description">{{ role.description }}</p>
            }

            <div class="role-meta">
              <p>
                <strong>Slug:</strong> <code>{{ role.slug }}</code>
              </p>
              <p>
                <strong>Permiss√µes Ativas:</strong> {{ getActivePermissionsCount(role) }}/{{
                  permissionsList.length
                }}
              </p>
            </div>

            <div class="role-actions">
              <button class="btn-permissions" (click)="openPermissionsModal(role)">
                üîê Permiss√µes
              </button>
              @if (!role.isSystem) {
                <button class="btn-edit" (click)="openEditModal(role)">‚úèÔ∏è Editar</button>
                <button class="btn-delete" (click)="deleteRole(role)">üóëÔ∏è Deletar</button>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Perfis de Clientes -->
    <div class="roles-section">
      <h2>üé´ Perfis de Clientes</h2>
      <div class="roles-grid">
        @for (role of clientRoles; track role._id) {
          <div class="role-card" [class.system]="role.isSystem">
            <div class="role-header">
              <div class="role-title">
                <h3>{{ role.name }}</h3>
                @if (role.isSystem) {
                  <span class="system-badge">üîí Sistema</span>
                }
              </div>
              <span class="level-badge" [attr.data-level]="role.clientLevel">
                {{ getRoleLevelLabel(role.clientLevel) }}
              </span>
            </div>

            @if (role.description) {
              <p class="role-description">{{ role.description }}</p>
            }

            <div class="role-meta">
              <p>
                <strong>Slug:</strong> <code>{{ role.slug }}</code>
              </p>
              <p>
                <strong>Permiss√µes Ativas:</strong> {{ getActivePermissionsCount(role) }}/{{
                  permissionsList.length
                }}
              </p>
            </div>

            <div class="role-actions">
              <button class="btn-permissions" (click)="openPermissionsModal(role)">
                üîê Permiss√µes
              </button>
              @if (!role.isSystem) {
                <button class="btn-edit" (click)="openEditModal(role)">‚úèÔ∏è Editar</button>
                <button class="btn-delete" (click)="deleteRole(role)">üóëÔ∏è Deletar</button>
              }
            </div>
          </div>
        }
      </div>
    </div>

    @if (roles.length === 0) {
      <div class="empty-state">
        <p>Nenhum perfil cadastrado</p>
      </div>
    }
  }

  <!-- Modal de Cria√ß√£o -->
  @if (showCreateModal) {
    <div class="modal active">
      <div class="modal-overlay" (click)="closeCreateModal()"></div>
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ûï Criar Novo Perfil</h3>
          <button class="close-btn" (click)="closeCreateModal()">&times;</button>
        </div>

        <form (submit)="createRole(); $event.preventDefault()">
          <div class="form-group">
            <label>Nome do Perfil *</label>
            <input
              type="text"
              [(ngModel)]="newRole.name"
              name="name"
              placeholder="Ex: Cliente Premium"
              (blur)="generateSlug()"
              required
            />
          </div>

          <div class="form-group">
            <label>Slug (Identificador √önico) *</label>
            <input
              type="text"
              [(ngModel)]="newRole.slug"
              name="slug"
              placeholder="cliente-premium"
              required
            />
          </div>

          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea
              [(ngModel)]="newRole.description"
              name="description"
              placeholder="Descri√ß√£o do perfil e suas responsabilidades..."
              rows="3"
            ></textarea>
          </div>

          <div class="info-box">
            <p>‚ÑπÔ∏è Ap√≥s criar o perfil, voc√™ poder√° configurar as permiss√µes espec√≠ficas.</p>
          </div>

          <div class="modal-footer">
            <button type="button" class="cancel-btn" (click)="closeCreateModal()">Cancelar</button>
            <button type="submit" class="save-btn">‚úÖ Criar Perfil</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal de Edi√ß√£o -->
  @if (showEditModal) {
    <div class="modal active">
      <div class="modal-overlay" (click)="closeEditModal()"></div>
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úèÔ∏è Editar Perfil</h3>
          <button class="close-btn" (click)="closeEditModal()">&times;</button>
        </div>

        <form (submit)="updateRole(); $event.preventDefault()">
          <div class="form-group">
            <label>Nome do Perfil *</label>
            <input type="text" [(ngModel)]="editingRole.name" name="name" required />
          </div>

          <div class="form-group">
            <label>Slug *</label>
            <input
              type="text"
              [(ngModel)]="editingRole.slug"
              name="slug"
              [disabled]="editingRole.isSystem ?? false"
              required
            />
          </div>

          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea [(ngModel)]="editingRole.description" name="description" rows="3"></textarea>
          </div>

          @if (editingRole.isSystem) {
            <div class="info-box warning">
              <p>‚ö†Ô∏è Perfis do sistema t√™m restri√ß√µes de edi√ß√£o para manter a integridade.</p>
            </div>
          }

          <div class="modal-footer">
            <button type="button" class="cancel-btn" (click)="closeEditModal()">Cancelar</button>
            <button type="submit" class="save-btn">‚úÖ Salvar Altera√ß√µes</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal de Permiss√µes -->
  @if (showPermissionsModal && selectedRole) {
    <div class="modal active large">
      <div class="modal-overlay" (click)="closePermissionsModal()"></div>
      <div class="modal-content permissions-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üîê Permiss√µes - {{ selectedRole.name }}</h3>
          <button class="close-btn" (click)="closePermissionsModal()">&times;</button>
        </div>

        <div class="permissions-content">
          <div class="permissions-header">
            <p class="description">
              Configure as permiss√µes espec√≠ficas deste perfil. Permiss√µes controlam o que os
              usu√°rios podem fazer no sistema.
            </p>
            <div class="quick-actions">
              <button class="btn-secondary" (click)="toggleAllPermissions(true)">
                ‚úÖ Selecionar Todas
              </button>
              <button class="btn-secondary" (click)="toggleAllPermissions(false)">
                ‚ùå Desmarcar Todas
              </button>
            </div>
          </div>

          <div class="permissions-grid">
            @for (category of getCategories(); track category) {
              <div class="permission-category">
                <h4>{{ category }}</h4>
                <div class="permissions-list">
                  @for (permission of getPermissionsByCategory(category); track permission.key) {
                    <label class="permission-item">
                      <input
                        type="checkbox"
                        [(ngModel)]="selectedRole.permissions[permission.key]"
                      />
                      <span>{{ permission.label }}</span>
                    </label>
                  }
                </div>
              </div>
            }
          </div>

          <div class="permissions-summary">
            <p>
              <strong>Total:</strong> {{ getActivePermissionsCount(selectedRole) }} de
              {{ permissionsList.length }} permiss√µes ativas
            </p>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="cancel-btn" (click)="closePermissionsModal()">
            Cancelar
          </button>
          <button type="button" class="save-btn" (click)="savePermissions()">
            ‚úÖ Salvar Permiss√µes
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal de Migra√ß√£o de Usu√°rios -->
  @if (showMigrationModal && roleToDelete) {
    <div class="modal active">
      <div class="modal-overlay" (click)="closeMigrationModal()"></div>
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚ö†Ô∏è Migra√ß√£o de Usu√°rios</h3>
          <button class="close-btn" (click)="closeMigrationModal()">&times;</button>
        </div>

        <div class="migration-content">
          <div class="warning-box">
            <p>
              <strong>Aten√ß√£o:</strong> O perfil <strong>"{{ roleToDelete.name }}"</strong> possui
              <strong>{{ usersToMigrate }}</strong> usu√°rio(s) associado(s).
            </p>
            <p>
              Para deletar este perfil, voc√™ deve escolher um perfil de destino para migrar os
              usu√°rios.
            </p>
          </div>

          <div class="form-group">
            <label>Selecione o perfil de destino</label>
            <select [(ngModel)]="migrationTargetRoleId" class="select-role">
              <option value="">-- Selecione um perfil --</option>
              @for (role of availableRolesForMigration; track role._id) {
                <option [value]="role._id">
                  {{ role.name }}
                  {{ role.clientLevel === 0 ? '(Staff)' : '(N√≠vel ' + role.clientLevel + ')' }}
                </option>
              }
            </select>
          </div>

          <div class="info-box">
            <p>‚ÑπÔ∏è <strong>O que acontecer√°:</strong></p>
            <ul>
              <li>Os {{ usersToMigrate }} usu√°rio(s) ser√£o migrados para o perfil escolhido</li>
              <li>O perfil "{{ roleToDelete.name }}" ser√° deletado permanentemente</li>
              <li>Esta a√ß√£o n√£o pode ser desfeita</li>
            </ul>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="cancel-btn" (click)="closeMigrationModal()">Cancelar</button>
          <button
            type="button"
            class="delete-btn"
            (click)="confirmMigrationAndDelete()"
            [disabled]="!migrationTargetRoleId"
          >
            üóëÔ∏è Migrar e Deletar
          </button>
        </div>
      </div>
    </div>
  }
</div>
