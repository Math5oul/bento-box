<app-admin-header></app-admin-header>

<div class="waiter-dashboard">
  <div class="page-title">
    <h1>üßë‚Äçüç≥ Painel do Gar√ßom</h1>
    <p class="subtitle">Gest√£o de Pedidos e Mesas</p>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <div class="filter-item">
      <label class="filter-label">Mesa:</label>
      <select [(ngModel)]="filterTable" (change)="applyFilters()" class="filter-select">
        <option value="all">Todas</option>
        @for (table of tables; track table) {
          <option [value]="table">Mesa {{ table }}</option>
        }
      </select>
    </div>

    <div class="filter-item">
      <label class="filter-label">Status:</label>
      <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="filter-select">
        @for (s of statuses; track s.value) {
          <option [value]="s.value">{{ s.label }}</option>
        }
      </select>
    </div>

    <div class="filter-item search-box">
      <label class="filter-label">Buscar:</label>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="Cliente ou mesa..."
        class="search-input"
      />
    </div>

    <div class="order-count">
      <span class="count-label">Pedidos Ativos:</span>
      <span class="count-value">{{ filteredOrders.length }}</span>
    </div>
  </div>

  <!-- Loading & Error States -->
  @if (loading) {
    <div class="loading">‚è≥ Carregando pedidos...</div>
  } @else if (error) {
    <div class="error-message">‚ùå {{ error }}</div>
  } @else {
    <!-- Orders Container -->
    <div class="orders-container">
      <!-- Active Orders -->
      <div class="section-header">
        <h2>üçΩÔ∏è Pedidos Ativos</h2>
        <button class="new-order-btn" (click)="createNewOrder()">‚ûï Novo Pedido</button>
      </div>

      @if (filteredOrders.length === 0) {
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <h3>Nenhum pedido ativo</h3>
          <p class="empty-hint">
            {{
              filterStatus !== 'all' || filterTable !== 'all' || searchTerm
                ? 'Nenhum pedido encontrado com os filtros aplicados.'
                : 'Aguarde novos pedidos ou crie um novo.'
            }}
          </p>
        </div>
      } @else {
        <!-- Orders Grid -->
        <div class="orders-grid">
          @for (order of filteredOrders; track order.id) {
            <div class="order-card" [class]="getStatusClass(order.status)">
              <!-- Card Header: Status + Mesa + Tempo -->
              <div class="order-header">
                <div class="status-info">
                  <span class="status-badge" [class]="'badge-' + order.status">
                    {{ getStatusLabel(order.status) }}
                  </span>
                  <span
                    class="elapsed-time"
                    [class.warning]="getElapsedTime(order.createdAt).includes('h')"
                  >
                    ‚è±Ô∏è {{ getElapsedTime(order.createdAt) }}
                  </span>
                </div>
                <div class="table-info">
                  <span class="table-number">üçΩÔ∏è Mesa {{ order.tableNumber }}</span>
                  <span class="order-time">{{ getElapsedTime(order.createdAt) }}</span>
                </div>
              </div>

              <!-- Card Body: Cliente + Itens -->
              <div class="order-body">
                <div class="client-info">
                  @if (!order.isClientAnonymous) {
                    <span class="client-icon">üë§</span>
                  }

                  <div class="client-name-wrapper">
                    @if (editingNameOrderId === order.id) {
                      <input type="text" [(ngModel)]="editingNameValue" class="inline-name-input" />
                      <div class="edit-actions">
                        <button class="icon-btn save" (click)="saveEditName(order)" title="Salvar">
                          ‚úîÔ∏è
                        </button>
                        <button class="icon-btn cancel" (click)="cancelEditName()" title="Cancelar">
                          ‚úñÔ∏è
                        </button>
                      </div>
                    } @else {
                      <span class="client-name-text">{{ order.clientName || 'Cliente' }}</span>
                    }

                    @if (order.isClientAnonymous && canEdit(order)) {
                      <button
                        class="client-icon editable right"
                        (click)="startEditName(order)"
                        title="Editar nome do cliente"
                      >
                        ‚úèÔ∏è
                      </button>
                    }
                    @if (!order.isClientAnonymous) {
                      <span class="client-icon">üë§</span>
                    }
                  </div>
                </div>

                <div class="order-items">
                  <h4 class="items-title">Itens:</h4>
                  <ul class="items-list">
                    @for (item of order.items; track i; let i = $index) {
                      <li class="item">
                        <div class="item-main">
                          <span class="item-quantity">{{ item.quantity }}x</span>
                          <span class="item-name">{{ item.productName }}</span>
                          <span class="item-price">{{ formatCurrency(item.totalPrice) }}</span>
                        </div>
                        @if (item.notes) {
                          <div class="item-notes">üìù {{ item.notes }}</div>
                        }
                      </li>
                    }
                  </ul>
                </div>
              </div>

              <!-- Card Footer -->
              <div class="order-footer">
                <div class="order-total">
                  <span class="total-label">Total:</span>
                  <span class="total-value">{{ formatCurrency(order.totalAmount) }}</span>
                </div>

                @if (canDeliver(order)) {
                  <button
                    class="action-btn btn-deliver"
                    (click)="deliverOrder(order)"
                    title="Marcar como entregue"
                  >
                    ‚úÖ Entregar
                  </button>
                }

                <div class="order-actions">
                  @if (canEdit(order)) {
                    <button
                      class="action-btn btn-edit"
                      (click)="openEditModal(order)"
                      title="Editar pedido"
                    >
                      ‚úèÔ∏è Editar
                    </button>
                  }

                  <button
                    class="action-btn btn-cancel"
                    (click)="cancelOrder(order)"
                    title="Cancelar pedido"
                  >
                    ‚ùå Cancelar
                  </button>

                  @if (canEdit(order)) {
                    <button
                      class="action-btn btn-rename"
                      (click)="renameAnonymousClient(order)"
                      title="Renomear cliente"
                    >
                      üë• Renomear
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- History Section -->
      @if (historyOrders.length > 0) {
        <div class="history-section">
          <div class="section-header">
            <h2>üìú Hist√≥rico</h2>
            <button class="toggle-history-btn" (click)="showHistory = !showHistory">
              {{ showHistory ? '‚ñº Ocultar' : '‚ñ∂ Mostrar' }}
            </button>
          </div>

          @if (showHistory) {
            <div class="orders-grid">
              @for (order of historyOrders; track order.id) {
                <div class="order-card history-card" [class]="getStatusClass(order.status)">
                  <div class="order-header">
                    <div class="status-info">
                      <span class="status-badge" [class]="'badge-' + order.status">
                        {{ getStatusLabel(order.status) }}
                      </span>
                    </div>
                    <div class="table-info">
                      <span class="table-number">Mesa {{ order.tableNumber }}</span>
                      <span class="order-time">{{ getElapsedTime(order.createdAt) }}</span>
                    </div>
                  </div>

                  <div class="order-body">
                    <div class="client-info">
                      <span class="client-icon">üë§</span>
                      <span class="client-name">{{ order.clientName || 'Cliente' }}</span>
                    </div>
                    <div class="order-summary">
                      <span>{{ order.items.length }} item(ns)</span>
                      <span class="total-value">{{ formatCurrency(order.totalAmount) }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Modal de Edi√ß√£o -->
@if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Pedido</h2>
        <button class="close-btn" (click)="closeEditModal()">‚úï</button>
      </div>

      @if (editingOrder) {
        <div class="modal-body">
          <div class="order-info">
            <div class="info-item"><strong>Mesa:</strong> {{ editingOrder.tableNumber }}</div>
            <div class="info-item"><strong>Cliente:</strong> {{ editingOrder.clientName }}</div>
            <div class="info-item">
              <strong>Status:</strong>
              <span class="status-badge" [class]="'badge-' + editingOrder.status">
                {{ getStatusLabel(editingOrder.status) }}
              </span>
            </div>
          </div>

          <div class="items-section">
            <h3>Itens do Pedido</h3>
            <div class="edit-items-list">
              @for (item of editingItems; track i; let i = $index) {
                <div class="edit-item">
                  <div class="item-info">
                    <span class="item-name">{{ item.productName }}</span>
                    <span class="item-unit-price">{{ formatCurrency(item.unitPrice) }}/un</span>
                  </div>

                  <div class="item-controls">
                    <div class="quantity-control">
                      <button
                        class="qty-btn"
                        (click)="updateItemQuantity(i, item.quantity - 1)"
                        [disabled]="item.quantity <= 1"
                      >
                        ‚àí
                      </button>
                      <input
                        type="number"
                        [(ngModel)]="item.quantity"
                        (change)="updateItemQuantity(i, item.quantity)"
                        min="1"
                        class="qty-input"
                      />
                      <button class="qty-btn" (click)="updateItemQuantity(i, item.quantity + 1)">
                        +
                      </button>
                    </div>

                    <span class="item-total">{{ formatCurrency(item.totalPrice) }}</span>
                    <button class="remove-btn" (click)="removeItem(i)" title="Remover item">
                      üóëÔ∏è
                    </button>
                  </div>

                  @if (item.notes) {
                    <div class="item-notes-display">üìù {{ item.notes }}</div>
                  }
                </div>
              }
            </div>
          </div>

          <div class="modal-total">
            <span class="total-label">Total do Pedido:</span>
            <span class="total-value">{{ formatCurrency(getEditingTotal()) }}</span>
          </div>
        </div>
      }

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveOrderChanges()">üíæ Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>
}

<!-- New Order Modal -->
@if (showNewOrderModal) {
  <app-new-order-modal (close)="handleCloseNewOrderModal()" (orderCreated)="handleOrderCreated()" />
}
