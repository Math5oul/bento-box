<app-admin-header></app-admin-header>

<div class="waiter-dashboard">
  <div class="page-title">
    <h1>üßë‚Äçüç≥ Painel do Gar√ßom</h1>
    <p class="subtitle">Gest√£o de Pedidos e Mesas</p>
  </div>

  <!-- Tabs -->
  <app-waiter-tabs
    [activeTab]="activeTab"
    (activeTabChange)="activeTab = $event; showReadyOnly = $event === 'deliver'"
  ></app-waiter-tabs>

  <!-- Filters Bar  -->
  @if (activeTab === 'tables') {
    <app-waiter-filters
      [tables]="tables"
      [tablesMap]="tablesMap"
      [statuses]="statuses"
      [filterTable]="filterTable"
      [filterStatus]="filterStatus"
      [searchTerm]="searchTerm"
      (filterTableChange)="filterTable = $event"
      (filterStatusChange)="filterStatus = $event"
      (searchTermChange)="searchTerm = $event"
      (filtersApplied)="applyFilters()"
    ></app-waiter-filters>
  }

  <!-- tabs  -->
  <div class="section-header">
    @if (activeTab === 'deliver') {
      <h2>Itens para Entrega</h2>
    } @else {
      <h2>üçΩÔ∏è Pedidos Ativos</h2>
    }
    <button class="new-order-btn" (click)="createNewOrder()">Novo Pedido</button>
  </div>

  <!-- Loading & Error States -->
  @if (loading) {
    <div class="loading">‚è≥ Carregando pedidos...</div>
  } @else if (error) {
    <div class="error-message">‚ùå {{ error }}</div>
  } @else {
    <!-- Orders Container -->
    <!-- Tab Entregas -->
    @if (activeTab === 'deliver') {
      <app-ready-items-panel
        [readyViewItems]="readyViewItems"
        [tablesMap]="tablesMap"
        [canDeliverOrders]="canDeliverOrders"
        (deliverItem)="deliverSingleItem($event.orderId, $event.item)"
      ></app-ready-items-panel>
    }
    @if (activeTab === 'deliver') {
      <div class="deliver-separator" aria-hidden="true"></div>
    }
    <app-order-list
      [orders]="filteredOrders"
      [tablesMap]="tablesMap"
      [canManageOrders]="canManageOrders"
      [canCancelOrders]="canCancelOrders"
      [canDeliverOrders]="canDeliverOrders"
      [editingNameOrderId]="editingNameOrderId"
      [editingNameValue]="editingNameValue"
      [filterStatus]="filterStatus"
      [filterTable]="filterTable"
      [searchTerm]="searchTerm"
      (editTable)="openEditTableModal($event)"
      (startEditName)="startEditName($event)"
      (saveEditName)="saveEditName($event)"
      (cancelEditName)="cancelEditName()"
      (updateItemStatus)="updateItemStatus($event.order, $event.item, $event.status)"
      (openEditModal)="openEditModal($event)"
      (cancelOrder)="cancelOrder($event)"
    ></app-order-list>

    <!-- History Section -->
    @if (historyOrders.length > 0 && activeTab === 'tables') {
      <div class="history-section">
        <div class="section-header">
          <h2>üìú Hist√≥rico</h2>
          <button class="toggle-history-btn" (click)="showHistory = !showHistory">
            {{ showHistory ? '‚ñº Ocultar' : '‚ñ∂ Mostrar' }}
          </button>
        </div>

        @if (showHistory) {
          <div class="orders-grid">
            @for (order of historyOrders; track order.id) {
              <div class="order-card history-card" [class]="getStatusClass(order.status)">
                <div class="order-header">
                  <div class="status-info">
                    <span class="status-badge" [class]="'badge-' + order.status">
                      {{ getStatusLabel(order.status) }}
                    </span>
                  </div>
                  <div class="table-info">
                    <span class="table-number">{{ getTableDisplayName(order.tableNumber) }}</span>
                    <span class="order-time">{{ getElapsedTime(order.createdAt) }}</span>
                  </div>
                </div>

                <div class="order-body">
                  <div class="client-info">
                    <span class="client-icon">üë§</span>
                    <span class="client-name">{{ order.clientName || 'Cliente' }}</span>
                  </div>
                  <div class="order-summary">
                    <span>{{ order.items.length }} item(ns)</span>
                    <span class="total-value">{{ formatCurrency(order.totalAmount) }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  }
</div>

<!-- Modal de Edi√ß√£o - Atualizado com campo de notas -->
@if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Pedido</h2>
        <button class="close-btn" (click)="closeEditModal()">‚úï</button>
      </div>

      @if (editingOrder) {
        <div class="modal-body">
          <div class="order-info">
            <div class="info-item"><strong>Mesa:</strong> {{ editingOrder.tableNumber }}</div>
            <div class="info-item"><strong>Cliente:</strong> {{ editingOrder.clientName }}</div>
            <div class="info-item">
              <strong>Status:</strong>
              <span class="status-badge" [class]="'badge-' + editingOrder.status">
                {{ getStatusLabel(editingOrder.status) }}
              </span>
            </div>
          </div>

          <div class="items-section">
            <h3>Itens do Pedido</h3>
            <div class="edit-items-list">
              @for (item of editingItems; track i; let i = $index) {
                <div class="edit-item">
                  <div class="item-info">
                    <span class="item-name">{{ item.productName }}</span>
                    <span class="item-unit-price">{{ formatCurrency(item.unitPrice) }}/un</span>
                  </div>

                  <div class="item-controls">
                    <div class="quantity-control">
                      <button
                        class="qty-btn"
                        (click)="updateItemQuantity(i, item.quantity - 1)"
                        [disabled]="item.quantity <= 1"
                      >
                        ‚àí
                      </button>
                      <input
                        type="number"
                        [(ngModel)]="item.quantity"
                        (change)="updateItemQuantity(i, item.quantity)"
                        min="1"
                        class="qty-input"
                      />
                      <button class="qty-btn" (click)="updateItemQuantity(i, item.quantity + 1)">
                        +
                      </button>
                    </div>

                    <!-- Dropdown de tamanho -->
                    @if (productOptions[i]?.sizes?.length) {
                      <div class="dropdown-control">
                        <label for="size-{{ i }}">Tamanho:</label>
                        <select
                          id="size-{{ i }}"
                          [(ngModel)]="item.selectedSize"
                          (change)="onSizeOrVariationChange(i)"
                        >
                          <option [ngValue]="undefined">Nenhum</option>
                          @for (size of productOptions[i].sizes; track size.abbreviation) {
                            <option [ngValue]="size">
                              {{ size.name }} ({{ size.abbreviation }}) -
                              {{ formatCurrency(size.price) }}
                            </option>
                          }
                        </select>
                      </div>
                    }

                    <!-- Dropdown de varia√ß√£o -->
                    @if (productOptions[i]?.variations?.length) {
                      <div class="dropdown-control">
                        <label for="variation-{{ i }}">Varia√ß√£o:</label>
                        <select
                          id="variation-{{ i }}"
                          [(ngModel)]="item.selectedVariation"
                          (change)="onSizeOrVariationChange(i)"
                        >
                          <option [ngValue]="undefined">Nenhuma</option>
                          @for (variation of productOptions[i].variations; track variation.title) {
                            <option [ngValue]="variation">
                              {{ variation.title }} - {{ formatCurrency(variation.price) }}
                            </option>
                          }
                        </select>
                      </div>
                    }

                    <span class="item-total">{{ formatCurrency(item.totalPrice) }}</span>
                    <button class="remove-btn" (click)="removeItem(i)" title="Remover item">
                      üóëÔ∏è
                    </button>
                  </div>

                  <!-- Campo de notas -->
                  <div class="notes-control">
                    <label for="notes-{{ i }}">Observa√ß√µes:</label>
                    <textarea
                      id="notes-{{ i }}"
                      [(ngModel)]="item.notes"
                      placeholder="Alguma observa√ß√£o sobre o item..."
                      class="notes-textarea"
                      rows="2"
                    ></textarea>
                  </div>

                  @if (item.notes) {
                    <div class="item-notes-display">üìù {{ item.notes }}</div>
                  }
                </div>
              }
            </div>
          </div>

          <div class="modal-total">
            <span class="total-label">Total do Pedido:</span>
            <span class="total-value">{{ formatCurrency(getEditingTotal()) }}</span>
          </div>
        </div>
      }

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveOrderChanges()">üíæ Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>
}

<!-- New Order Modal -->
@if (showNewOrderModal) {
  <app-new-order-modal (close)="handleCloseNewOrderModal()" (orderCreated)="handleOrderCreated()" />
}

<!-- Edit Table Modal -->
@if (showEditTableModal && selectedTableForEdit) {
  <app-edit-table-modal
    [table]="selectedTableForEdit"
    (close)="closeEditTableModal()"
    (save)="handleSaveTable($event)"
  />
}
