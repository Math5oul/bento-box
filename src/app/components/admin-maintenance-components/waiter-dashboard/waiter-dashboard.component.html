<app-admin-header></app-admin-header>

<div class="waiter-dashboard">
  <div class="page-title">
    <h1>üßë‚Äçüç≥ Painel do Gar√ßom</h1>
    <p class="subtitle">Gest√£o de Pedidos e Mesas</p>
  </div>

  <!-- Filters Bar -->
  <!-- Tabs -->
  <div class="tabs-bar">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'deliver'"
      (click)="activeTab = 'deliver'; showReadyOnly = true"
    >
      Entregas
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'tables'"
      (click)="activeTab = 'tables'; showReadyOnly = false"
    >
      Mesas
    </button>
  </div>

  <!-- Filters Bar  -->
  <div class="filters-bar" *ngIf="activeTab === 'tables'">
    <div class="filter-item">
      <label class="filter-label">Mesa:</label>
      <select [(ngModel)]="filterTable" (change)="applyFilters()" class="filter-select">
        <option value="all">Todas</option>
        @for (table of tables; track table) {
          <option [value]="table">Mesa {{ table }}</option>
        }
      </select>
    </div>

    <div class="filter-item">
      <label class="filter-label">Status:</label>
      <select [(ngModel)]="filterStatus" (change)="applyFilters()" class="filter-select">
        @for (s of statuses; track s.value) {
          <option [value]="s.value">{{ s.label }}</option>
        }
      </select>
    </div>

    <div class="filter-item search-box">
      <label class="filter-label">Buscar:</label>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="Cliente ou mesa..."
        class="search-input"
      />
    </div>
  </div>

  <!-- tabs  -->
  <div class="section-header">
    @if (activeTab === 'deliver') {
      <h2>Itens para Entrega</h2>
    } @else {
      <h2>üçΩÔ∏è Pedidos Ativos</h2>
    }
    <button class="new-order-btn" (click)="createNewOrder()">Novo Pedido</button>
  </div>

  <!-- Loading & Error States -->
  @if (loading) {
    <div class="loading">‚è≥ Carregando pedidos...</div>
  } @else if (error) {
    <div class="error-message">‚ùå {{ error }}</div>
  } @else {
    <!-- Orders Container -->
    <!-- Tab Entregas -->
    @if (activeTab === 'deliver') {
      <div class="ready-panel">
        @if (readyViewItems.length === 0) {
          <div class="empty-state">
            <h3>Nenhum item pronto no momento</h3>
            <p class="empty-hint">Aguarde a cozinha preparar os itens.</p>
          </div>
        } @else {
          <div class="ready-items-list">
            @for (rv of readyViewItems; track i; let i = $index) {
              <div class="ready-item">
                <div class="ready-item-info">
                  <div class="ready-item-meta">
                    <div class="ready-item-table">Mesa {{ rv.tableNumber }}</div>
                  </div>
                  <div class="ready-item-name">
                    <span class="ready-item-quantity">{{ rv.item.quantity }}x </span>
                    <span class="ready-item-product">{{ rv.item.productName }}</span>
                  </div>
                </div>
                <div class="ready-item-actions">
                  <div class="ready-item-client-right">{{ rv.clientName || 'Cliente' }}</div>
                  <button
                    class="action-btn btn-deliver"
                    (click)="deliverSingleItem(rv.orderId, rv.item)"
                  >
                    Entregar
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
    @if (activeTab === 'deliver') {
      <div class="deliver-separator" aria-hidden="true"></div>
    }
    <div class="orders-container">
      @if (filteredOrders.length === 0) {
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <h3>Nenhum pedido ativo</h3>
          <p class="empty-hint">
            {{
              filterStatus !== 'all' || filterTable !== 'all' || searchTerm
                ? 'Nenhum pedido encontrado com os filtros aplicados.'
                : 'Aguarde novos pedidos ou crie um novo.'
            }}
          </p>
        </div>
      } @else {
        <!-- Orders Grid -->
        <div class="orders-grid">
          @for (order of filteredOrders; track order.id) {
            <div class="order-card" [class]="getStatusClass(order.status)">
              <!-- Card Header: Status + Mesa + Tempo -->
              <div class="order-header">
                <div class="status-info">
                  <span class="status-badge" [class]="'badge-' + order.status">
                    {{ getStatusLabel(order.status) }}
                  </span>
                  <span
                    class="elapsed-time"
                    [class.warning]="getElapsedTime(order.createdAt).includes('h')"
                  >
                    ‚è±Ô∏è {{ getElapsedTime(order.createdAt) }}
                  </span>
                </div>
                <div class="table-info">
                  <span class="table-number">üçΩÔ∏è Mesa {{ order.tableNumber }}</span>
                  <span class="order-time">{{ getElapsedTime(order.createdAt) }}</span>
                </div>
              </div>

              <!-- Card Body: Cliente + Itens -->
              <div class="order-body">
                <div class="client-info">
                  @if (!order.isClientAnonymous) {
                    <span class="client-icon">üë§</span>
                  }

                  <div class="client-name-wrapper">
                    @if (editingNameOrderId === order.id) {
                      <input type="text" [(ngModel)]="editingNameValue" class="inline-name-input" />
                      <div class="edit-actions">
                        <button class="icon-btn save" (click)="saveEditName(order)" title="Salvar">
                          ‚úîÔ∏è
                        </button>
                        <button class="icon-btn cancel" (click)="cancelEditName()" title="Cancelar">
                          ‚úñÔ∏è
                        </button>
                      </div>
                    } @else {
                      <span class="client-name-text">{{ order.clientName || 'Cliente' }}</span>
                    }

                    @if (order.isClientAnonymous && canEdit(order)) {
                      <button
                        class="client-icon editable right"
                        (click)="startEditName(order)"
                        title="Editar nome do cliente"
                      >
                        ‚úèÔ∏è
                      </button>
                    }
                    @if (!order.isClientAnonymous) {
                      <span class="client-icon">üë§</span>
                    }
                  </div>
                </div>

                <div class="order-items">
                  <h4 class="items-title">Itens:</h4>
                  <ul class="items-list">
                    @for (item of order.items; track i; let i = $index) {
                      <li class="item">
                        <div class="item-main">
                          <span class="item-quantity">{{ item.quantity }}x</span>
                          <span class="item-name">{{ item.productName }}</span>
                          <span class="item-price">{{ formatCurrency(item.totalPrice) }}</span>
                        </div>
                        @if (item.notes) {
                          <div class="item-notes">üìù {{ item.notes }}</div>
                        }
                        @if (item.selectedSize) {
                          <div class="item-size">üîπ {{ item.selectedSize.abbreviation }}</div>
                        }
                        @if (item.selectedVariation) {
                          <div class="item-variation">üî∏ {{ item.selectedVariation.title }}</div>
                        }
                        <div class="item-actions">
                          @if ((item.status || 'pending') === 'ready') {
                            <span class="ready-pill">Pronto para entrega</span>
                            <button
                              class="action-btn btn-deliver"
                              (click)="updateItemStatus(order, item, 'delivered')"
                              title="Marcar item como entregue"
                            >
                              Entregar item
                            </button>
                          } @else if ((item.status || 'pending') === 'delivered') {
                            <span class="delivered-pill">Entregue</span>
                          }
                        </div>
                      </li>
                    }
                  </ul>
                </div>
              </div>

              <!-- Card Footer -->
              <div class="order-footer">
                <div class="order-total">
                  <span class="total-label">Total:</span>
                  <span class="total-value">{{ formatCurrency(order.totalAmount) }}</span>
                </div>

                <div class="order-actions">
                  @if (canEdit(order)) {
                    <button
                      class="action-btn btn-edit"
                      (click)="openEditModal(order)"
                      title="Editar pedido"
                    >
                      ‚úèÔ∏è Editar pedido
                    </button>
                  }

                  <button
                    class="action-btn btn-cancel"
                    (click)="cancelOrder(order)"
                    title="Cancelar pedido"
                  >
                    ‚ùå Cancelar
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- History Section -->
      @if (historyOrders.length > 0 && activeTab === 'tables') {
        <div class="history-section">
          <div class="section-header">
            <h2>üìú Hist√≥rico</h2>
            <button class="toggle-history-btn" (click)="showHistory = !showHistory">
              {{ showHistory ? '‚ñº Ocultar' : '‚ñ∂ Mostrar' }}
            </button>
          </div>

          @if (showHistory) {
            <div class="orders-grid">
              @for (order of historyOrders; track order.id) {
                <div class="order-card history-card" [class]="getStatusClass(order.status)">
                  <div class="order-header">
                    <div class="status-info">
                      <span class="status-badge" [class]="'badge-' + order.status">
                        {{ getStatusLabel(order.status) }}
                      </span>
                    </div>
                    <div class="table-info">
                      <span class="table-number">Mesa {{ order.tableNumber }}</span>
                      <span class="order-time">{{ getElapsedTime(order.createdAt) }}</span>
                    </div>
                  </div>

                  <div class="order-body">
                    <div class="client-info">
                      <span class="client-icon">üë§</span>
                      <span class="client-name">{{ order.clientName || 'Cliente' }}</span>
                    </div>
                    <div class="order-summary">
                      <span>{{ order.items.length }} item(ns)</span>
                      <span class="total-value">{{ formatCurrency(order.totalAmount) }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Modal de Edi√ß√£o - Atualizado com campo de notas -->
@if (showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Pedido</h2>
        <button class="close-btn" (click)="closeEditModal()">‚úï</button>
      </div>

      @if (editingOrder) {
        <div class="modal-body">
          <div class="order-info">
            <div class="info-item"><strong>Mesa:</strong> {{ editingOrder.tableNumber }}</div>
            <div class="info-item"><strong>Cliente:</strong> {{ editingOrder.clientName }}</div>
            <div class="info-item">
              <strong>Status:</strong>
              <span class="status-badge" [class]="'badge-' + editingOrder.status">
                {{ getStatusLabel(editingOrder.status) }}
              </span>
            </div>
          </div>

          <div class="items-section">
            <h3>Itens do Pedido</h3>
            <div class="edit-items-list">
              @for (item of editingItems; track i; let i = $index) {
                <div class="edit-item">
                  <div class="item-info">
                    <span class="item-name">{{ item.productName }}</span>
                    <span class="item-unit-price">{{ formatCurrency(item.unitPrice) }}/un</span>
                  </div>

                  <div class="item-controls">
                    <div class="quantity-control">
                      <button
                        class="qty-btn"
                        (click)="updateItemQuantity(i, item.quantity - 1)"
                        [disabled]="item.quantity <= 1"
                      >
                        ‚àí
                      </button>
                      <input
                        type="number"
                        [(ngModel)]="item.quantity"
                        (change)="updateItemQuantity(i, item.quantity)"
                        min="1"
                        class="qty-input"
                      />
                      <button class="qty-btn" (click)="updateItemQuantity(i, item.quantity + 1)">
                        +
                      </button>
                    </div>

                    <!-- Dropdown de tamanho -->
                    @if (productOptions[i]?.sizes?.length) {
                      <div class="dropdown-control">
                        <label for="size-{{ i }}">Tamanho:</label>
                        <select
                          id="size-{{ i }}"
                          [(ngModel)]="item.selectedSize"
                          (change)="onSizeOrVariationChange(i)"
                        >
                          <option [ngValue]="undefined">Nenhum</option>
                          @for (size of productOptions[i].sizes; track size.abbreviation) {
                            <option [ngValue]="size">
                              {{ size.name }} ({{ size.abbreviation }}) -
                              {{ formatCurrency(size.price) }}
                            </option>
                          }
                        </select>
                      </div>
                    }

                    <!-- Dropdown de varia√ß√£o -->
                    @if (productOptions[i]?.variations?.length) {
                      <div class="dropdown-control">
                        <label for="variation-{{ i }}">Varia√ß√£o:</label>
                        <select
                          id="variation-{{ i }}"
                          [(ngModel)]="item.selectedVariation"
                          (change)="onSizeOrVariationChange(i)"
                        >
                          <option [ngValue]="undefined">Nenhuma</option>
                          @for (variation of productOptions[i].variations; track variation.title) {
                            <option [ngValue]="variation">
                              {{ variation.title }} - {{ formatCurrency(variation.price) }}
                            </option>
                          }
                        </select>
                      </div>
                    }

                    <span class="item-total">{{ formatCurrency(item.totalPrice) }}</span>
                    <button class="remove-btn" (click)="removeItem(i)" title="Remover item">
                      üóëÔ∏è
                    </button>
                  </div>

                  <!-- Campo de notas -->
                  <div class="notes-control">
                    <label for="notes-{{ i }}">Observa√ß√µes:</label>
                    <textarea
                      id="notes-{{ i }}"
                      [(ngModel)]="item.notes"
                      placeholder="Alguma observa√ß√£o sobre o item..."
                      class="notes-textarea"
                      rows="2"
                    ></textarea>
                  </div>

                  @if (item.notes) {
                    <div class="item-notes-display">üìù {{ item.notes }}</div>
                  }
                </div>
              }
            </div>
          </div>

          <div class="modal-total">
            <span class="total-label">Total do Pedido:</span>
            <span class="total-value">{{ formatCurrency(getEditingTotal()) }}</span>
          </div>
        </div>
      }

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeEditModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveOrderChanges()">üíæ Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>
}

<!-- New Order Modal -->
@if (showNewOrderModal) {
  <app-new-order-modal (close)="handleCloseNewOrderModal()" (orderCreated)="handleOrderCreated()" />
}
