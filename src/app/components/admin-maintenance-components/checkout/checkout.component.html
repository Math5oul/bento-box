<app-admin-header></app-admin-header>

<div class="checkout-container">
  @if (loading) {
    <div class="loading-state">
      <p>‚è≥ Carregando...</p>
    </div>
  }

  @if (!loading && step === 'select-table') {
    <div class="step-container">
      <div class="page-header">
        <h1>üí≥ Checkout - Selecione a Mesa</h1>
        <p class="subtitle">Escolha qual mesa deseja processar o pagamento</p>
      </div>

      <div class="tables-grid">
        @for (table of tables; track $index) {
          <div
            class="table-card"
            [class.available]="table.status === 'available'"
            [class.occupied]="table.status === 'occupied'"
            [class.closed]="table.status === 'closed'"
            (click)="table.status !== 'available' && selectTable(table)"
          >
            <div class="table-number">Mesa {{ table.number }}</div>
            <div class="table-capacity">üë• {{ table.capacity }} pessoas</div>
            <div class="table-status">{{ table.status }}</div>
          </div>
        }
      </div>
    </div>
  }

  @if (!loading && step === 'select-items') {
    <div class="step-container">
      <div class="page-header">
        <h1>Selecione os Itens</h1>
        <p class="subtitle">Mesa {{ selectedTable?.number }} - Marque os itens que ser√£o pagos</p>

        <div class="header-actions">
          <button class="btn-secondary" (click)="changeTable()">üîÑ Trocar Mesa</button>
          <button class="btn-secondary" (click)="openHistoryModal()">üìú Ver Hist√≥rico</button>
          <button class="btn-secondary btn-clear" (click)="clearTable()">üßπ Limpar Mesa</button>
        </div>
      </div>

      <div class="selection-controls">
        <button class="btn-small" (click)="selectAllItems()">‚úÖ Selecionar Todos</button>
        <button class="btn-small" (click)="deselectAllItems()">‚ùå Desmarcar Todos</button>
        <span class="selected-count">{{ selectedItems.length }} item(ns) selecionado(s)</span>
      </div>

      <div class="client-groups">
        @for (group of clientGroups; track $index) {
          <div class="client-group">
            <div class="client-group-header">
              <label class="client-group-checkbox">
                <input
                  type="checkbox"
                  [checked]="group.allSelected"
                  (change)="toggleClientGroup(group)"
                />

                <h3 class="client-name">
                  üë§ {{ group.clientName }}
                  @if (group.customRoleName) {
                    <span class="custom-role-badge">{{ group.customRoleName }}</span>
                  }
                  <span class="client-item-count">
                    {{ group.items.length }} item{{ group.items.length !== 1 ? 's' : '' }}

                    @if (group.orderCount && group.orderCount > 1) {
                      <span class="order-count">‚Ä¢ {{ group.orderCount }} pedidos</span>
                    }
                  </span>
                </h3>
              </label>
            </div>

            <div class="items-list">
              @for (item of group.items; track $index) {
                <div
                  class="item-card"
                  [class.selected]="item.selected"
                  [class.subitem]="item.isSplit"
                >
                  <label class="item-checkbox">
                    <input
                      type="checkbox"
                      [checked]="item.selected"
                      (change)="toggleItemSelection(item)"
                    />

                    <div class="item-details">
                      <h4 class="item-name">
                        {{ item.productName }}

                        @if (item.isSplit) {
                          <span class="split-badge"
                            >‚úÇÔ∏è {{ item.splitIndex }}/{{ item.totalSplits }}</span
                          >
                        }
                      </h4>

                      <p class="item-info">
                        Qtd: {{ item.quantity }}

                        @if (item.isSplit && item.totalSplits) {
                          <span class="split-info">
                            ({{ (item.quantity * item.totalSplits).toFixed(2) }} √∑
                            {{ item.totalSplits }})
                          </span>
                        }
                      </p>

                      @if (!item.isSplit) {
                        <p class="item-price">
                          Subtotal: R$ {{ item.subtotal.toFixed(2) }}

                          @if (item.discount) {
                            <span class="discount-badge">
                              -{{
                                item.discount.type === 'percentage'
                                  ? item.discount.value + '%'
                                  : 'R$ ' + item.discount.value.toFixed(2)
                              }}
                            </span>
                          }
                        </p>
                      }

                      <p class="item-final">
                        <strong>Valor: R$ {{ item.finalPrice.toFixed(2) }}</strong>
                      </p>
                    </div>
                  </label>

                  <div class="item-actions">
                    @if (!item.isSplit) {
                      <button class="btn-icon" (click)="openSplitModal(item)" title="Dividir item">
                        ‚úÇÔ∏è
                      </button>
                      <button
                        class="btn-icon"
                        (click)="openDiscountModal(item)"
                        title="Aplicar desconto"
                      >
                        üí∞
                      </button>
                      <button class="btn-icon" (click)="openPriceModal(item)" title="Editar pre√ßo">
                        ‚úèÔ∏è
                      </button>

                      @if (item.discount && !item.isSplit) {
                        <button
                          class="btn-icon remove"
                          (click)="removeDiscount(item)"
                          title="Remover desconto"
                        >
                          üóëÔ∏è
                        </button>
                      }
                    }

                    @if (item.isSplit) {
                      <button
                        class="btn-icon undo"
                        (click)="undoSplit(item)"
                        title="Desfazer divis√£o"
                      >
                        ‚ü≤
                      </button>

                      @if (item.parentDiscount) {
                        <span class="parent-discount-badge">üí∞ Desconto herdado</span>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <div class="summary-card">
        <h3>Resumo</h3>

        <div class="summary-line">
          <span>Subtotal:</span>
          <span>R$ {{ subtotal.toFixed(2) }}</span>
        </div>

        @if (totalDiscount > 0) {
          <div class="summary-line discount">
            <span>Descontos:</span>
            <span>-R$ {{ totalDiscount.toFixed(2) }}</span>
          </div>
        }

        <div class="summary-line total">
          <span><strong>Total:</strong></span>
          <span
            ><strong>R$ {{ total.toFixed(2) }}</strong></span
          >
        </div>

        <button
          class="btn-primary btn-block"
          [disabled]="!hasSelectedItems"
          (click)="goToPayment()"
        >
          Continuar para Pagamento
        </button>
      </div>
    </div>
  }

  @if (!loading && step === 'payment') {
    <div class="step-container">
      <div class="page-header">
        <h1>üí≥ Finalizar Pagamento</h1>
        <p class="subtitle">Mesa {{ selectedTable?.number }} - Confirme os dados</p>
        <button class="btn-secondary" (click)="backToItems()">‚¨ÖÔ∏è Voltar</button>
      </div>

      <div class="payment-review">
        <h3>Itens Selecionados</h3>

        <ul class="review-list">
          @for (item of selectedItems; track $index) {
            <li>
              <span class="review-name">{{ item.productName }} (x{{ item.quantity }})</span>
              <span class="review-price">R$ {{ item.finalPrice.toFixed(2) }}</span>
            </li>
          }
        </ul>
      </div>

      <div class="payment-mode-selector">
        <h3>üéØ Como deseja processar o pagamento?</h3>

        <div class="mode-grid">
          <label class="mode-card" [class.active]="paymentMode === 'manual'">
            <input type="radio" name="paymentMode" [(ngModel)]="paymentMode" value="manual" />
            <div class="mode-icon">üíµ</div>
            <div class="mode-title">Pagamento Manual</div>
            <div class="mode-desc">Dinheiro, cart√£o f√≠sico ou PIX manual</div>
          </label>

          @if (posEnabled) {
            <label class="mode-card" [class.active]="paymentMode === 'pos'">
              <input type="radio" name="paymentMode" [(ngModel)]="paymentMode" value="pos" />
              <div class="mode-icon">üñ•Ô∏è</div>
              <div class="mode-title">Maquininha (POS)</div>
              <div class="mode-desc">Cliente passa cart√£o ou paga PIX na maquininha</div>
            </label>
          }

          @if (paymentGatewayEnabled) {
            <label class="mode-card" [class.active]="paymentMode === 'online'">
              <input type="radio" name="paymentMode" [(ngModel)]="paymentMode" value="online" />
              <div class="mode-icon">üåê</div>
              <div class="mode-title">Pagamento Online</div>
              <div class="mode-desc">QR Code PIX ou link de pagamento</div>
            </label>
          }
        </div>
      </div>

      @if (paymentMode === 'manual') {
        <div class="payment-form">
          <h3>M√©todo de Pagamento</h3>

          <div class="payment-methods">
            <label class="payment-option">
              <input type="radio" [(ngModel)]="paymentMethod" value="cash" /> üíµ Dinheiro
            </label>

            <label class="payment-option">
              <input type="radio" [(ngModel)]="paymentMethod" value="credit_card" /> üí≥ Cr√©dito
            </label>

            <label class="payment-option">
              <input type="radio" [(ngModel)]="paymentMethod" value="debit_card" /> üí≥ D√©bito
            </label>

            <label class="payment-option">
              <input type="radio" [(ngModel)]="paymentMethod" value="pix" /> üì± PIX
            </label>
          </div>

          <div class="form-group">
            <label for="notes">Observa√ß√µes (opcional)</label>
            <textarea
              id="notes"
              rows="3"
              [(ngModel)]="paymentNotes"
              placeholder="Ex: Gorjeta adicionada..."
            ></textarea>
          </div>
        </div>
      }

      @if (paymentMode === 'pos') {
        <div class="payment-form">
          <h3>Tipo de Pagamento na Maquininha</h3>

          <div class="payment-methods">
            <label class="payment-option">
              <input type="radio" [(ngModel)]="posPaymentType" value="credit" /> üí≥ Cr√©dito
            </label>

            <label class="payment-option">
              <input type="radio" [(ngModel)]="posPaymentType" value="debit" /> üí≥ D√©bito
            </label>

            <label class="payment-option">
              <input type="radio" [(ngModel)]="posPaymentType" value="pix" /> üì± PIX
            </label>
          </div>

          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Como funciona:</strong>
            <ol>
              <li>Clique em "Enviar para Maquininha"</li>
              <li>Cliente paga na maquininha</li>
              <li>Aguarde a confirma√ß√£o autom√°tica</li>
            </ol>
          </div>
        </div>
      }

      @if (paymentMode === 'online') {
        <div class="payment-form">
          <h3>M√©todo de Pagamento Online</h3>

          <div class="alert alert-info">
            <strong>üöß Em desenvolvimento</strong>
            Pagamento online ser√° implementado.
          </div>
        </div>
      }

      <div class="summary-card">
        <h3>Total a Pagar</h3>

        <div class="summary-line total-large">
          <span><strong>TOTAL:</strong></span>
          <span
            ><strong>R$ {{ total.toFixed(2) }}</strong></span
          >
        </div>

        @if (paymentMode === 'manual') {
          <button class="btn-success btn-block" (click)="processPayment()" [disabled]="loading">
            @if (!loading) {
              ‚úÖ Confirmar Pagamento
            } @else {
              ‚è≥ Processando...
            }
          </button>
        }

        @if (paymentMode === 'pos') {
          <button class="btn-primary btn-block" (click)="sendToPOS()" [disabled]="sendingToPOS">
            @if (!sendingToPOS) {
              üñ•Ô∏è Enviar para Maquininha
            } @else {
              ‚è≥ Aguardando pagamento...
            }
          </button>
        }

        @if (paymentMode === 'online') {
          <button class="btn-success btn-block" disabled title="Em desenvolvimento">
            üåê Gerar Pagamento Online (Em breve)
          </button>
        }
      </div>
    </div>
  }

  @if (showSplitModal) {
    <div class="modal-overlay" (click)="closeSplitModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úÇÔ∏è Dividir Item</h3>
          <button class="btn-close" (click)="closeSplitModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <p>
            Item: <strong>{{ splitItem?.productName }}</strong>
          </p>
          <p>Quantidade atual: {{ splitItem?.quantity }} unidade(s)</p>

          <div class="form-group">
            <label for="splitQty">Dividir em quantas partes?</label>
            <input id="splitQty" type="number" [min]="2" [max]="99" [(ngModel)]="splitQuantity" />
          </div>

          @if (splitItem && splitQuantity) {
            <p class="help-text">
              Cada parte ter√° {{ (splitItem.quantity / splitQuantity).toFixed(2) }} unidade(s).
            </p>
          }
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeSplitModal()">Cancelar</button>
          <button class="btn-primary" (click)="confirmSplit()">Confirmar Divis√£o</button>
        </div>
      </div>
    </div>
  }

  @if (showDiscountModal) {
    <div class="modal-overlay" (click)="closeDiscountModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üí∞ Aplicar Desconto</h3>
          <button class="btn-close" (click)="closeDiscountModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          @if (discountItem) {
            <p>
              Item: <strong>{{ discountItem.productName }}</strong>
            </p>
            <p>Subtotal: R$ {{ discountItem.subtotal.toFixed(2) }}</p>
          }

          <div class="form-group">
            <label>Tipo de Desconto</label>
            <div class="discount-types">
              <label class="discount-type-option">
                <input type="radio" [(ngModel)]="discountType" value="percentage" /> Percentual (%)
              </label>
              <label class="discount-type-option">
                <input type="radio" [(ngModel)]="discountType" value="fixed" /> Valor Fixo (R$)
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="discountValue">Valor do Desconto</label>
            <input
              id="discountValue"
              type="number"
              [(ngModel)]="discountValue"
              [min]="0"
              [max]="
                discountType === 'percentage' ? 100 : discountItem ? discountItem.subtotal : 99999
              "
            />
          </div>

          <div class="form-group">
            <label for="discountDesc">Motivo (opcional)</label>
            <input
              id="discountDesc"
              type="text"
              [(ngModel)]="discountDescription"
              placeholder="Ex: cortesia..."
            />
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeDiscountModal()">Cancelar</button>
          <button class="btn-primary" (click)="confirmDiscount()">Aplicar Desconto</button>
        </div>
      </div>
    </div>
  }

  @if (showPriceModal) {
    <div class="modal-overlay" (click)="closePriceModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úèÔ∏è Editar Pre√ßo</h3>
          <button class="btn-close" (click)="closePriceModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          @if (priceEditItem) {
            <p>
              <strong>{{ priceEditItem.productName }}</strong>
            </p>
            <p>Pre√ßo atual: R$ {{ priceEditItem.unitPrice.toFixed(2) }}</p>
          }

          <div class="form-group">
            <label for="newPrice">Novo Pre√ßo</label>
            <input
              id="newPrice"
              type="number"
              [(ngModel)]="newPrice"
              [min]="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closePriceModal()">Cancelar</button>
          <button class="btn-primary" (click)="applyPriceEdit()">Salvar</button>
        </div>
      </div>
    </div>
  }

  @if (showHistoryModal) {
    <div class="modal-overlay" (click)="closeHistoryModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üìú Hist√≥rico de Pagamentos</h3>
          <button class="btn-close" (click)="closeHistoryModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <p>
            Mesa: <strong>{{ selectedTable?.number }}</strong>
          </p>
          <p>
            Total j√° pago: <strong>R$ {{ getTotalPaid().toFixed(2) }}</strong>
          </p>

          @if (billHistory.length === 0) {
            <div class="empty-note">Nenhum pagamento registrado ainda</div>
          }

          <ul class="history-list">
            @for (bill of billHistory; track $index) {
              <li class="history-item">
                <div class="history-header">
                  <span class="history-status" [class]="bill.status">{{ bill.status }}</span>
                  <span class="history-date">{{ bill.createdAt | date: 'short' }}</span>
                </div>
                <div class="history-details">
                  <p>{{ bill.items.length }} item(ns)</p>
                  <p class="history-amount">R$ {{ bill.finalTotal.toFixed(2) }}</p>
                  <p class="history-method">{{ bill.paymentMethod }}</p>
                </div>
              </li>
            }
          </ul>
        </div>

        <div class="modal-footer">
          <button class="btn-primary" (click)="closeHistoryModal()">Fechar</button>
        </div>
      </div>
    </div>
  }
</div>
