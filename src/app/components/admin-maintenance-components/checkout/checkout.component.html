<app-admin-header></app-admin-header>

<div class="checkout-container">
  @if (loading) {
    <div class="loading-state">
      <p>‚è≥ Carregando...</p>
    </div>
  }

  @if (!loading && step === 'select-table') {
    <app-table-selector
      [tables]="tables"
      (tableSelected)="selectTable($event)"
    ></app-table-selector>
  }

  @if (!loading && step === 'select-items') {
    <div class="step-container">
      <div class="page-header">
        <h1>Selecione os Itens</h1>
        <p class="subtitle">
          {{ selectedTable ? getTableDisplayName(selectedTable) : 'Mesa' }} - Marque os itens que
          ser√£o pagos
        </p>

        <div class="header-actions">
          <button class="btn-secondary" (click)="changeTable()">üîÑ Trocar Mesa</button>
          <button class="btn-secondary" (click)="openHistoryModal()">üìú Ver Hist√≥rico</button>
          <button class="btn-secondary btn-clear" (click)="clearTable()">üßπ Limpar Mesa</button>
        </div>
      </div>

      <div class="selection-controls">
        <button class="btn-small" (click)="selectAllItems()">‚úÖ Selecionar Todos</button>
        <button class="btn-small" (click)="deselectAllItems()">‚ùå Desmarcar Todos</button>
        <span class="selected-count">{{ selectedItems.length }} item(ns) selecionado(s)</span>
      </div>

      <div class="client-groups">
        @for (group of clientGroups; track $index) {
          <div class="client-group">
            <div class="client-group-header">
              <label class="client-group-checkbox">
                <input
                  type="checkbox"
                  [checked]="group.allSelected"
                  (change)="toggleClientGroup(group)"
                />

                <h3 class="client-name">
                  üë§ {{ group.clientName }}
                  @if (group.customRoleName) {
                    <span class="custom-role-badge">{{ group.customRoleName }}</span>
                  }
                  <span class="client-item-count">
                    {{ group.items.length }} item{{ group.items.length !== 1 ? 's' : '' }}

                    @if (group.orderCount && group.orderCount > 1) {
                      <span class="order-count">‚Ä¢ {{ group.orderCount }} pedidos</span>
                    }
                  </span>
                </h3>
              </label>
            </div>

            <div class="items-list">
              @for (item of group.items; track $index) {
                <div
                  class="item-card"
                  [class.selected]="item.selected"
                  [class.subitem]="item.isSplit"
                >
                  <label class="item-checkbox">
                    <input
                      type="checkbox"
                      [checked]="item.selected"
                      (change)="toggleItemSelection(item)"
                    />

                    <div class="item-details">
                      <h4 class="item-name">
                        {{ item.productName }}

                        @if (item.isSplit) {
                          <span class="split-badge"
                            >‚úÇÔ∏è {{ item.splitIndex }}/{{ item.totalSplits }}</span
                          >
                        }
                      </h4>

                      <p class="item-info">
                        Qtd: {{ item.quantity }}

                        @if (item.isSplit && item.totalSplits) {
                          <span class="split-info">
                            ({{ (item.quantity * item.totalSplits).toFixed(2) }} √∑
                            {{ item.totalSplits }})
                          </span>
                        }
                      </p>

                      @if (!item.isSplit) {
                        <p class="item-price">
                          Subtotal: R$ {{ item.subtotal.toFixed(2) }}

                          @if (item.discount) {
                            <span class="discount-badge">
                              -{{
                                item.discount.type === 'percentage'
                                  ? item.discount.value + '%'
                                  : 'R$ ' + item.discount.value.toFixed(2)
                              }}
                            </span>
                          }
                        </p>
                      }

                      <p class="item-final">
                        <strong>Valor: R$ {{ item.finalPrice.toFixed(2) }}</strong>
                      </p>
                    </div>
                  </label>

                  <div class="item-actions">
                    <!-- A√ß√µes para todos os itens (splits e n√£o splits) -->
                    <button
                      *ngIf="!item.isSplit"
                      class="btn-icon"
                      (click)="openSplitModal(item)"
                      title="Dividir item"
                    >
                      ‚úÇÔ∏è
                    </button>
                    <button
                      class="btn-icon"
                      (click)="openDiscountModal(item)"
                      title="Aplicar desconto"
                    >
                      üí∞
                    </button>
                    <button
                      *ngIf="item.discount"
                      class="btn-icon remove"
                      (click)="removeDiscount(item)"
                      title="Desfazer desconto"
                    >
                      ‚Ü©Ô∏è
                    </button>
                    <button class="btn-icon" (click)="openPriceModal(item)" title="Editar pre√ßo">
                      ‚úèÔ∏è
                    </button>
                    <button
                      *ngIf="item.isSplit"
                      class="btn-icon undo"
                      (click)="undoSplit(item)"
                      title="Desfazer divis√£o"
                    >
                      ‚ü≤
                    </button>
                    <span
                      *ngIf="item.parentDiscount && !item.discount"
                      class="parent-discount-badge"
                      >üí∞ Desconto herdado</span
                    >
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <app-checkout-summary
        [subtotal]="subtotal"
        [totalDiscount]="totalDiscount"
        [total]="total"
        [selectedItemsCount]="selectedItems.length"
        (continueToPayment)="goToPayment()"
      ></app-checkout-summary>
    </div>
  }

  @if (!loading && step === 'payment') {
    <div class="step-container">
      <app-payment-form
        [paymentMode]="paymentMode"
        [paymentMethod]="paymentMethod"
        [posPaymentType]="posPaymentType"
        [paymentNotes]="paymentNotes"
        [total]="total"
        [loading]="loading"
        [selectedItems]="selectedItems"
        [selectedTableName]="selectedTable ? getTableDisplayName(selectedTable) : 'Mesa'"
        (paymentMethodChange)="paymentMethod = $event"
        (posPaymentTypeChange)="posPaymentType = $event"
        (paymentNotesChange)="paymentNotes = $event"
        (processPayment)="processPayment()"
        (back)="backToItems()"
      ></app-payment-form>
    </div>
  }

  @if (showSplitModal) {
    <div class="modal-overlay" (click)="closeSplitModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úÇÔ∏è Dividir Item</h3>
          <button class="btn-close" (click)="closeSplitModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <p>
            Item: <strong>{{ splitItem?.productName }}</strong>
          </p>
          <p>Quantidade atual: {{ splitItem?.quantity }} unidade(s)</p>

          <div class="form-group">
            <label for="splitQty">Dividir em quantas partes?</label>
            <input id="splitQty" type="number" [min]="2" [max]="99" [(ngModel)]="splitQuantity" />
          </div>

          @if (splitItem && splitQuantity) {
            <p class="help-text">
              Cada parte ter√° {{ (splitItem.quantity / splitQuantity).toFixed(2) }} unidade(s).
            </p>
          }
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeSplitModal()">Cancelar</button>
          <button class="btn-primary" (click)="confirmSplit()">Confirmar Divis√£o</button>
        </div>
      </div>
    </div>
  }

  @if (showDiscountModal) {
    <div class="modal-overlay" (click)="closeDiscountModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üí∞ Aplicar Desconto</h3>
          <button class="btn-close" (click)="closeDiscountModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          @if (discountItem) {
            <p>
              Item: <strong>{{ discountItem.productName }}</strong>
            </p>
            <p>Subtotal: R$ {{ discountItem.subtotal.toFixed(2) }}</p>
          }

          <div class="form-group">
            <label>Tipo de Desconto</label>
            <div class="discount-types">
              <label class="discount-type-option">
                <input type="radio" [(ngModel)]="discountType" value="percentage" /> Percentual (%)
              </label>
              <label class="discount-type-option">
                <input type="radio" [(ngModel)]="discountType" value="fixed" /> Valor Fixo (R$)
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="discountValue">Valor do Desconto</label>
            <input
              id="discountValue"
              type="number"
              [(ngModel)]="discountValue"
              [min]="0"
              [max]="
                discountType === 'percentage' ? 100 : discountItem ? discountItem.subtotal : 99999
              "
            />
          </div>

          <div class="form-group">
            <label for="discountDesc">Motivo (opcional)</label>
            <input
              id="discountDesc"
              type="text"
              [(ngModel)]="discountDescription"
              placeholder="Ex: cortesia..."
            />
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeDiscountModal()">Cancelar</button>
          <button class="btn-primary" (click)="confirmDiscount()">Aplicar Desconto</button>
        </div>
      </div>
    </div>
  }

  @if (showPriceModal) {
    <div class="modal-overlay" (click)="closePriceModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>‚úèÔ∏è Editar Pre√ßo</h3>
          <button class="btn-close" (click)="closePriceModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          @if (priceEditItem) {
            <p>
              <strong>{{ priceEditItem.productName }}</strong>
            </p>
            <p>Pre√ßo atual: R$ {{ priceEditItem.unitPrice.toFixed(2) }}</p>
          }

          <div class="form-group">
            <label for="newPrice">Novo Pre√ßo</label>
            <input
              id="newPrice"
              type="number"
              [(ngModel)]="newPrice"
              [min]="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closePriceModal()">Cancelar</button>
          <button class="btn-primary" (click)="applyPriceEdit()">Salvar</button>
        </div>
      </div>
    </div>
  }

  @if (showHistoryModal) {
    <div class="modal-overlay" (click)="closeHistoryModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üìú Hist√≥rico de Pagamentos</h3>
          <button class="btn-close" (click)="closeHistoryModal()">‚úñ</button>
        </div>

        <div class="modal-body">
          <p>
            Mesa: <strong>{{ selectedTable?.number }}</strong>
          </p>
          <p>
            Total j√° pago: <strong>R$ {{ getTotalPaid().toFixed(2) }}</strong>
          </p>

          @if (billHistory.length === 0) {
            <div class="empty-note">Nenhum pagamento registrado ainda</div>
          }

          <ul class="history-list">
            @for (bill of billHistory; track $index) {
              <li class="history-item">
                <div class="history-header">
                  <span class="history-status" [class]="bill.status">{{ bill.status }}</span>
                  <span class="history-date">{{ bill.createdAt | date: 'short' }}</span>
                </div>
                <div class="history-details">
                  <p>{{ bill.items.length }} item(ns)</p>
                  <p class="history-amount">R$ {{ bill.finalTotal.toFixed(2) }}</p>
                  <p class="history-method">{{ bill.paymentMethod }}</p>
                </div>
              </li>
            }
          </ul>
        </div>

        <div class="modal-footer">
          <button class="btn-primary" (click)="closeHistoryModal()">Fechar</button>
        </div>
      </div>
    </div>
  }
</div>
