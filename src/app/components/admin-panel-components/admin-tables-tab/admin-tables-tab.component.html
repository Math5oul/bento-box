<div class="tables-section">
  <div class="section-header">
    <h3>Gerenciamento de Mesas</h3>
    <button class="btn-primary" (click)="showCreateModal = true">Nova Mesa</button>
  </div>

  <div class="tables-grid">
    @for (table of tables; track table.id) {
      <div class="table-card" [style.border-color]="getStatusColor(table.status)">
        <div class="table-header">
          <div class="table-number">
            <span class="table-number-main">Mesa {{ table.number }}</span>
            @if (table.name) {
              <span class="table-name">{{ table.name }}</span>
            }
          </div>
          <div class="table-status" [style.background]="getStatusColor(table.status)">
            {{ getStatusLabel(table.status) }}
          </div>
        </div>

        <div class="table-info">
          <div class="info-item">
            <span class="icon">ğŸ‘¥</span>
            <span
              >{{ getClientCount(table) }}
              {{ getClientCount(table) === 1 ? 'pessoa' : 'pessoas' }}</span
            >
          </div>
          @if (table.currentOrders && table.currentOrders.length > 0) {
            <div class="info-item">
              <span class="icon">ğŸ“‹</span>
              <span
                >{{ table.currentOrders.length }}
                {{ table.currentOrders.length === 1 ? 'pedido' : 'pedidos' }}</span
              >
            </div>
          }
          @if (table.totalConsumption && table.totalConsumption > 0) {
            <div class="info-item">
              <span class="icon">ğŸ’°</span>
              <span>R$ {{ table.totalConsumption.toFixed(2) }}</span>
            </div>
          }
        </div>

        <div class="table-actions">
          @if (table.status === 'available') {
            <button class="btn-action btn-open" (click)="openTable(table)">ğŸ”“ Abrir</button>
          }
          @if (table.status === 'occupied') {
            <button class="btn-action btn-close" (click)="closeTable(table)">ğŸ”’ Fechar</button>
          }
          @if (table.status === 'reserved') {
            <button class="btn-action btn-confirm" (click)="confirmReservation(table)">
              âœ… Confirmar
            </button>
          }
          @if (table.status === 'closed') {
            <button class="btn-action btn-clear" (click)="clearTable(table)">ğŸ§¹ Limpar</button>
          }
          <button
            class="btn-action btn-orders"
            (click)="viewTableOrders(table)"
            [disabled]="!(table.currentOrders && table.currentOrders.length > 0)"
            [class.is-disabled]="!(table.currentOrders && table.currentOrders.length > 0)"
          >
            ğŸ“‹ Pedidos
          </button>
          <button class="btn-action btn-qr" (click)="showTableQRCode(table)">ğŸ“± QR Code</button>
          <button class="btn-action btn-edit" (click)="openEditModal(table)">âœï¸ Editar</button>
          <button class="btn-action btn-delete" (click)="deleteTable(table)">ğŸ—‘ï¸</button>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <p>Nenhuma mesa cadastrada</p>
        <button class="btn-primary" (click)="showCreateModal = true">Criar primeira mesa</button>
      </div>
    }
  </div>
</div>

<!-- Modal: Criar Mesa -->
@if (showCreateModal) {
  <div class="modal-overlay" (click)="showCreateModal = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Nova Mesa</h3>
      <form (ngSubmit)="createTable()">
        <div class="form-group">
          <label>NÃºmero da Mesa:</label>
          <input type="number" [(ngModel)]="newTable.number" name="number" min="1" required />
        </div>
        <div class="form-group">
          <label>Capacidade (pessoas):</label>
          <input
            type="number"
            [(ngModel)]="newTable.capacity"
            name="capacity"
            min="1"
            max="20"
            required
          />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="showCreateModal = false">
            Cancelar
          </button>
          <button type="submit" class="btn-primary">Criar Mesa</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Modal: QR Code -->
@if (showQRCode && selectedTable) {
  <div class="modal-overlay" (click)="showQRCode = false">
    <div class="modal-content qr-modal" (click)="$event.stopPropagation()">
      <h3>QR Code - Mesa {{ selectedTable.number }}</h3>
      @if (qrCodeImage) {
        <div class="qr-container">
          <img [src]="qrCodeImage" alt="QR Code da mesa" />
        </div>
        <p class="qr-info">Clientes podem escanear este QR Code para acessar a mesa</p>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="downloadQRCode()">ğŸ’¾ Baixar</button>
          <button class="btn-primary" (click)="printQRCode()">ğŸ–¨ï¸ Imprimir</button>
        </div>
      } @else {
        <p>Gerando QR Code...</p>
      }
    </div>
  </div>
}

<!-- Modal: Pedidos da Mesa -->
@if (showOrdersModal) {
  <app-table-orders-modal
    [tableNumber]="selectedTableNumber"
    [orders]="selectedTableOrders"
    (close)="closeOrdersModal()"
  ></app-table-orders-modal>
}

<!-- Modal: Editar Mesa -->
@if (showEditModal && selectedTableForEdit) {
  <app-edit-table-modal
    [table]="selectedTableForEdit"
    (close)="closeEditModal()"
    (save)="handleSaveTable($event)"
  />
}
