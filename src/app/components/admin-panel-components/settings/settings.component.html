<app-admin-header></app-admin-header>

<div class="settings-container">
  <div class="page-header">
    <h1>âš™ï¸ Bento Tools - ConfiguraÃ§Ãµes do Sistema</h1>
    <p class="subtitle">Configure seu restaurante, pagamentos, email e banco de dados</p>
  </div>

  @if (loading) {
    <div class="loading-state">
      <p>â³ Carregando configuraÃ§Ãµes...</p>
    </div>
  }

  @if (!loading) {
    <div class="settings-content">
      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab"
          [class.active]="activeTab === 'restaurant'"
          (click)="activeTab = 'restaurant'"
        >
          ğŸª Restaurante
        </button>
        <button class="tab" [class.active]="activeTab === 'email'" (click)="activeTab = 'email'">
          ğŸ“§ Email
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'database'"
          (click)="activeTab = 'database'"
        >
          ğŸ—„ï¸ Database
        </button>
      </div>

      <!-- Tab: Restaurante -->
      @if (activeTab === 'restaurant') {
        <div class="tab-content">
          <div class="section-header">
            <h2>ğŸª InformaÃ§Ãµes do Restaurante</h2>
            <p>Dados bÃ¡sicos do seu estabelecimento</p>
          </div>

          <div class="form-grid">
            <div class="form-group full-width">
              <label for="restaurantName">Nome do Restaurante *</label>
              <input
                type="text"
                id="restaurantName"
                [(ngModel)]="config.restaurant.name"
                placeholder="Meu Restaurante"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="cnpj">CNPJ</label>
              <input
                type="text"
                id="cnpj"
                [(ngModel)]="config.restaurant.cnpj"
                (input)="onCNPJInput($event)"
                placeholder="00.000.000/0000-00"
                class="form-control"
                maxlength="18"
              />
            </div>

            <div class="form-group">
              <label for="phone">Telefone</label>
              <input
                type="text"
                id="phone"
                [(ngModel)]="config.restaurant.phone"
                (input)="onPhoneInput($event)"
                placeholder="(00) 00000-0000"
                class="form-control"
                maxlength="15"
              />
            </div>

            <div class="form-group full-width">
              <label for="email">Email de Contato</label>
              <input
                type="email"
                id="email"
                [(ngModel)]="config.restaurant.email"
                placeholder="contato@restaurante.com"
                class="form-control"
              />
            </div>

            <div class="form-group full-width">
              <label for="address">EndereÃ§o Completo</label>
              <textarea
                id="address"
                [(ngModel)]="config.restaurant.address"
                placeholder="Rua Exemplo, 123 - Bairro - Cidade/UF"
                class="form-control"
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>
      }

      <!-- Tab: Email -->
      @if (activeTab === 'email') {
        <div class="tab-content">
          <div class="section-header">
            <h2>ğŸ“§ ConfiguraÃ§Ã£o de Email (SMTP)</h2>
            <p>Configure o servidor SMTP para enviar emails de recuperaÃ§Ã£o de senha e promoÃ§Ãµes</p>
          </div>

          <!-- Habilitar Email -->
          <div class="toggle-section">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="config.email.enabled" />
              <span>Habilitar envio de emails</span>
            </label>
          </div>

          @if (config.email.enabled) {
            <!-- Quick Select Provider -->
            <div class="form-section">
              <h3>ğŸš€ Provedor SMTP (Atalho)</h3>
              <div class="provider-quick-select">
                @for (provider of emailProviders; track provider.value) {
                  <button class="provider-btn" (click)="selectEmailProvider(provider)">
                    {{ provider.label }}
                  </button>
                }
              </div>
            </div>

            <!-- ConfiguraÃ§Ãµes SMTP -->
            <div class="form-section">
              <h3>âš™ï¸ ConfiguraÃ§Ãµes do Servidor SMTP</h3>

              <div class="form-grid">
                <div class="form-group">
                  <label for="emailHost">Host SMTP *</label>
                  <input
                    type="text"
                    id="emailHost"
                    [(ngModel)]="config.email.host"
                    placeholder="smtp.gmail.com"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label for="emailPort">Porta *</label>
                  <input
                    type="number"
                    id="emailPort"
                    [(ngModel)]="config.email.port"
                    placeholder="587"
                    class="form-control"
                  />
                </div>

                <div class="form-group full-width">
                  <label for="emailUser">UsuÃ¡rio / Email *</label>
                  <input
                    type="email"
                    id="emailUser"
                    [(ngModel)]="config.email.user"
                    placeholder="seu-email@gmail.com"
                    class="form-control"
                  />
                </div>

                <div class="form-group full-width">
                  <label for="emailPassword">Senha / Senha de App *</label>
                  <input
                    type="password"
                    id="emailPassword"
                    [(ngModel)]="config.email.password"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    class="form-control"
                  />
                  <small
                    >âš ï¸ Para Gmail, use "Senha de App":
                    <a href="https://myaccount.google.com/apppasswords" target="_blank"
                      >Gerar aqui</a
                    ></small
                  >
                </div>

                <div class="form-group full-width">
                  <label for="emailFrom">Remetente (Nome e Email) *</label>
                  <input
                    type="text"
                    id="emailFrom"
                    [(ngModel)]="config.email.from"
                    placeholder="Meu Restaurante <noreply@restaurante.com>"
                    class="form-control"
                  />
                  <small>Formato: Nome &lt;email&#64;dominio.com&gt;</small>
                </div>
              </div>

              <button class="btn-secondary" (click)="testEmailConnection()">
                ğŸ“§ Enviar Email de Teste
              </button>
            </div>
          }
        </div>
      }

      <!-- Tab: Database -->
      @if (activeTab === 'database') {
        <div class="tab-content">
          <div class="section-header">
            <h2>ğŸ—„ï¸ Banco de Dados</h2>
            <p>ConfiguraÃ§Ãµes de conexÃ£o e backup</p>
          </div>

          <!-- InformaÃ§Ãµes de ConexÃ£o -->
          <div class="form-section">
            <h3>ğŸ”Œ ConexÃ£o MongoDB</h3>
            <div class="alert alert-warning">
              <p><strong>âš ï¸ AtenÃ§Ã£o:</strong></p>
              <p>A string de conexÃ£o do MongoDB Ã© configurada no arquivo <code>.env</code>.</p>
              <p>Para alterÃ¡-la, edite o arquivo <code>.env</code> e reinicie o servidor.</p>
            </div>

            <div class="db-info">
              <div class="info-item">
                <span class="label">String de ConexÃ£o:</span>
                <code class="value">{{ config.database.uri || 'NÃ£o configurado' }}</code>
              </div>
            </div>

            <button class="btn-secondary" (click)="testDatabaseConnection()">
              ğŸ”Œ Testar ConexÃ£o com Banco
            </button>
          </div>

          <!-- Backup -->
          <div class="form-section">
            <h3>ğŸ’¾ Backup AutomÃ¡tico</h3>

            <div class="toggle-section">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="config.database.backupEnabled" />
                <span>Habilitar backup automÃ¡tico diÃ¡rio</span>
              </label>
            </div>

            @if (config.database.backupEnabled) {
              <div class="form-group">
                <label for="backupRetention">RetenÃ§Ã£o de Backups (dias)</label>
                <input
                  type="number"
                  id="backupRetention"
                  [(ngModel)]="config.database.backupRetentionDays"
                  min="1"
                  max="30"
                  class="form-control"
                />
                <small>Backups mais antigos que este perÃ­odo serÃ£o deletados automaticamente</small>
              </div>
            }

            <div class="alert alert-info">
              <p><strong>â„¹ï¸ Backup AutomÃ¡tico:</strong></p>
              <ul>
                <li>Executado diariamente Ã s 03:00</li>
                <li>Armazenado em: <code>./backup/</code></li>
                <li>Formato: <code>backup-YYYY-MM-DD_HH-MM-SS.json</code></li>
              </ul>
            </div>

            <button class="btn-primary" (click)="createBackup()">
              ğŸ’¾ Criar Backup Manual Agora
            </button>
          </div>
        </div>
      }

      <!-- AÃ§Ãµes -->
      <div class="form-actions">
        <button class="btn-secondary" (click)="loadConfig()">â†º Recarregar</button>
        <button class="btn-primary" (click)="saveConfig()" [disabled]="saving">
          @if (!saving) {
            <span>ğŸ’¾ Salvar ConfiguraÃ§Ãµes</span>
          }
          @if (saving) {
            <span>â³ Salvando...</span>
          }
        </button>
      </div>

      <div class="alert alert-warning restart-warning">
        <p>
          <strong>âš ï¸ AtenÃ§Ã£o:</strong> ApÃ³s salvar as configuraÃ§Ãµes, Ã© necessÃ¡rio
          <strong>reiniciar o servidor</strong> para aplicar as mudanÃ§as.
        </p>
      </div>
    </div>
  }
</div>
