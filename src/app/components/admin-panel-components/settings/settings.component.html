<app-admin-header></app-admin-header>

<div class="settings-container">
  <div class="page-header">
    <h1>‚öôÔ∏è Bento Tools - Configura√ß√µes do Sistema</h1>
    <p class="subtitle">Configure seu restaurante, pagamentos, email e banco de dados</p>
  </div>

  @if (loading) {
    <div class="loading-state">
      <p>‚è≥ Carregando configura√ß√µes...</p>
    </div>
  }

  @if (!loading) {
    <div class="settings-content">
      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab"
          [class.active]="activeTab === 'restaurant'"
          (click)="activeTab = 'restaurant'"
        >
          üè™ Restaurante
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'payment'"
          (click)="activeTab = 'payment'"
        >
          üí≥ Pagamentos Online
        </button>
        <button class="tab" [class.active]="activeTab === 'pos'" (click)="activeTab = 'pos'">
          üñ•Ô∏è Maquininha (POS)
        </button>
        <button class="tab" [class.active]="activeTab === 'email'" (click)="activeTab = 'email'">
          üìß Email
        </button>
        <button
          class="tab"
          [class.active]="activeTab === 'database'"
          (click)="activeTab = 'database'"
        >
          üóÑÔ∏è Database
        </button>
      </div>

      <!-- Tab: Restaurante -->
      @if (activeTab === 'restaurant') {
        <div class="tab-content">
          <div class="section-header">
            <h2>üè™ Informa√ß√µes do Restaurante</h2>
            <p>Dados b√°sicos do seu estabelecimento</p>
          </div>

          <div class="form-grid">
            <div class="form-group full-width">
              <label for="restaurantName">Nome do Restaurante *</label>
              <input
                type="text"
                id="restaurantName"
                [(ngModel)]="config.restaurant.name"
                placeholder="Meu Restaurante"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="cnpj">CNPJ</label>
              <input
                type="text"
                id="cnpj"
                [(ngModel)]="config.restaurant.cnpj"
                (input)="onCNPJInput($event)"
                placeholder="00.000.000/0000-00"
                class="form-control"
                maxlength="18"
              />
            </div>

            <div class="form-group">
              <label for="phone">Telefone</label>
              <input
                type="text"
                id="phone"
                [(ngModel)]="config.restaurant.phone"
                (input)="onPhoneInput($event)"
                placeholder="(00) 00000-0000"
                class="form-control"
                maxlength="15"
              />
            </div>

            <div class="form-group full-width">
              <label for="email">Email de Contato</label>
              <input
                type="email"
                id="email"
                [(ngModel)]="config.restaurant.email"
                placeholder="contato@restaurante.com"
                class="form-control"
              />
            </div>

            <div class="form-group full-width">
              <label for="address">Endere√ßo Completo</label>
              <textarea
                id="address"
                [(ngModel)]="config.restaurant.address"
                placeholder="Rua Exemplo, 123 - Bairro - Cidade/UF"
                class="form-control"
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>
      }

      <!-- Tab: Pagamentos -->
      @if (activeTab === 'payment') {
        <div class="tab-content">
          <div class="section-header">
            <h2>üí≥ Pagamentos Online</h2>
            <p>Configure o gateway de pagamento para aceitar PIX e cart√µes</p>
          </div>

          <!-- Habilitar Pagamentos -->
          <div class="toggle-section">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="config.payment.enabled" />
              <span>Habilitar pagamentos online</span>
            </label>
          </div>

          @if (config.payment.enabled) {
            <!-- Sele√ß√£o do Gateway -->
            <div class="form-section">
              <h3>üè¶ Gateway de Pagamento</h3>
              <div class="provider-selector">
                @for (provider of paymentProviders; track provider.value) {
                  <label class="provider-option" [class.disabled]="provider.value === 'none'">
                    <input
                      type="radio"
                      [(ngModel)]="config.payment.provider"
                      [value]="provider.value"
                      [disabled]="provider.value === 'none'"
                    />
                    <div class="provider-card">
                      <span class="icon">{{ provider.icon }}</span>
                      <span class="label">{{ provider.label }}</span>
                    </div>
                  </label>
                }
              </div>
              @if (config.payment.provider !== 'none') {
                <a
                  [href]="getProviderDocs(config.payment.provider)"
                  target="_blank"
                  class="docs-link"
                >
                  üìö Ver documenta√ß√£o do {{ config.payment.provider }}
                </a>
              }
            </div>

            <!-- Credenciais -->
            @if (config.payment.provider !== 'none') {
              <div class="form-section">
                <h3>üîë Credenciais do Gateway</h3>
                <div class="alert alert-info">
                  <p><strong>‚ÑπÔ∏è Como obter as credenciais:</strong></p>
                  <ol>
                    <li>Acesse o painel do {{ config.payment.provider }}</li>
                    <li>V√° em "Suas integra√ß√µes" ‚Üí "Credenciais"</li>
                    <li>Copie a <strong>Public Key</strong> e o <strong>Access Token</strong></li>
                    <li>Cole abaixo e clique em "Testar Conex√£o"</li>
                  </ol>
                </div>

                <div class="form-group">
                  <label for="publicKey">Public Key (Chave P√∫blica) *</label>
                  <input
                    type="text"
                    id="publicKey"
                    [(ngModel)]="config.payment.publicKey"
                    placeholder="APP_USR-xxxxxxxx-xxxxxxxx"
                    class="form-control"
                  />
                  <small>Usada no frontend para tokenizar cart√µes</small>
                </div>

                <div class="form-group">
                  <label for="accessToken">Access Token (Chave Secreta) *</label>
                  <input
                    type="password"
                    id="accessToken"
                    [(ngModel)]="config.payment.accessToken"
                    placeholder="APP_USR-xxxxxxxx-xxxxxxxx-xxxxxxxx"
                    class="form-control"
                  />
                  <small>‚ö†Ô∏è Mantenha este token em segredo</small>
                </div>

                <div class="form-group">
                  <label for="webhookUrl">Webhook URL</label>
                  <input
                    type="url"
                    id="webhookUrl"
                    [(ngModel)]="config.payment.webhookUrl"
                    placeholder="http://seu-ip-publico:4200/api/payments/webhook"
                    class="form-control"
                  />
                  <small
                    >URL p√∫blica para receber notifica√ß√µes de pagamento (deixe vazio se n√£o for
                    usar)</small
                  >
                </div>

                <button class="btn-secondary" (click)="testPaymentConnection()">
                  üîå Testar Conex√£o com Gateway
                </button>
              </div>
            }

            <!-- M√©todos de Pagamento -->
            @if (config.payment.provider !== 'none') {
              <div class="form-section">
                <h3>üí∞ M√©todos Dispon√≠veis</h3>

                <label class="checkbox-option">
                  <input type="checkbox" [(ngModel)]="config.payment.pixEnabled" />
                  <div class="option-content">
                    <span class="option-icon">üì±</span>
                    <div class="option-text">
                      <strong>PIX</strong>
                      <small>Pagamento instant√¢neo via QR Code</small>
                    </div>
                    <span class="option-fee">~0.99%</span>
                  </div>
                </label>

                <label class="checkbox-option">
                  <input type="checkbox" [(ngModel)]="config.payment.creditCardEnabled" />
                  <div class="option-content">
                    <span class="option-icon">üí≥</span>
                    <div class="option-text">
                      <strong>Cart√£o de Cr√©dito</strong>
                      <small>Visa, Mastercard, Elo, etc</small>
                    </div>
                    <span class="option-fee">~4.99%</span>
                  </div>
                </label>

                <label class="checkbox-option">
                  <input type="checkbox" [(ngModel)]="config.payment.debitCardEnabled" />
                  <div class="option-content">
                    <span class="option-icon">üí≥</span>
                    <div class="option-text">
                      <strong>Cart√£o de D√©bito</strong>
                      <small>D√©bito online</small>
                    </div>
                    <span class="option-fee">~2.99%</span>
                  </div>
                </label>
              </div>
            }
          }
        </div>
      }

      <!-- Tab: POS Terminal (Maquininha) -->
      @if (activeTab === 'pos') {
        <div class="tab-content">
          <div class="section-header">
            <h2>üñ•Ô∏è Maquininha de Cart√£o (POS Terminal)</h2>
            <p>Configure sua maquininha para aceitar pagamentos com cart√£o f√≠sico e PIX local</p>
          </div>

          <!-- Habilitar POS -->
          <div class="toggle-section">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="config.posTerminal.enabled" />
              <span>Habilitar Maquininha de Cart√£o</span>
            </label>
            <p class="toggle-description">
              ‚ö†Ô∏è Quando habilitado, o checkout mostrar√° op√ß√£o de "Enviar para Maquininha"
            </p>
          </div>

          @if (config.posTerminal.enabled) {
            <!-- Sele√ß√£o do Terminal -->
            <div class="form-section">
              <h3>üè™ Tipo de Terminal</h3>
              <div class="provider-grid">
                @for (terminal of posTerminals; track terminal.value) {
                  <label
                    class="provider-card"
                    [class.active]="config.posTerminal.terminalType === terminal.value"
                  >
                    <input
                      type="radio"
                      name="terminalType"
                      [value]="terminal.value"
                      [(ngModel)]="config.posTerminal.terminalType"
                    />
                    <span class="provider-icon">{{ terminal.icon }}</span>
                    <span class="provider-name">{{ terminal.label }}</span>
                  </label>
                }
              </div>
            </div>

            @if (config.posTerminal.terminalType !== 'none') {
              <!-- Tipo de Conex√£o -->
              <div class="form-section">
                <h3>üîå Tipo de Conex√£o</h3>
                <div class="connection-types">
                  @for (conn of connectionTypes; track conn.value) {
                    <label
                      class="connection-card"
                      [class.active]="config.posTerminal.connectionType === conn.value"
                    >
                      <input
                        type="radio"
                        name="connectionType"
                        [value]="conn.value"
                        [(ngModel)]="config.posTerminal.connectionType"
                      />
                      <span class="conn-icon">{{ conn.icon }}</span>
                      <div class="conn-text">
                        <strong>{{ conn.label }}</strong>
                      </div>
                    </label>
                  }
                </div>
              </div>

              <!-- Configura√ß√µes de Rede (WiFi) -->
              @if (config.posTerminal.connectionType === 'wifi') {
                <div class="form-grid">
                  <div class="form-group">
                    <label for="posIp">Endere√ßo IP da Maquininha *</label>
                    <input
                      type="text"
                      id="posIp"
                      [(ngModel)]="config.posTerminal.ipAddress"
                      placeholder="192.168.1.100"
                      class="form-control"
                    />
                    <small>Encontre o IP no menu de configura√ß√µes da maquininha</small>
                  </div>

                  <div class="form-group">
                    <label for="posPort">Porta</label>
                    <input
                      type="number"
                      id="posPort"
                      [(ngModel)]="config.posTerminal.port"
                      placeholder="8080"
                      class="form-control"
                    />
                  </div>
                </div>
              }

              <!-- Configura√ß√µes Bluetooth -->
              @if (config.posTerminal.connectionType === 'bluetooth') {
                <div class="form-grid">
                  <div class="form-group full-width">
                    <label for="deviceId">ID do Dispositivo Bluetooth</label>
                    <input
                      type="text"
                      id="deviceId"
                      [(ngModel)]="config.posTerminal.deviceId"
                      placeholder="00:11:22:33:44:55"
                      class="form-control"
                    />
                    <small>Pareie a maquininha primeiro no menu Bluetooth do sistema</small>
                  </div>
                </div>
              }

              <!-- Configura√ß√µes USB -->
              @if (config.posTerminal.connectionType === 'usb') {
                <div class="alert alert-info">
                  <strong>‚ÑπÔ∏è Conex√£o USB</strong>
                  <p>
                    Conecte a maquininha via cabo USB. A detec√ß√£o ser√° autom√°tica ap√≥s salvar as
                    configura√ß√µes.
                  </p>
                </div>
              }

              <!-- Configura√ß√µes espec√≠ficas por terminal -->
              @if (config.posTerminal.terminalType === 'stone') {
                <div class="form-grid">
                  <div class="form-group">
                    <label for="stoneCode">Stone Code *</label>
                    <input
                      type="text"
                      id="stoneCode"
                      [(ngModel)]="config.posTerminal.stoneCode"
                      placeholder="999999999"
                      class="form-control"
                    />
                    <small>C√≥digo Stone de 9 d√≠gitos (encontrado no verso da maquininha)</small>
                  </div>
                </div>
              }

              <!-- Serial Number (todos os terminais) -->
              <div class="form-group full-width">
                <label for="serialNumber">N√∫mero de S√©rie</label>
                <input
                  type="text"
                  id="serialNumber"
                  [(ngModel)]="config.posTerminal.serialNumber"
                  placeholder="SN123456789"
                  class="form-control"
                />
                <small
                  >Opcional - √∫til para identifica√ß√£o em estabelecimentos com m√∫ltiplos
                  terminais</small
                >
              </div>

              <!-- Confirma√ß√£o Autom√°tica -->
              <div class="toggle-section">
                <label class="toggle-label">
                  <input type="checkbox" [(ngModel)]="config.posTerminal.autoConfirm" />
                  <span>Confirma√ß√£o Autom√°tica</span>
                </label>
                <p class="toggle-description">
                  Quando ativado, a comanda ser√° marcada como paga automaticamente ap√≥s aprova√ß√£o na
                  maquininha
                </p>
              </div>

              <!-- Bot√£o de Teste -->
              <div class="test-section">
                <button class="btn-test" (click)="testPOSConnection()" [disabled]="testingPOS">
                  @if (!testingPOS) {
                    <span>üîå Testar Conex√£o com Maquininha</span>
                  }
                  @if (testingPOS) {
                    <span>‚è≥ Testando...</span>
                  }
                </button>
                <p class="test-note">Certifique-se que a maquininha est√° ligada e conectada</p>
              </div>
            }
          }
        </div>
      }

      <!-- Tab: Email -->
      @if (activeTab === 'email') {
        <div class="tab-content">
          <div class="section-header">
            <h2>üìß Configura√ß√£o de Email (SMTP)</h2>
            <p>Configure o servidor SMTP para enviar emails de recupera√ß√£o de senha e promo√ß√µes</p>
          </div>

          <!-- Habilitar Email -->
          <div class="toggle-section">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="config.email.enabled" />
              <span>Habilitar envio de emails</span>
            </label>
          </div>

          @if (config.email.enabled) {
            <!-- Quick Select Provider -->
            <div class="form-section">
              <h3>üöÄ Provedor SMTP (Atalho)</h3>
              <div class="provider-quick-select">
                @for (provider of emailProviders; track provider.value) {
                  <button class="provider-btn" (click)="selectEmailProvider(provider)">
                    {{ provider.label }}
                  </button>
                }
              </div>
            </div>

            <!-- Configura√ß√µes SMTP -->
            <div class="form-section">
              <h3>‚öôÔ∏è Configura√ß√µes do Servidor SMTP</h3>

              <div class="form-grid">
                <div class="form-group">
                  <label for="emailHost">Host SMTP *</label>
                  <input
                    type="text"
                    id="emailHost"
                    [(ngModel)]="config.email.host"
                    placeholder="smtp.gmail.com"
                    class="form-control"
                  />
                </div>

                <div class="form-group">
                  <label for="emailPort">Porta *</label>
                  <input
                    type="number"
                    id="emailPort"
                    [(ngModel)]="config.email.port"
                    placeholder="587"
                    class="form-control"
                  />
                </div>

                <div class="form-group full-width">
                  <label for="emailUser">Usu√°rio / Email *</label>
                  <input
                    type="email"
                    id="emailUser"
                    [(ngModel)]="config.email.user"
                    placeholder="seu-email@gmail.com"
                    class="form-control"
                  />
                </div>

                <div class="form-group full-width">
                  <label for="emailPassword">Senha / Senha de App *</label>
                  <input
                    type="password"
                    id="emailPassword"
                    [(ngModel)]="config.email.password"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    class="form-control"
                  />
                  <small
                    >‚ö†Ô∏è Para Gmail, use "Senha de App":
                    <a href="https://myaccount.google.com/apppasswords" target="_blank"
                      >Gerar aqui</a
                    ></small
                  >
                </div>

                <div class="form-group full-width">
                  <label for="emailFrom">Remetente (Nome e Email) *</label>
                  <input
                    type="text"
                    id="emailFrom"
                    [(ngModel)]="config.email.from"
                    placeholder="Meu Restaurante <noreply@restaurante.com>"
                    class="form-control"
                  />
                  <small>Formato: Nome &lt;email&#64;dominio.com&gt;</small>
                </div>
              </div>

              <button class="btn-secondary" (click)="testEmailConnection()">
                üìß Enviar Email de Teste
              </button>
            </div>
          }
        </div>
      }

      <!-- Tab: Database -->
      @if (activeTab === 'database') {
        <div class="tab-content">
          <div class="section-header">
            <h2>üóÑÔ∏è Banco de Dados</h2>
            <p>Configura√ß√µes de conex√£o e backup</p>
          </div>

          <!-- Informa√ß√µes de Conex√£o -->
          <div class="form-section">
            <h3>üîå Conex√£o MongoDB</h3>
            <div class="alert alert-warning">
              <p><strong>‚ö†Ô∏è Aten√ß√£o:</strong></p>
              <p>A string de conex√£o do MongoDB √© configurada no arquivo <code>.env</code>.</p>
              <p>Para alter√°-la, edite o arquivo <code>.env</code> e reinicie o servidor.</p>
            </div>

            <div class="db-info">
              <div class="info-item">
                <span class="label">String de Conex√£o:</span>
                <code class="value">{{ config.database.uri || 'N√£o configurado' }}</code>
              </div>
            </div>

            <button class="btn-secondary" (click)="testDatabaseConnection()">
              üîå Testar Conex√£o com Banco
            </button>
          </div>

          <!-- Backup -->
          <div class="form-section">
            <h3>üíæ Backup Autom√°tico</h3>

            <div class="toggle-section">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="config.database.backupEnabled" />
                <span>Habilitar backup autom√°tico di√°rio</span>
              </label>
            </div>

            @if (config.database.backupEnabled) {
              <div class="form-group">
                <label for="backupRetention">Reten√ß√£o de Backups (dias)</label>
                <input
                  type="number"
                  id="backupRetention"
                  [(ngModel)]="config.database.backupRetentionDays"
                  min="1"
                  max="30"
                  class="form-control"
                />
                <small>Backups mais antigos que este per√≠odo ser√£o deletados automaticamente</small>
              </div>
            }

            <div class="alert alert-info">
              <p><strong>‚ÑπÔ∏è Backup Autom√°tico:</strong></p>
              <ul>
                <li>Executado diariamente √†s 03:00</li>
                <li>Armazenado em: <code>./backup/</code></li>
                <li>Formato: <code>backup-YYYY-MM-DD_HH-MM-SS.json</code></li>
              </ul>
            </div>

            <button class="btn-primary" (click)="createBackup()">
              üíæ Criar Backup Manual Agora
            </button>
          </div>
        </div>
      }

      <!-- A√ß√µes -->
      <div class="form-actions">
        <button class="btn-secondary" (click)="loadConfig()">‚Ü∫ Recarregar</button>
        <button class="btn-primary" (click)="saveConfig()" [disabled]="saving">
          @if (!saving) {
            <span>üíæ Salvar Configura√ß√µes</span>
          }
          @if (saving) {
            <span>‚è≥ Salvando...</span>
          }
        </button>
      </div>

      <div class="alert alert-warning restart-warning">
        <p>
          <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Ap√≥s salvar as configura√ß√µes, √© necess√°rio
          <strong>reiniciar o servidor</strong> para aplicar as mudan√ßas.
        </p>
      </div>
    </div>
  }
</div>
