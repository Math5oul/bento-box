<div class="modal-overlay" (click)="closeModal()">
  <form [formGroup]="componentForm" class="modal-content" (click)="$event.stopPropagation()">
    <button type="button" class="close-button" (click)="closeModal()">√ó</button>

    <!-- √Årea scroll√°vel -->
    <div class="modal-scroll-area">
      <!-- Lista de componentes dispon√≠veis (apenas no modo de cria√ß√£o) -->
      @if (!showDimensionsForm && !editMode) {
        <div>
          <h3>Selecione um tipo de item</h3>

          <!-- Produto (apenas se modo grid ou product) -->
          @if (mode === 'grid' || mode === 'product') {
            <div class="component-section">
              <h4 class="section-label">üõçÔ∏è Produto do Card√°pio</h4>
              <div class="component-options">
                @for (comp of filteredComponents; track $index) {
                  @if (!comp.name.includes('Filler')) {
                    <button
                      type="button"
                      (click)="selectComponent(comp)"
                      class="component-option component-option-product"
                    >
                      <span class="component-icon">üç±</span>
                      <span class="component-name">{{ comp.name }}</span>
                    </button>
                  }
                }
              </div>
            </div>
          }

          <!-- Separador (apenas no modo grid) -->
          @if (mode === 'grid') {
            <div class="divider">
              <span>ou preencha espa√ßos vazios com</span>
            </div>
          }

          <!-- Fillers (apenas se modo grid ou filler) -->
          @if (mode === 'grid' || mode === 'filler') {
            <div class="component-section">
              <h4 class="section-label">üì¶ Elementos de Preenchimento (Fillers)</h4>
              <p class="section-description">
                Elementos decorativos para preencher espa√ßos no grid
              </p>
              <div class="component-options component-options-grid">
                @for (comp of filteredComponents; track $index) {
                  @if (comp.name.includes('Filler')) {
                    <button
                      type="button"
                      (click)="selectComponent(comp)"
                      class="component-option component-option-filler"
                    >
                      <span class="component-icon">
                        @if (comp.name.includes('Texto')) {
                          üìù
                        } @else if (comp.name.includes('Imagem')) {
                          üñºÔ∏è
                        } @else if (comp.name.includes('V√≠deo')) {
                          üé•
                        }
                      </span>
                      <span class="component-name">{{ comp.name.replace(' (Filler)', '') }}</span>
                    </button>
                  }
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Formul√°rio de dimens√µes e inputs do componente selecionado -->
      @if (showDimensionsForm) {
        <div [formGroup]="componentForm">
          <h3>{{ editMode ? 'Editar' : 'Configurar' }} {{ selectedComponent.name }}</h3>

          <!-- Campos din√¢micos de inputs -->
          <div class="inputs-form" formGroupName="inputs">
            @for (input of selectedComponent.inputsConfig; track $index) {
              <div>
                <!-- Text, Number, Color (exceto se for campo de imagem e componente suportar upload) -->
                @if (
                  (input.type === 'text' || input.type === 'number' || input.type === 'color') &&
                  !(supportsImageUpload() && (input.name === 'url' || input.name === 'images'))
                ) {
                  <div>
                    <label>
                      {{ input.label }}:
                      @if (input.type === 'color') {
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px">
                          <input
                            type="color"
                            [formControlName]="input.name"
                            [required]="input.required || false"
                            [id]="'color-' + input.name"
                            style="
                              width: 60px;
                              height: 40px;
                              cursor: pointer;
                              border: 2px solid #ddd;
                              border-radius: 6px;
                            "
                          />
                          <input
                            type="text"
                            [value]="
                              componentForm.get(['inputs', input.name])?.value?.toUpperCase() ||
                              '#FFFFFF'
                            "
                            readonly
                            style="
                              flex: 1;
                              padding: 10px;
                              border: 2px solid #e0e0e0;
                              border-radius: 6px;
                              font-family: monospace;
                              font-weight: bold;
                              background: #f5f5f5;
                            "
                          />
                          <div
                            [style.background]="
                              componentForm.get(['inputs', input.name])?.value || '#ffffff'
                            "
                            style="
                              width: 40px;
                              height: 40px;
                              border: 2px solid #ddd;
                              border-radius: 6px;
                            "
                          ></div>
                        </div>
                      } @else {
                        <input
                          [type]="input.type"
                          [formControlName]="input.name"
                          [step]="input.step || '1'"
                          [required]="input.required || false"
                          [placeholder]="input.placeholder || ''"
                        />
                      }
                    </label>
                  </div>
                }

                <!-- Rich Text Editor with toolbar -->
                @if (input.type === 'richtext') {
                  <div>
                    <label>
                      {{ input.label }}:

                      <!-- Toolbar - prevent mousedown to keep editor focus -->
                      <div
                        class="richtext-toolbar"
                        [attr.data-control]="input.name"
                        (mousedown)="$event.preventDefault()"
                      >
                        <button
                          type="button"
                          class="rt-btn rt-bold"
                          (click)="execRichCommand('bold')"
                          title="Bold"
                        >
                          <strong>B</strong>
                        </button>
                        <button
                          type="button"
                          class="rt-btn rt-italic"
                          (click)="execRichCommand('italic')"
                          title="Italic"
                        >
                          <em>I</em>
                        </button>
                        <button
                          type="button"
                          class="rt-btn rt-underline"
                          (click)="execRichCommand('underline')"
                          title="Underline"
                        >
                          <u>U</u>
                        </button>
                        <button
                          type="button"
                          class="rt-btn"
                          (click)="execRichCommand('insertUnorderedList')"
                          title="Bulleted list"
                        >
                          ‚Ä¢ List
                        </button>
                        <button
                          type="button"
                          class="rt-btn"
                          (click)="execRichCommand('insertOrderedList')"
                          title="Numbered list"
                        >
                          1. List
                        </button>
                        <button
                          type="button"
                          class="rt-btn"
                          (click)="promptLink()"
                          title="Insert link"
                        >
                          üîó
                        </button>

                        <!-- Text color with hex input -->
                        <div class="rt-color-group">
                          <label class="rt-color-label" title="Selecione a cor">
                            <span class="color-icon" [style.color]="textColor">A</span>
                            <input
                              type="color"
                              class="rt-color-picker"
                              [(ngModel)]="textColor"
                              [ngModelOptions]="{ standalone: true }"
                            />
                          </label>
                          <input
                            type="text"
                            class="rt-hex-input"
                            placeholder="#000000"
                            [(ngModel)]="textColor"
                            [ngModelOptions]="{ standalone: true }"
                            maxlength="7"
                          />
                          <button
                            type="button"
                            class="rt-btn rt-apply-color"
                            (mousedown)="$event.preventDefault()"
                            (click)="applyTextColor()"
                            title="Aplicar cor ao texto selecionado"
                          >
                            ‚úì
                          </button>
                        </div>

                        <button
                          type="button"
                          class="rt-btn rt-clear"
                          (click)="clearRichText(input.name)"
                          title="Clear formatting"
                        >
                          Clear
                        </button>
                      </div>

                      <!-- Editor -->
                      <div
                        class="richtext-editor"
                        contenteditable="true"
                        [attr.data-control]="input.name"
                        (input)="onRichTextInput($event, input.name)"
                        (focus)="saveSelection()"
                        (mouseup)="saveSelection()"
                        (keyup)="saveSelection()"
                        #richtextEditor
                      ></div>
                    </label>
                  </div>
                }

                <!-- Select -->
                @if (input.type === 'select') {
                  <div>
                    <label>
                      {{ input.label }}:
                      <select [formControlName]="input.name" [required]="input.required || false">
                        @for (option of input.options; track $index) {
                          <option [value]="option">
                            @if (input.name === 'category') {
                              {{ getCategoryDisplayName(option) }}
                            } @else if (input.name === 'format') {
                              {{ getFormatDisplayName(option) }}
                            } @else {
                              {{ option }}
                            }
                          </option>
                        }
                      </select>
                    </label>
                  </div>
                }

                <!-- Multi-Select -->
                @if (input.type === 'multi-select') {
                  <div>
                    <label>{{ input.label }}:</label>
                    <div class="multi-select-container">
                      @for (option of input.options; track $index) {
                        <label class="multi-select-option">
                          <input
                            type="checkbox"
                            [checked]="isCategorySelected(input.name, option)"
                            (change)="toggleCategorySelection(input.name, option)"
                          />
                          <span class="multi-select-label">{{
                            getCategoryDisplayName(option)
                          }}</span>
                        </label>
                      }
                    </div>
                    @if (componentForm.get(['inputs', input.name])?.value?.length === 0) {
                      <p class="multi-select-hint">
                        ‚ö†Ô∏è Selecione pelo menos uma categoria para que o item apare√ßa no menu
                      </p>
                    } @else {
                      <p class="multi-select-hint">
                        ‚úÖ Este item aparecer√° em
                        {{ componentForm.get(['inputs', input.name])?.value?.length }} categoria(s)
                      </p>
                    }
                  </div>
                }

                <!-- Checkbox -->
                @if (input.type === 'checkbox') {
                  <div>
                    <label class="checkbox">
                      <input type="checkbox" [formControlName]="input.name" />
                      {{ input.label }}
                    </label>
                  </div>
                }

                <!-- Multiple-text (esconder se for campo de imagens e componente suportar upload) -->
                @if (
                  input.type === 'multiple-text' &&
                  !(supportsImageUpload() && input.name === 'images')
                ) {
                  <div>
                    <label>{{ input.label }}:</label>
                    <div formArrayName="{{ input.name }}">
                      @for (ctrl of getMultipleInputControl(input.name).controls; track $index) {
                        <div>
                          <input
                            type="text"
                            [formControlName]="$index"
                            [placeholder]="input.placeholder || ''"
                          />
                          <button
                            type="button"
                            (click)="removeMultipleInputItem(input.name, $index)"
                          >
                            Remover
                          </button>
                        </div>
                      }
                      <button type="button" (click)="addMultipleInputItem(input.name)">
                        Adicionar Item
                      </button>
                    </div>
                  </div>
                }

                <!-- Product Sizes -->
                @if (input.type === 'product-sizes') {
                  <div class="product-sizes-section">
                    <label class="sizes-label">{{ input.label }}:</label>
                    <p class="sizes-description">
                      üí° Defina os tamanhos dispon√≠veis para este produto. Se nenhum tamanho for
                      adicionado, o "Pre√ßo Base" ser√° usado como pre√ßo √∫nico do produto.
                    </p>

                    <!-- Lista de tamanhos existentes -->
                    @if (getProductSizes().length > 0) {
                      <div class="sizes-list">
                        @for (size of getProductSizes(); track $index) {
                          <div class="size-item">
                            <div class="size-info">
                              <span class="size-abbr">{{ size.abbreviation }}</span>
                              <span class="size-name">{{ size.name }}</span>
                              <span class="size-price">{{ size.price | currency: 'BRL' }}</span>
                            </div>
                            <div class="size-actions">
                              <button
                                type="button"
                                class="btn-edit-size"
                                (click)="startEditSize($index)"
                                title="Editar tamanho"
                              >
                                ‚úèÔ∏è
                              </button>
                              <button
                                type="button"
                                class="btn-remove-size"
                                (click)="removeProductSize($index)"
                                title="Remover tamanho"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    }

                    <!-- Formul√°rio para adicionar/editar tamanho -->
                    <div class="size-form">
                      <h4 class="size-form-title">
                        {{
                          editingSizeIndex !== null ? '‚úèÔ∏è Editar Tamanho' : '‚ûï Adicionar Tamanho'
                        }}
                      </h4>
                      <div class="size-form-inputs">
                        <div class="size-input-group">
                          <label for="size-name">Nome</label>
                          <input
                            class="size-name-input"
                            type="text"
                            id="size-name"
                            [(ngModel)]="tempSize.name"
                            [ngModelOptions]="{ standalone: true }"
                            placeholder="Ex: Pequeno, M√©dio, Grande"
                          />
                        </div>
                        <div class="size-input-group" id="size-abbr-group">
                          <label for="size-abbr">Sigla</label>
                          <input
                            class="size-abbr-input"
                            type="text"
                            id="size-abbr"
                            [(ngModel)]="tempSize.abbreviation"
                            [ngModelOptions]="{ standalone: true }"
                            placeholder="P"
                            maxlength="3"
                          />
                        </div>
                        <div class="size-input-group">
                          <label for="size-price">Pre√ßo</label>
                          <input
                            class="size-price-input"
                            type="number"
                            id="size-price"
                            [(ngModel)]="tempSize.price"
                            [ngModelOptions]="{ standalone: true }"
                            placeholder="0.00"
                            step="0.01"
                            min="0"
                          />
                        </div>
                      </div>
                      <div class="size-form-actions">
                        @if (editingSizeIndex !== null) {
                          <button type="button" class="btn-cancel-size" (click)="cancelEditSize()">
                            Cancelar
                          </button>
                          <button type="button" class="btn-save-size" (click)="saveEditSize()">
                            Salvar Altera√ß√µes
                          </button>
                        } @else {
                          <button type="button" class="btn-add-size" (click)="addProductSize()">
                            Adicionar Tamanho
                          </button>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Upload de Imagens (se o componente suportar) -->
          @if (supportsImageUpload()) {
            <div class="image-upload-section">
              <h4>üì∏ Upload de Imagens</h4>

              <div class="upload-area">
                <input
                  type="file"
                  id="imageUpload"
                  [multiple]="hasInput('images') || selectedComponent?.name === 'Produto'"
                  accept="image/*"
                  (change)="onFilesSelected($event)"
                  [disabled]="isUploading"
                />
                <label for="imageUpload" class="upload-label">
                  @if (selectedFiles.length > 0) {
                    <span>‚úÖ {{ selectedFiles.length }} arquivo(s) selecionado(s)</span>
                  } @else {
                    @if (hasInput('url')) {
                      <span>Clique para selecionar uma imagem</span>
                    } @else {
                      <span>Clique para selecionar imagens (pode selecionar v√°rias)</span>
                    }
                  }
                </label>

                @if (selectedFiles.length > 0 && uploadedImagePaths.length === 0) {
                  <p class="upload-info">
                    üí° As imagens ser√£o enviadas automaticamente ao criar o item
                  </p>
                  <button
                    type="button"
                    class="upload-button"
                    (click)="uploadImages(generateTempProductId())"
                    [disabled]="isUploading"
                  >
                    @if (isUploading) {
                      <span>‚è≥ Enviando...</span>
                    } @else {
                      <span>‚¨ÜÔ∏è Ou clique aqui para enviar agora</span>
                    }
                  </button>
                }
              </div>

              <!-- Preview das imagens enviadas -->
              @if (uploadedImagePaths.length > 0) {
                <div class="uploaded-images">
                  <h5>Imagens Enviadas:</h5>
                  <div class="image-preview-grid">
                    @for (imagePath of uploadedImagePaths; track $index) {
                      <div class="image-preview-item">
                        <img [src]="imagePath" [alt]="'Imagem ' + ($index + 1)" />
                        <button
                          type="button"
                          class="remove-image-btn"
                          (click)="removeUploadedImage($index)"
                          title="Remover imagem"
                        >
                          √ó
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Bot√µes de a√ß√£o (fora da √°rea scroll√°vel) -->
    @if (showDimensionsForm) {
      <div class="actions">
        <button type="button" class="create-button" (click)="createItem()">
          {{ editMode ? 'Salvar Altera√ß√µes' : 'Criar Item' }}
        </button>
        <button type="button" class="cancel-button" (click)="closeModal()">Cancelar</button>
        @if (!editMode) {
          <button type="button" class="back-button" (click)="showDimensionsForm = false">
            Voltar
          </button>
        }
      </div>
    }
  </form>

  <!-- Image Cropper Modal -->
  @if (showCropper && currentImageFile) {
    <app-image-cropper
      [imageFile]="currentImageFile"
      [currentIndex]="croppedBlobs.length + 1"
      [totalImages]="pendingFiles.length + croppedBlobs.length"
      (cropped)="onImageCropped($event)"
      (cancelled)="onCropCancelled()"
    />
  }
</div>
