@if (isOpen) {
  <div class="modal-back">
    <div class="modal-overlay" (mousedown)="close()">
      <div class="modal-content" (mousedown)="$event.stopPropagation()">
        <button class="close-button" (click)="close()">&times;</button>

        <!-- Área scrollável -->
        <div class="modal-scroll-area">
          <app-carrossel [images]="images" [(currentIndex)]="currentImageIndex"></app-carrossel>

          <div class="product-info">
            <div class="product-text">
              <h2 class="product-name">{{ productName }}</h2>

              <!-- Exibição de preço com desconto -->
              <div class="price-container">
                @if (hasDiscount()) {
                  <div class="price-breakdown-modal">
                    <!-- Preço Base com Desconto -->
                    <div class="base-price-section">
                      <span class="label">Preço Base:</span>
                      <span class="original-price">{{ getBasePrice() | currency: 'BRL' }}</span>
                      <span class="discount-badge"
                        >-{{ getDiscountCalculation().discountPercent }}%</span
                      >
                      <span class="discounted-price">{{
                        getDiscountCalculation().finalPrice | currency: 'BRL'
                      }}</span>
                    </div>

                    <!-- Preço da Variação (se houver) -->
                    @if (getVariationPrice() > 0) {
                      <div class="variation-price-section">
                        <span class="label">Variação:</span>
                        <span class="variation-add"
                          >+{{ getVariationPrice() | currency: 'BRL' }}</span
                        >
                      </div>
                    }

                    <!-- Preço Total -->
                    <div class="total-price-section">
                      <span class="label">Total:</span>
                      <p class="product-price discounted">
                        {{ getCurrentPrice() | currency: 'BRL' }}
                      </p>
                    </div>
                  </div>
                } @else {
                  <p class="product-price">{{ getCurrentPrice() | currency: 'BRL' }}</p>
                }
              </div>

              <p
                class="product-description"
                [innerHTML]="description | sanitize: 'trustedHtml'"
              ></p>

              <!-- Seleção de Variações (apenas se houver variações) -->
              @if (shouldShowVariantsSelection()) {
                <div class="variants-selection">
                  <label class="variants-label">Variações:</label>
                  <div class="variants-buttons">
                    @for (variant of variations; track variant.title) {
                      <button
                        type="button"
                        class="variant-btn"
                        [class.selected]="selectedVariation?.title === variant.title"
                        (click)="selectVariation(variant)"
                      >
                        <div class="variant-content">
                          @if (variant.image) {
                            <img
                              [src]="variant.image"
                              [alt]="variant.title"
                              class="variant-image"
                            />
                          }
                          <div class="variant-info">
                            <span class="variant-title">{{ variant.title }}</span>
                            @if (variant.description) {
                              <span class="variant-description">{{ variant.description }}</span>
                            }
                            <span class="variant-price"
                              >+ {{ variant.price | currency: 'BRL' }}</span
                            >
                          </div>
                        </div>
                      </button>
                    }
                  </div>
                </div>
              }

              <!-- Seleção de Tamanhos (apenas se houver mais de 1 tamanho) -->
              @if (shouldShowSizeSelection()) {
                <div class="sizes-selection">
                  <label class="sizes-label">Tamanho:</label>
                  <div class="sizes-buttons">
                    @for (size of sizes; track size.abbreviation) {
                      <button
                        type="button"
                        class="size-btn"
                        [class.selected]="selectedSize?.abbreviation === size.abbreviation"
                        (click)="selectSize(size)"
                      >
                        <span class="size-abbr">{{ size.abbreviation }}</span>
                        <span class="size-name">{{ size.name }}</span>
                        @if (getSizeDiscountCalculation(size.price).hasDiscount) {
                          <div class="size-price-with-discount">
                            <span class="size-original-price">{{
                              size.price | currency: 'BRL'
                            }}</span>
                            <span class="size-discount-badge"
                              >-{{ getSizeDiscountCalculation(size.price).discountPercent }}%</span
                            >
                            <span class="size-price discounted">{{
                              getSizeDiscountCalculation(size.price).finalPrice | currency: 'BRL'
                            }}</span>
                          </div>
                        } @else {
                          <span class="size-price">{{ size.price | currency: 'BRL' }}</span>
                        }
                      </button>
                    }
                  </div>
                </div>
              }

              <div class="quantity-adjuster">
                <button
                  class="quantity-button decrease"
                  (click)="decrementQuantity()"
                  title="Diminuir quantidade"
                >
                  <span>-</span>
                </button>

                <span class="quantity">{{ quantity }}</span>

                <button
                  class="quantity-button increase"
                  (click)="incrementQuantity()"
                  title="Aumentar quantidade"
                >
                  <span>+</span>
                </button>
              </div>
            </div>

            <!-- Observações movidas para ficar mais próxima do botão -->
            <div class="observations">
              <label class="observations-label">Observações:</label>
              <textarea
                [(ngModel)]="observations"
                placeholder="Ex: Sem cebola, bem passado, molho à parte..."
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Botão fixo (fora da área scrollável) -->
        <div class="modal-actions">
          <button class="submit-button" (click)="submitOrder()">
            Adicionar ao Carrinho - {{ getCurrentPrice() * quantity | currency: 'BRL' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}
