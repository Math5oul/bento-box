<div class="modal-overlay" (click)="closeModal()">
  <form [formGroup]="componentForm" class="modal-content" (click)="$event.stopPropagation()">
    <button type="button" class="close-button" (click)="closeModal()">√ó</button>

    <!-- Lista de componentes dispon√≠veis (apenas no modo de cria√ß√£o) -->
    @if (!showDimensionsForm && !editMode) {
      <div>
        <h3>Selecione um componente</h3>
        <div class="component-options">
          @for (comp of availableComponents; track $index) {
            <button type="button" (click)="selectComponent(comp)" class="component-option">
              {{ comp.name }}
            </button>
          }
        </div>
      </div>
    }

    <!-- Formul√°rio de dimens√µes e inputs do componente selecionado -->
    @if (showDimensionsForm) {
      <div [formGroup]="componentForm">
        <h3>{{ editMode ? 'Editar' : 'Configurar' }} {{ selectedComponent.name }}</h3>

        <!-- Dimens√µes em c√©lulas -->
        <div class="dimensions-form">
          <label>
            Altura (em c√©lulas):
            <input type="number" formControlName="rowSpan" min="1" max="10" />
          </label>

          <label>
            Largura (em c√©lulas):
            <input type="number" formControlName="colSpan" min="1" max="10" />
          </label>
        </div>

        <!-- Campos din√¢micos de inputs -->
        <div class="inputs-form" formGroupName="inputs">
          @for (input of selectedComponent.inputsConfig; track $index) {
            <div>
              <!-- Text, Number, Color (exceto se for campo de imagem e componente suportar upload) -->
              @if (
                (input.type === 'text' || input.type === 'number' || input.type === 'color') &&
                !(supportsImageUpload() && (input.name === 'url' || input.name === 'images'))
              ) {
                <div>
                  <label>
                    {{ input.label }}:
                    <input
                      [type]="input.type"
                      [formControlName]="input.name"
                      [step]="input.step || '1'"
                      [required]="input.required || false"
                      [placeholder]="input.placeholder || ''"
                    />
                  </label>
                </div>
              }

              <!-- Textarea -->
              @if (input.type === 'textarea') {
                <div>
                  <label>
                    {{ input.label }}:
                    <textarea
                      [formControlName]="input.name"
                      [required]="input.required || false"
                    ></textarea>
                  </label>
                </div>
              }

              <!-- Select -->
              @if (input.type === 'select') {
                <div>
                  <label>
                    {{ input.label }}:
                    <select [formControlName]="input.name">
                      @for (option of input.options; track $index) {
                        <option [value]="option">
                          {{ option }}
                        </option>
                      }
                    </select>
                  </label>
                </div>
              }

              <!-- Checkbox -->
              @if (input.type === 'checkbox') {
                <div>
                  <label class="checkbox">
                    <input type="checkbox" [formControlName]="input.name" />
                    {{ input.label }}
                  </label>
                </div>
              }

              <!-- Multiple-text (esconder se for campo de imagens e componente suportar upload) -->
              @if (
                input.type === 'multiple-text' &&
                !(supportsImageUpload() && input.name === 'images')
              ) {
                <div>
                  <label>{{ input.label }}:</label>
                  <div formArrayName="{{ input.name }}">
                    @for (ctrl of getMultipleInputControl(input.name).controls; track $index) {
                      <div>
                        <input
                          type="text"
                          [formControlName]="$index"
                          [placeholder]="input.placeholder || ''"
                        />
                        <button type="button" (click)="removeMultipleInputItem(input.name, $index)">
                          Remover
                        </button>
                      </div>
                    }
                    <button type="button" (click)="addMultipleInputItem(input.name)">
                      Adicionar Item
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Upload de Imagens (se o componente suportar) -->
        @if (supportsImageUpload()) {
          <div class="image-upload-section">
            <h4>üì∏ Upload de Imagens</h4>

            <div class="upload-area">
              <input
                type="file"
                id="imageUpload"
                [multiple]="hasInput('images') || selectedComponent?.name === 'Produto'"
                accept="image/*"
                (change)="onFilesSelected($event)"
                [disabled]="isUploading"
              />
              <label for="imageUpload" class="upload-label">
                @if (selectedFiles.length > 0) {
                  <span>‚úÖ {{ selectedFiles.length }} arquivo(s) selecionado(s)</span>
                } @else {
                  @if (hasInput('url')) {
                    <span>Clique para selecionar uma imagem</span>
                  } @else {
                    <span>Clique para selecionar imagens (pode selecionar v√°rias)</span>
                  }
                }
              </label>

              @if (selectedFiles.length > 0 && uploadedImagePaths.length === 0) {
                <p class="upload-info">
                  üí° As imagens ser√£o enviadas automaticamente ao criar o item
                </p>
                <button
                  type="button"
                  class="upload-button"
                  (click)="uploadImages(generateTempProductId())"
                  [disabled]="isUploading"
                >
                  @if (isUploading) {
                    <span>‚è≥ Enviando...</span>
                  } @else {
                    <span>‚¨ÜÔ∏è Ou clique aqui para enviar agora</span>
                  }
                </button>
              }
            </div>

            <!-- Preview das imagens enviadas -->
            @if (uploadedImagePaths.length > 0) {
              <div class="uploaded-images">
                <h5>Imagens Enviadas:</h5>
                <div class="image-preview-grid">
                  @for (imagePath of uploadedImagePaths; track $index) {
                    <div class="image-preview-item">
                      <img [src]="imagePath" [alt]="'Imagem ' + ($index + 1)" />
                      <button
                        type="button"
                        class="remove-image-btn"
                        (click)="removeUploadedImage($index)"
                        title="Remover imagem"
                      >
                        √ó
                      </button>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        <!-- Bot√µes de a√ß√£o -->
        <div class="actions">
          <button type="button" class="create-button" (click)="createItem()">
            {{ editMode ? 'Salvar Altera√ß√µes' : 'Criar Item' }}
          </button>
          <button type="button" class="cancel-button" (click)="closeModal()">Cancelar</button>
          @if (!editMode) {
            <button type="button" class="back-button" (click)="showDimensionsForm = false">
              Voltar
            </button>
          }
        </div>
      </div>
    }
  </form>
</div>
